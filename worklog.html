<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì² ê°•ì˜ì—… ì—…ë¬´ì¼ì§€</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .company-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .company-table th,
        .company-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            vertical-align: middle;
        }
        
        .company-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .company-table tbody tr:hover {
            background-color: #f5f5f5;
        }
        
        .company-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .company-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        
        .company-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .company-row:hover {
            background-color: #e9ecef !important;
        }
        
        .company-row.color-red {
            background-color: rgba(231, 76, 60, 0.25) !important;
        }
        
        .company-row.color-orange {
            background-color: rgba(243, 156, 18, 0.25) !important;
        }
        
        .company-row.color-yellow {
            background-color: rgba(241, 196, 15, 0.25) !important;
        }
        
        .company-row.color-green {
            background-color: rgba(39, 174, 96, 0.25) !important;
        }
        
        .company-row.color-blue {
            background-color: rgba(52, 152, 219, 0.25) !important;
        }
        
        .company-row.color-purple {
            background-color: rgba(155, 89, 182, 0.25) !important;
        }
        
        .company-row.color-gray {
            background-color: rgba(149, 165, 166, 0.5) !important;
        }
        
        .company-row.color-red:hover {
            background-color: rgba(231, 76, 60, 0.4) !important;
        }
        
        .company-row.color-orange:hover {
            background-color: rgba(243, 156, 18, 0.4) !important;
        }
        
        .company-row.color-yellow:hover {
            background-color: rgba(241, 196, 15, 0.4) !important;
        }
        
        .company-row.color-green:hover {
            background-color: rgba(39, 174, 96, 0.4) !important;
        }
        
        .company-row.color-blue:hover {
            background-color: rgba(52, 152, 219, 0.4) !important;
        }
        
        .company-row.color-purple:hover {
            background-color: rgba(155, 89, 182, 0.4) !important;
        }
        
        .company-row.color-gray:hover {
            background-color: rgba(149, 165, 166, 0.7) !important;
        }
        
        .company-count {
            font-size: 0.8em;
            color: #666;
            font-weight: normal;
        }
        
        .color-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #ddd;
        }
        
        .color-red .color-indicator { background-color: #e74c3c; }
        .color-orange .color-indicator { background-color: #f39c12; }
        .color-yellow .color-indicator { background-color: #f1c40f; }
        .color-green .color-indicator { background-color: #27ae60; }
        .color-blue .color-indicator { background-color: #3498db; }
        .color-purple .color-indicator { background-color: #9b59b6; }
        .color-gray .color-indicator { background-color: #95a5a6; }
        
        .company-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .visit-count {
            text-align: center;
            font-weight: bold;
        }
        
        .last-visit {
            text-align: center;
            font-weight: bold;
        }
        
        .company-name {
            font-weight: bold;
            color: #2c3e50;
            cursor: pointer;
        }
        
        .company-name:hover {
            color: #3498db;
        }
        
        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .sortable:hover {
            background-color: #e9ecef !important;
        }
        
        .sort-arrow {
            font-size: 0.8em;
            color: #999;
            margin-left: 5px;
        }
        
        .sortable.asc .sort-arrow {
            color: #007bff;
        }
        
        .sortable.desc .sort-arrow {
            color: #007bff;
        }
        
        .sortable.asc .sort-arrow::after {
            content: ' â†‘';
        }
        
        .sortable.desc .sort-arrow::after {
            content: ' â†“';
        }

        /* ì‚­ì œ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .delete-mode .company-row {
            cursor: default;
        }

        .delete-mode .company-name {
            cursor: default;
        }

        .delete-mode .company-name:hover {
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; width: 100%;">
                <h1 style="margin: 0; color: #ffffff; font-size: 2rem; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); flex: 0 0 auto;">
                    <i class="fas fa-clipboard-list" style="margin-right: 0.75rem;"></i>ì² ê°•ì˜ì—… ì—…ë¬´ì¼ì§€
                </h1>
                <div style="flex: 1 1 auto;"></div>
                <div style="display: flex; align-items: center; gap: 2rem; flex: 0 0 auto;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div id="profileImageContainer" style="width: 40px; height: 40px;">
                            <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #ffffff; font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span id="userName">ë¡œê·¸ì¸ í•„ìš”</span>
                            </div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.75rem; margin-top: 0.25rem;" id="userRole">
                                -
                            </div>
                        </div>
                    </div>
                    <button onclick="goToDashboard()" style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(243, 156, 18, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(243, 156, 18, 0.3)'">
                        <i class="fas fa-tachometer-alt" style="margin-right: 0.75rem;"></i>ëŒ€ì‹œë³´ë“œ
                    </button>
                </div>
            </div>
        </header>

        <main>
            <section class="search-section">
                <h2>ì—…ì²´ ê²€ìƒ‰</h2>
                <div class="search-container">
                    <select id="searchRegion" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; min-width: 150px;">
                        <option value="">ì „ì²´ ì§€ì—­</option>
                    </select>
                    <input type="text" id="searchCompany" placeholder="ì—…ì²´ëª…ìœ¼ë¡œ ê²€ìƒ‰">
                    <button id="searchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
                </div>
            </section>

            <section class="action-section">
                <div class="action-buttons">
                    <button id="addCompanyBtn" class="btn btn-success">ìƒˆ ì—…ì²´ ë“±ë¡</button>
                    <button id="exportBtn" class="btn btn-primary">ì—…ì²´ ëª©ë¡ ë‚´ë³´ë‚´ê¸° (XLSX)</button>
                    <button id="importBtn" class="btn btn-secondary">ì—…ì²´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (XLSX)</button>
                    <button id="deleteBtn" class="btn btn-warning">ì‚­ì œ</button>
                    <button onclick="goToSettings()" class="btn btn-purple">ì„¤ì •</button>
                </div>
                <input type="file" id="xlsxFileInput" accept=".xlsx,.xls" style="display: none;">
            </section>

            <section class="results-section">
                <h2>ì—…ì²´ ëª©ë¡ <span id="companyCount" class="company-count">(0ê°œ)</span></h2>
                <div class="table-container">
                    <table class="company-table" id="companyTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable(0)">ì—…ì²´ëª… <span class="sort-arrow">â†•</span></th>
                                <th class="sortable" onclick="sortTable(1)">ì£¼ì†Œ <span class="sort-arrow">â†•</span></th>
                                <th class="sortable" onclick="sortTable(2)">ë‹´ë‹¹ì <span class="sort-arrow">â†•</span></th>
                                <th class="sortable" onclick="sortTable(3)">ì „í™”ë²ˆí˜¸ <span class="sort-arrow">â†•</span></th>
                                <th class="sortable" onclick="sortTable(4)">ì—…ì¢… <span class="sort-arrow">â†•</span></th>
                                <th class="sortable" onclick="sortTable(5)">ë°©ë¬¸íšŸìˆ˜ <span class="sort-arrow">â†•</span></th>
                                <th class="sortable" onclick="sortTable(6)">ìµœê·¼ë°©ë¬¸ì¼ <span class="sort-arrow">â†•</span></th>
                            </tr>
                        </thead>
                        <tbody id="companyList">
                            <!-- ì—…ì²´ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Database Scripts -->
    <script src="database.js?v=20250107"></script>
    <script src="shared-assets/js/auth.js?v=20250107"></script>
    <script src="main.js?v=20250107"></script>
    <script>
        // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (employee-dashboard.htmlê³¼ ë™ì¼í•œ ë¡œì§)
        async function getCurrentUserFromDB() {
            try {
                console.log('ğŸ” getCurrentUserFromDB ì‹œì‘');
                
                if (!window.db) {
                    console.warn('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    return null;
                }
                
                await window.db.init();
                console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œê·¸ì¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const loginInfo = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('ğŸ“‹ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ë¡œê·¸ì¸ ì •ë³´:', loginInfo);
                
                if (!loginInfo || (!loginInfo.email && !loginInfo.id)) {
                    console.error('âŒ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return null;
                }
                
                // Supabase users í…Œì´ë¸”ì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (ì´ë©”ì¼ ë˜ëŠ” IDë¡œ)
                let user, error;
                if (loginInfo.email && loginInfo.email !== 'null') {
                    // ì´ë©”ì¼ë¡œ ì¡°íšŒ (Google ë¡œê·¸ì¸)
                    console.log('ğŸ” ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ:', loginInfo.email);
                    const result = await window.db.client
                        .from('users')
                        .select('*')
                        .eq('email', loginInfo.email)
                        .single();
                    user = result.data;
                    error = result.error;
                    console.log('ğŸ“Š ì´ë©”ì¼ ì¡°íšŒ ê²°ê³¼:', { user, error });
                } else if (loginInfo.id) {
                    // IDë¡œ ì¡°íšŒ (ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì—ì„œ ì´ë©”ì¼ì´ ì—†ëŠ” ê²½ìš°)
                    console.log('ğŸ” IDë¡œ ì‚¬ìš©ì ì¡°íšŒ:', loginInfo.id);
                    const result = await window.db.client
                        .from('users')
                        .select('*')
                        .eq('id', loginInfo.id)
                        .single();
                    user = result.data;
                    error = result.error;
                    console.log('ğŸ“Š ID ì¡°íšŒ ê²°ê³¼:', { user, error });
                }
                
                if (error) {
                    console.error('âŒ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                    return null;
                }
                
                if (!user) {
                    console.error('âŒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return null;
                }
                
                console.log('âœ… ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì„±ê³µ:', user);
                
                // ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ sessionStorageì— ì €ì¥
                const updatedUser = {
                    ...user,
                    permissions: AuthManager.ROLE_PERMISSIONS[user.role] || AuthManager.ROLE_PERMISSIONS['employee']
                };
                sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
                sessionStorage.setItem('userRole', user.role);
                sessionStorage.setItem('userName', user.name);
                console.log('âœ… sessionStorage ì—…ë°ì´íŠ¸ ì™„ë£Œ:', updatedUser);
                
                return user;
            } catch (error) {
                console.error('âŒ getCurrentUserFromDB ì˜¤ë¥˜:', error);
                return null;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ë° ì§€ì—­ ë“œë¡­ë‹¤ìš´ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', async function() {
            // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ëŒ€ê¸°
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
            
            // ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë  ë•Œê¹Œì§€ ìµœëŒ€ 5ì´ˆ ëŒ€ê¸°
            let retryCount = 0;
            while ((!window.db || !window.db.client) && retryCount < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retryCount++;
            }
            
            console.log('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ìƒíƒœ:', !!window.db, !!window.db?.client);
            
            // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìµœì‹  ì •ë³´)
            let currentUser = await getCurrentUserFromDB();
            console.log('ğŸ§ª getCurrentUserFromDBì—ì„œ ê°€ì ¸ì˜¨ ì‚¬ìš©ì ì •ë³´:', currentUser);
            
            // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©ìë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° AuthManager í™•ì¸
            if (!currentUser) {
                currentUser = AuthManager.getCurrentUser();
                console.log('ğŸ§ª AuthManagerì—ì„œ ê°€ì ¸ì˜¨ ì‚¬ìš©ì ì •ë³´:', currentUser);
            }
            
            if (currentUser) {
                // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
                document.getElementById('userName').textContent = currentUser.name || currentUser.email;
                
                // í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ
                const profileContainer = document.getElementById('profileImageContainer');
                if (profileContainer) {
                    // ê¸°ë³¸ ì•„ë°”íƒ€ ìƒì„± í•¨ìˆ˜
                    function generateDefaultAvatar(name) {
                        // í•œê¸€ ë¬¸ì ì²˜ë¦¬ë¥¼ ìœ„í•´ encodeURIComponent ì‚¬ìš©
                        const initials = name ? name.charAt(0).toUpperCase() : '?';
                        const svgString = `
                            <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="20" cy="20" r="20" fill="#667eea"/>
                                <text x="20" y="26" font-family="Arial" font-size="18" fill="white" text-anchor="middle">${initials}</text>
                            </svg>
                        `;
                        return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgString)}`;
                    }
                    
                    const profileImage = currentUser.profileImage || currentUser.profile_image || generateDefaultAvatar(currentUser.name || 'User');
                    console.log('ğŸ–¼ï¸ í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •:', {
                        profileImage: currentUser.profileImage,
                        profile_image: currentUser.profile_image,
                        finalImage: profileImage
                    });
                    
                    profileContainer.innerHTML = `
                        <img src="${profileImage}" alt="í”„ë¡œí•„" 
                             style="width: 40px; height: 40px; border-radius: 50%; 
                                    border: 2px solid #fff; object-fit: cover;">
                    `;
                }
                
                // ì‚¬ìš©ì ì—­í•  í‘œì‹œ
                let roleText = '';
                switch(currentUser.role) {
                    case 'master':
                        roleText = 'ë§ˆìŠ¤í„° ê´€ë¦¬ì';
                        break;
                    case 'company_admin':
                        roleText = 'ì—…ì²´ ê´€ë¦¬ì';
                        break;
                    case 'company_manager':
                        roleText = 'ì—…ì²´ ë§¤ë‹ˆì €';
                        break;
                    case 'employee':
                        roleText = 'ì§ì›';
                        break;
                    default:
                        roleText = currentUser.role || '-';
                }
                document.getElementById('userRole').textContent = roleText;
                
                // ê°œì¸ ì—…ì²´ ëª©ë¡ ì•Œë¦¼ í‘œì‹œ
                const alertShown = localStorage.getItem('personalCompanyListAlertShown');
                if (!alertShown) {
                    alert(`${currentUser.name || currentUser.email}ë‹˜ì˜ ê°œì¸ ì—…ì²´ ëª©ë¡ì…ë‹ˆë‹¤.\nì—¬ê¸°ì„œ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œí•œ ì—…ì²´ ì •ë³´ëŠ” ë‹¤ë¥¸ ì‚¬ìš©ìì™€ ê³µìœ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                    localStorage.setItem('personalCompanyListAlertShown', 'true');
                }
            } else {
                // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
            }
            
            // ì§€ì—­ ëª©ë¡ ë¡œë“œ
            loadRegions();
        });
        
        // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ í•¨ìˆ˜
        function goToDashboard() {
            window.location.href = 'employee-dashboard.html';
        }
        
        // ì„¤ì •ìœ¼ë¡œ ì´ë™ í•¨ìˆ˜
        function goToSettings() {
            const currentUser = AuthManager.getCurrentUser();
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            window.location.href = 'settings.html';
        }
        
        // ì§€ì—­ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
        function loadRegions() {
            const defaultRegions = ['ì„œìš¸','ë¶€ì‚°','ëŒ€êµ¬','ê²½ì£¼','ê¹€í•´','ì–‘ì‚°','í•¨ì•ˆ','ë°€ì–‘','ì°½ì›','ì°½ë…•','ìš¸ì‚°','ëª©í¬','ê´‘ì£¼','ê´‘ì–‘'];
            const savedRegions = localStorage.getItem('company_regions');
            const regions = savedRegions ? JSON.parse(savedRegions) : defaultRegions.sort((a, b) => a.localeCompare(b));
            
            const regionSelect = document.getElementById('searchRegion');
            if (regionSelect) {
                // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
                regionSelect.innerHTML = '<option value="">ì „ì²´ ì§€ì—­</option>';
                
                // ì €ì¥ëœ ì§€ì—­ ì¶”ê°€
                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    regionSelect.appendChild(option);
                });
            }
        }
    </script>
</body>
</html>