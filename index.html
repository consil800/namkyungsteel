<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title id="pageTitle">남경스틸(주) - 최고의 품질, 최상의 서비스</title>
  <meta name="description" content="대한민국 최고의 철강 전문 기업">
  <meta name="keywords" content="철강, 스틸, 강철, 제조업">

  <!-- Favicons -->
  <link href="logo.jpg" rel="icon">
  <link href="logo.jpg" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* 인증 모달 스타일 */
    .auth-form .form-group {
      margin-bottom: 20px;
    }
    
    .auth-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .auth-form input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }
    
    .auth-form input:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }
    
    .btn-primary {
      width: 100%;
      padding: 12px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
      margin: 20px 0 15px 0;
    }
    
    .btn-primary:hover {
      background: #0052a3;
    }
    
    .btn-google {
      width: 100%;
      padding: 12px 20px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      background: white;
      color: #3c4043;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin: 10px 0 20px 0;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .btn-google:hover {
      background: #f8f9fa;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .btn-kakao {
      width: 100%;
      padding: 12px 20px;
      border: 1px solid #FEE500;
      border-radius: 8px;
      background: #FEE500;
      color: #3C1E1E;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin: 10px 0 20px 0;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-kakao:hover {
      background: #FDD835;
      border-color: #FDD835;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .divider {
      text-align: center;
      margin: 25px 0;
      position: relative;
    }
    
    .divider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #ddd;
    }
    
    .divider span {
      background: white;
      padding: 0 15px;
      color: #666;
      font-size: 14px;
    }
    
    .auth-switch {
      text-align: center;
      margin-top: 20px;
      color: #666;
    }
    
    .auth-switch a {
      color: #0066cc;
      text-decoration: none;
      font-weight: 500;
    }
    
    .auth-switch a:hover {
      text-decoration: underline;
    }
    
    .status-message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }
    
    .status-success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #4caf50;
    }
    
    .status-error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #f44336;
    }
    
    .status-info {
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #2196f3;
    }
    
    /* 로그인 후 사용자 프로필 영역 */
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background-color 0.3s;
    }
    
    .user-profile:hover {
      background: rgba(0, 102, 204, 0.1);
    }
    
    .user-profile img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .user-profile .profile-name {
      font-weight: 500;
      color: #333;
    }
  </style>

  <!-- Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">
  
  <style>
    body { 
      font-family: 'Noto Sans KR', sans-serif !important; 
      background-color: #ffffff !important;
    }
    
    /* 메인 섭션과 푸터 사이 공간 추가 */
    .main {
      margin-bottom: 0 !important;
    }
    
    
    /* 🎯 HERO SECTION STYLES - 밝은 상단, 어두운 하단 대비 */
    #hero {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
      background-image: none !important;
      color: #2c3e50 !important;
    }
    
    #heroImagePlaceholder {
      background: linear-gradient(135deg, #0066cc, #004499) !important;
      opacity: 1 !important;
      border-radius: 15px !important;
      box-shadow: 0 10px 30px rgba(0, 102, 204, 0.2) !important;
    }
    
    .hero .highlight {
      color: #0066cc !important;
      background: linear-gradient(45deg, #0066cc, #004499);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .hero h1 {
      color: #1a365d !important;
      font-weight: 700 !important;
    }
    
    .hero .lead {
      color: #4a5568 !important;
    }
    
    .hero-features li {
      color: #2c3e50 !important;
    }
    
    .hero-features i {
      color: #0066cc !important;
    }
    
    .hero-tag {
      background: linear-gradient(45deg, #0066cc, #004499) !important;
      color: white !important;
      border-radius: 25px !important;
      padding: 8px 16px !important;
    }
  </style>
  

  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- 공통 컴포넌트 스타일 -->
  <link href="includes/common-styles.css" rel="stylesheet">
</head>

<body class="index-page">


  <main class="main">

    <!-- Hero Section -->
    <section id="hero" class="hero section" style="padding: 120px 0; position: relative; overflow: hidden;">
      <div class="container" data-aos="fade-up">
        <div class="row align-items-center">
          <div class="col-lg-6">
            <div class="hero-content" data-aos="fade-up" data-aos-delay="100">
              <div class="hero-tag">
                <i class="bi bi-gear-fill"></i>
                <span id="heroTag">철강 산업의 리더</span>
              </div>
              <h1 id="heroTitle">최고의 <span class="highlight">품질</span>과 <span class="highlight">기술력</span>으로 미래를 만듭니다</h1>
              <p class="lead" id="heroDescription">12년 전통의 기술력과 혁신으로 대한민국 철강 산업을 선도하는<br><span style="color: #0052a3; font-size: 1.3em; font-weight: bold;">남경스틸(주)</span>입니다.</p>
              <ul class="hero-features">
                <li><i class="bi bi-check-circle"></i> <span>ISO 9001 품질경영시스템 인증</span></li>
                <li><i class="bi bi-check-circle"></i> <span>연간 10만톤 생산 능력</span></li>
                <li><i class="bi bi-check-circle"></i> <span>24시간 고객 기술지원</span></li>
              </ul>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="hero-image" data-aos="zoom-out" data-aos-delay="200">
              <div id="heroImagePlaceholder" class="image-placeholder" style="border: none; padding: 0; text-align: center; height: 500px; display: flex; align-items: center; justify-content: center; background: #000000; overflow: hidden; border-radius: 10px;">
                <img src="namkyung.png" 
                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" 
                     alt="Scout 히어로 이미지">
              </div>
            </div>
          </div>
        </div>
      </div>
    </section><!-- /Hero Section -->

  </main>


  <!-- 로그인/회원가입 모달 -->
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="authModalTitle">로그인</h2>
        <button class="close-btn" onclick="closeAuthModal()">&times;</button>
      </div>
      
      <div class="modal-body">
        <!-- 로그인 폼 -->
        <div id="loginForm" class="auth-form">
          <div class="form-group">
            <label>이메일</label>
            <input type="email" id="loginEmail" placeholder="이메일을 입력하세요" required>
          </div>
          
          <div class="form-group">
            <label>비밀번호</label>
            <input type="password" id="loginPassword" placeholder="비밀번호를 입력하세요" required>
          </div>
          
          <button type="button" onclick="handleEmailLogin()" class="btn-primary">로그인</button>
          
          <!-- 구분선 -->
          <div class="divider">
            <span>또는</span>
          </div>
          
          <!-- Google 로그인 -->
          <button type="button" onclick="handleGoogleLogin()" class="btn-google">
            <svg width="18" height="18" viewBox="0 0 18 18">
              <g fill="none" fill-rule="evenodd">
                <path d="M17.64 9.205c0-.639-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/>
                <path d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z" fill="#34A853"/>
                <path d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
              </g>
            </svg>
            Google로 로그인
          </button>

          <!-- 카카오 로그인 -->
          <button type="button" onclick="handleKakaoLogin()" class="btn-kakao">
            <svg width="18" height="18" viewBox="0 0 18 18">
              <g fill="none" fill-rule="evenodd">
                <path d="M9 0C4.03 0 0 3.13 0 7c0 2.52 1.67 4.74 4.19 6.04L3.5 16.5c-.13.47.35.85.76.6l3.92-2.65c.28.02.55.05.82.05 4.97 0 9-3.13 9-7S13.97 0 9 0z" fill="#3C1E1E"/>
              </g>
            </svg>
            카카오로 로그인
          </button>
          
          <div class="auth-switch">
            계정이 없으신가요? <a href="#" onclick="showRegisterForm()">회원가입</a>
          </div>
        </div>
        
        <!-- 회원가입 폼 -->
        <div id="registerForm" class="auth-form" style="display: none;">
          <div class="form-group">
            <label>이름</label>
            <input type="text" id="registerName" placeholder="이름을 입력하세요" required>
          </div>
          
          <div class="form-group">
            <label>이메일</label>
            <input type="email" id="registerEmail" placeholder="이메일을 입력하세요" required>
          </div>
          
          <div class="form-group">
            <label>비밀번호</label>
            <input type="password" id="registerPassword" placeholder="비밀번호를 입력하세요 (최소 6자)" required minlength="6">
          </div>
          
          <div class="form-group">
            <label>비밀번호 확인</label>
            <input type="password" id="confirmPassword" placeholder="비밀번호를 다시 입력하세요" required>
          </div>
          
          <div class="form-group">
            <label>부서 (선택사항)</label>
            <input type="text" id="registerDepartment" placeholder="부서를 입력하세요">
          </div>
          
          <div class="form-group">
            <label>직책 (선택사항)</label>
            <input type="text" id="registerPosition" placeholder="직책을 입력하세요">
          </div>
          
          <button type="button" onclick="handleRegister()" class="btn-primary">회원가입</button>
          
          <div class="auth-switch">
            이미 계정이 있으신가요? <a href="#" onclick="showLoginForm()">로그인</a>
          </div>
        </div>
        
        <div id="authStatus" class="status-message" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@srexi/purecounterjs/dist/purecounter_vanilla.js"></script>
  <script src="https://unpkg.com/swiper@8/swiper-bundle.min.js"></script>

  <!-- Supabase 및 로그인 기능 -->
  <script>
    // Supabase 설정
    const SUPABASE_URL = 'https://zgyawfmjconubxaiamod.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpneWF3Zm1qY29udWJ4YWlhbW9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3NjQzNzIsImV4cCI6MjA2NzM0MDM3Mn0.shjBE2OQeILwkLLi4E6Bq0-b6YPUs-WFwquexdUiM9A';
    
    // Supabase 클라이언트 초기화
    let supabaseClient = null;
    
    try {
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          detectSessionInUrl: true,
          autoRefreshToken: true
        }
      });
      console.log('✅ Supabase 클라이언트 초기화 완료');
    } catch (error) {
      console.error('❌ Supabase 초기화 오류:', error);
    }
    
    // 상태 표시 함수
    function showStatus(message, type = 'info') {
      const status = document.getElementById('authStatus');
      status.style.display = 'block';
      status.className = `status-message status-${type}`;
      status.textContent = message;
      
      console.log(`${type.toUpperCase()}: ${message}`);
    }
    
    // 인증 모달 열기 (로그인 폼)
    function showLoginModal() {
      console.log('🔐 로그인 모달 열기');
      document.getElementById('authModal').style.display = 'flex';
      showLoginForm();
    }
    
    // 인증 모달 닫기
    function closeAuthModal() {
      console.log('❌ 인증 모달 닫기');
      document.getElementById('authModal').style.display = 'none';
      // 폼 초기화
      clearAuthForms();
    }
    
    // 로그인 폼 표시
    function showLoginForm() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('authModalTitle').textContent = '로그인';
      document.getElementById('authStatus').style.display = 'none';
    }
    
    // 회원가입 폼 표시
    function showRegisterForm() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
      document.getElementById('authModalTitle').textContent = '회원가입';
      document.getElementById('authStatus').style.display = 'none';
    }
    
    // 폼 초기화
    function clearAuthForms() {
      // 로그인 폼 초기화
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
      
      // 회원가입 폼 초기화
      document.getElementById('registerName').value = '';
      document.getElementById('registerEmail').value = '';
      document.getElementById('registerPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      document.getElementById('registerDepartment').value = '';
      document.getElementById('registerPosition').value = '';
      
      // 상태 메시지 숨기기
      document.getElementById('authStatus').style.display = 'none';
    }
    
    // 이메일 로그인
    async function handleEmailLogin() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!email || !password) {
        showStatus('이메일과 비밀번호를 입력하세요.', 'error');
        return;
      }
      
      showStatus('로그인 중...', 'info');
      
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        if (error) {
          showStatus('로그인 실패: ' + error.message, 'error');
        } else {
          showStatus('로그인 성공!', 'success');
          console.log('사용자 정보:', data.user);
          
          // 사용자 정보 저장 및 UI 업데이트
          const user = {
            id: data.user.id,
            email: data.user.email,
            name: data.user.user_metadata?.name || data.user.email,
            profileImage: data.user.user_metadata?.avatar_url,
            provider: 'email'
          };
          
          saveUserAndUpdateUI(user);
          closeAuthModal();
          
          // employee-dashboard로 이동
          setTimeout(() => {
            window.location.href = 'employee-dashboard.html';
          }, 1000);
        }
      } catch (error) {
        showStatus('로그인 오류: ' + error.message, 'error');
      }
    }
    
    // 회원가입
    async function handleRegister() {
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const department = document.getElementById('registerDepartment').value;
      const position = document.getElementById('registerPosition').value;
      
      // 유효성 검사
      if (!name || !email || !password) {
        showStatus('이름, 이메일, 비밀번호는 필수 입력 항목입니다.', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        showStatus('비밀번호가 일치하지 않습니다.', 'error');
        return;
      }
      
      if (password.length < 6) {
        showStatus('비밀번호는 최소 6자 이상이어야 합니다.', 'error');
        return;
      }
      
      showStatus('회원가입 중...', 'info');
      
      try {
        const { data, error } = await supabaseClient.auth.signUp({
          email: email,
          password: password,
          options: {
            data: {
              name: name,
              department: department,
              position: position,
              company_domain: 'namkyungsteel.com',
              company_name: '남경스틸(주)'
            }
          }
        });
        
        if (error) {
          showStatus('회원가입 실패: ' + error.message, 'error');
        } else {
          console.log('Supabase Auth 회원가입 성공:', data);
          
          // 커스텀 users 테이블에도 사용자 정보 저장
          try {
            if (data.user) {
              const { data: insertData, error: insertError } = await supabaseClient
                .from('users')
                .insert([
                  {
                    id: data.user.id,
                    email: email,
                    name: name,
                    department: department || '',
                    position: position || '',
                    company_domain: 'namkyungsteel.com',
                    company_name: '남경스틸(주)',
                    role: 'employee',
                    created_at: new Date().toISOString()
                  }
                ]);
              
              if (insertError) {
                console.error('❌ users 테이블 저장 오류:', insertError);
                showStatus('회원가입은 성공했지만 사용자 정보 저장에 실패했습니다.', 'error');
              } else {
                console.log('✅ users 테이블에 사용자 정보 저장 완료:', insertData);
                showStatus('회원가입 성공! 이메일을 확인해주세요.', 'success');
              }
            }
          } catch (tableError) {
            console.error('❌ users 테이블 저장 예외:', tableError);
          }
          
          // 자동 로그인이 되었다면 UI 업데이트
          if (data.user && data.session) {
            const user = {
              id: data.user.id,
              email: data.user.email,
              name: name,
              department: department,
              position: position,
              provider: 'email'
            };
            
            saveUserAndUpdateUI(user);
            closeAuthModal();
            
            // employee-dashboard로 이동
            setTimeout(() => {
              window.location.href = 'employee-dashboard.html';
            }, 1000);
          }
        }
      } catch (error) {
        showStatus('회원가입 오류: ' + error.message, 'error');
      }
    }
    
    // 사용자 정보 저장 및 UI 업데이트
    function saveUserAndUpdateUI(user) {
      // sessionStorage에 사용자 정보 저장 (브라우저 세션 동안만 유지)
      sessionStorage.setItem('currentUser', JSON.stringify(user));
      sessionStorage.setItem('userRole', user.role || 'employee');
      sessionStorage.setItem('userName', user.name);
      
      // 네비바 상태 업데이트 (공통 컴포넌트) - 여러 시점에서 시도
      function tryUpdateNavbar() {
        if (window.updateNavbarLoginState) {
          console.log('🔄 index.html: 네비바 상태 업데이트 실행');
          window.updateNavbarLoginState();
        } else {
          console.warn('⚠️ index.html: updateNavbarLoginState 함수 없음');
        }
      }
      
      setTimeout(tryUpdateNavbar, 100);
      setTimeout(tryUpdateNavbar, 300);
      setTimeout(tryUpdateNavbar, 500);
      setTimeout(tryUpdateNavbar, 1000);
      
      console.log('✅ 사용자 정보 저장 및 네비바 상태 업데이트 완료:', user);
    }
    
    // 로그인된 사용자용 UI 업데이트
    function updateUIForLoggedInUser(user) {
      const loginBtn = document.getElementById('mainLoginBtn');
      const userProfile = document.getElementById('userProfile');
      
      if (loginBtn && userProfile) {
        // 로그인 버튼 숨기기
        loginBtn.style.display = 'none';
        
        // 사용자 프로필 표시
        userProfile.style.display = 'flex';
        
        // 프로필 이미지 설정
        const profileImage = document.getElementById('profileImage');
        if (user.profileImage) {
          profileImage.src = user.profileImage;
        }
        
        // 사용자 이름 설정
        const profileName = document.getElementById('profileName');
        if (profileName) {
          profileName.textContent = user.name;
        }
      }
    }
    
    // 로그아웃된 상태용 UI 업데이트
    function updateUIForLoggedOutUser() {
      const loginBtn = document.getElementById('mainLoginBtn');
      const userProfile = document.getElementById('userProfile');
      
      if (loginBtn && userProfile) {
        // 로그인 버튼 표시
        loginBtn.style.display = 'flex';
        
        // 사용자 프로필 숨기기
        userProfile.style.display = 'none';
      }
    }
    
    // 로그아웃
    function logout() {
      sessionStorage.removeItem('currentUser');
      sessionStorage.removeItem('userRole');
      sessionStorage.removeItem('userName');
      
      // 네비바 상태 업데이트 (공통 컴포넌트)
      if (window.updateNavbarLoginState) {
        window.updateNavbarLoginState();
      }
      
      console.log('🚪 로그아웃 완료');
      
      // 프로필 모달 닫기
      hideProfileModal();
      
      // 메인 페이지로 리다이렉트
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 100);
    }
    
    // Google 로그인
    async function handleGoogleLogin() {
      console.log('🔐 Google 로그인 시작');
      showStatus('Google 로그인 중...', 'info');
      
      if (!supabaseClient) {
        showStatus('데이터베이스 연결이 필요합니다.', 'error');
        return;
      }
      
      try {
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: 'https://namkyungsteel.com'
          }
        });
        
        if (error) {
          console.error('❌ Google 로그인 오류:', error);
          showStatus('Google 로그인 오류: ' + error.message, 'error');
        } else {
          console.log('✅ Google OAuth 시작됨:', data);
          showStatus('Google 로그인 페이지로 이동합니다...', 'success');
        }
      } catch (error) {
        console.error('❌ Google 로그인 예외:', error);
        showStatus('Google 로그인 중 오류가 발생했습니다: ' + error.message, 'error');
      }
    }

    // 카카오 로그인
    async function handleKakaoLogin() {
      console.log('🔐 Kakao 로그인 시작');
      showStatus('카카오 로그인 중...', 'info');
      
      if (!supabaseClient) {
        showStatus('데이터베이스 연결이 필요합니다.', 'error');
        return;
      }
      
      try {
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'kakao',
          options: {
            redirectTo: 'https://namkyungsteel.com',
            scopes: 'profile_nickname profile_image account_email' // 이메일 포함
          }
        });
        
        if (error) {
          console.error('❌ Kakao 로그인 오류:', error);
          showStatus('카카오 로그인 오류: ' + error.message, 'error');
        } else {
          console.log('✅ Kakao OAuth 시작됨:', data);
          showStatus('카카오 로그인 페이지로 이동합니다...', 'success');
        }
      } catch (error) {
        console.error('❌ Kakao 로그인 예외:', error);
        showStatus('카카오 로그인 중 오류가 발생했습니다: ' + error.message, 'error');
      }
    }
    
    // OAuth 콜백 처리
    async function handleOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      
      if (urlParams.get('code') || hashParams.get('access_token') || window.location.hash.includes('access_token')) {
        console.log('🔐 OAuth 콜백 감지됨');
        
        try {
          const { data: { session }, error } = await supabaseClient.auth.getSession();
          
          if (error && !error.message.includes('skew')) {
            console.error('❌ 세션 확인 오류:', error);
            return;
          }
          
          if (session && session.user) {
            console.log('✅ OAuth 로그인 성공:', session.user);
            
            // 데이터베이스에서 실제 사용자 정보 조회
            let dbUser = null;
            try {
              if (session.user.email) {
                const { data: existingUserByEmail, error: emailError } = await supabaseClient
                  .from('users')
                  .select('*')
                  .eq('email', session.user.email)
                  .single();
                
                if (!emailError && existingUserByEmail) {
                  dbUser = existingUserByEmail;
                  console.log('📋 이메일로 기존 사용자 찾음:', dbUser);
                }
              }
              
              if (!dbUser && session.user.id) {
                const { data: existingUserByOAuth, error: oauthError } = await supabaseClient
                  .from('users')
                  .select('*')
                  .eq('oauth_id', session.user.id)
                  .single();
                
                if (!oauthError && existingUserByOAuth) {
                  dbUser = existingUserByOAuth;
                  console.log('📋 OAuth ID로 기존 사용자 찾음:', dbUser);
                }
              }
            } catch (lookupError) {
              console.log('🔍 사용자 조회 중:', lookupError.message);
            }
            
            // 사용자 정보 구성
            const actualProvider = session.user.app_metadata?.provider || 'unknown';
            const user = dbUser ? {
              id: dbUser.id,
              email: dbUser.email,
              name: dbUser.name,
              role: dbUser.role,
              department: dbUser.department,
              position: dbUser.position,
              company_domain: dbUser.company_domain,
              company_name: dbUser.company_name,
              profileImage: dbUser.profile_image || session.user.user_metadata?.avatar_url || session.user.user_metadata?.picture,
              profile_image: dbUser.profile_image,
              oauth_id: dbUser.oauth_id,
              oauth_provider: dbUser.oauth_provider,
              provider: actualProvider,
              is_approved: dbUser.is_approved,
              is_active: dbUser.is_active
            } : {
              id: session.user.id,
              email: session.user.email,
              name: session.user.user_metadata?.name || session.user.user_metadata?.full_name || session.user.email,
              profileImage: session.user.user_metadata?.avatar_url || session.user.user_metadata?.picture,
              provider: actualProvider
            };
            
            // users 테이블 저장은 이미 데이터베이스에서 처리됨 (주석 처리)
            console.log('📋 최종 사용자 정보:', user);
            /*
            try {
              const { data: existingUser, error: selectError } = await supabaseClient
                .from('users')
                .select('id')
                .eq('id', user.id)
                .single();
              
              if (!existingUser) {
                // 새 사용자라면 users 테이블에 저장
                console.log('🔄 새 사용자 저장 건너뜀 (이미 데이터베이스에 존재)');
              }
            } catch (tableError) {
              console.log('🔄 사용자 테이블 처리 건너뜀');
            }
            */
            
            saveUserAndUpdateUI(user);
            
            // URL 정리
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // 로그인 제공자에 따른 메시지 표시
            const provider = user.provider || 'OAuth';
            let providerName = '';
            if (provider === 'google') {
                providerName = 'Google';
            } else if (provider === 'kakao') {
                providerName = '카카오';
            } else {
                providerName = '소셜';
            }
            alert(`${providerName} 로그인 성공! 환영합니다, ${user.name}`);
            
            // employee-dashboard로 즉시 이동
            window.location.href = 'employee-dashboard.html';
          }
        } catch (error) {
          if (!error.message.includes('skew')) {
            console.error('❌ OAuth 콜백 처리 오류:', error);
          }
        }
      }
    }
    
    // 페이지 로드 시 OAuth 콜백 처리만 수행 (로그인 상태는 네비바에서 관리)
    document.addEventListener('DOMContentLoaded', function() {
      console.log('📄 페이지 로드됨');
      
      // OAuth 콜백 처리
      handleOAuthCallback();
    });
    
    // 저장된 사용자 세션 확인 및 복원
    function checkAndRestoreUserSession() {
      const currentUser = sessionStorage.getItem('currentUser');
      if (currentUser) {
        try {
          const user = JSON.parse(currentUser);
          console.log('✅ 저장된 사용자 정보 복원:', user);
          updateUIForLoggedInUser(user);
        } catch (error) {
          console.error('❌ 사용자 정보 파싱 오류:', error);
          sessionStorage.removeItem('currentUser');
          updateUIForLoggedOutUser();
        }
      } else {
        console.log('ℹ️ 저장된 사용자 정보 없음');
        updateUIForLoggedOutUser();
      }
    }
    
    // 프로필 클릭 핸들러
    function handleProfileClick() {
      showProfileModal();
    }
    
    // 기본 아바타 생성 함수
    function generateDefaultAvatar(name) {
      // 기본 아바타 이미지 반환
      return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyMCIgeT0iMjQiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfkYQ8L3N2Zz4KPC9zdmc+';
    }

    // 프로필 모달 표시
    function showProfileModal() {
      const currentUser = sessionStorage.getItem('currentUser');
      if (currentUser) {
        try {
          const user = JSON.parse(currentUser);
          
          // 프로필 이미지 설정
          const modalProfileImage = document.getElementById('modalProfileImage');
          if (user.profileImage) {
            modalProfileImage.src = user.profileImage;
          } else {
            // 기본 아바타 생성
            modalProfileImage.src = generateDefaultAvatar(user.name || user.email);
          }
          
          // 프로필 모달 정보 업데이트
          document.getElementById('profileUserName').value = user.name || '';
          document.getElementById('profileUserEmail').value = user.email || '';
          document.getElementById('profileUserDepartment').value = user.department || '';
          document.getElementById('profileUserPosition').value = user.position || '';
          
          // 모달 표시
          document.getElementById('profileModal').style.display = 'flex';
        } catch (error) {
          console.error('❌ 사용자 정보 로드 오류:', error);
        }
      }
    }
    
    // 프로필 모달 숨기기
    function hideProfileModal() {
      document.getElementById('profileModal').style.display = 'none';
    }
    
    // 전역 함수로 테스트 가능하도록
    window.testGoogleLogin = handleGoogleLogin;
    window.testSupabase = function() {
      console.log('Supabase 클라이언트:', supabaseClient);
      return supabaseClient !== null;
    };
    // 프로필 이미지 업로드
    async function handleProfileImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // 파일 크기 제한 (2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('이미지 크기는 2MB 이하여야 합니다.');
        return;
      }
      
      // 이미지 파일 확인
      if (!file.type.startsWith('image/')) {
        alert('이미지 파일만 업로드 가능합니다.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        const imageData = e.target.result;
        
        try {
          const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
          
          // 데이터베이스에 업데이트 (Google OAuth 사용자는 이메일로 식별)
          if (supabaseClient) {
            try {
              // 이메일로 사용자 찾아서 업데이트
              const { data, error } = await supabaseClient
                .from('users')
                .update({ 
                  profile_image: imageData,
                  updated_at: new Date().toISOString()
                })
                .eq('email', currentUser.email)
                .select();
                
              if (error) {
                console.error('데이터베이스 업데이트 오류:', error);
              } else {
                console.log('프로필 이미지 데이터베이스 업데이트 완료');
              }
            } catch (dbError) {
              console.error('데이터베이스 연결 오류:', dbError);
            }
          }
          
          // currentUser 객체 업데이트
          currentUser.profileImage = imageData;
          
          // sessionStorage에 업데이트된 정보 저장
          sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // UI 업데이트
          const modalProfileImage = document.getElementById('modalProfileImage');
          if (modalProfileImage) modalProfileImage.src = imageData;
          
          // 헤더의 프로필 이미지도 업데이트
          const headerProfileImages = document.querySelectorAll('.user-profile img, .profile-image img');
          headerProfileImages.forEach(img => {
            img.src = imageData;
          });
          
          alert('프로필 이미지가 변경되었습니다.');
        } catch (error) {
          console.error('프로필 이미지 저장 오류:', error);
          alert('프로필 이미지 저장 중 오류가 발생했습니다.');
        }
      };
      reader.readAsDataURL(file);
    }

    // 전역 함수로 노출 (공통 컴포넌트에서 사용)
    window.handleProfileClick = handleProfileClick;
    window.showProfileModal = showProfileModal;
    window.hideProfileModal = hideProfileModal;
    window.handleProfileImageUpload = handleProfileImageUpload;
    window.logout = logout;
    
    // 원본 함수들을 백업 (네비바에서 호출할 수 있도록)
    window._originalShowLoginModal = showLoginModal;
    window._originalHandleProfileClick = handleProfileClick;
  </script>

  
  <!-- 공통 컴포넌트 로드 -->
  <script src="includes/common.js"></script>
  
  <!-- Authentication Scripts will be loaded later -->

  <!-- Initialize AOS and PureCounter -->
  <script>
    // Initialize AOS (Animation on Scroll)
    if (typeof AOS !== 'undefined') {
      AOS.init({
        duration: 600,
        easing: 'ease-in-out',
        once: true,
        mirror: false
      });
    }
    
    // Initialize PureCounter
    if (typeof PureCounter !== 'undefined') {
      new PureCounter();
    }
    
    // 드롭다운 메뉴 클릭 기능 (모바일용)
    document.addEventListener('DOMContentLoaded', function() {
      const dropdownToggles = document.querySelectorAll('.toggle-dropdown');
      
      dropdownToggles.forEach(function(toggle) {
        toggle.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const dropdown = this.closest('.dropdown');
          const isActive = dropdown.classList.contains('active');
          
          // 다른 모든 드롭다운 닫기
          document.querySelectorAll('.dropdown.active').forEach(function(activeDropdown) {
            if (activeDropdown !== dropdown) {
              activeDropdown.classList.remove('active');
            }
          });
          
          // 현재 드롭다운 토글
          dropdown.classList.toggle('active', !isActive);
        });
      });
      
      // 외부 클릭 시 드롭다운 닫기
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown')) {
          document.querySelectorAll('.dropdown.active').forEach(function(dropdown) {
            dropdown.classList.remove('active');
          });
        }
      });
    });
    
    // Initialize Swiper if needed
    if (typeof Swiper !== 'undefined') {
      const swiper = new Swiper('.swiper', {
        loop: true,
        autoplay: {
          delay: 5000,
        },
        breakpoints: {
          320: {
            slidesPerView: 2,
            spaceBetween: 40
          },
          480: {
            slidesPerView: 3,
            spaceBetween: 60
          },
          640: {
            slidesPerView: 4,
            spaceBetween: 80
          },
          992: {
            slidesPerView: 6,
            spaceBetween: 120
          }
        }
      });
    }
  </script>

  <!-- 프로필 모달 -->
  <div class="modal" id="profileModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>프로필 설정</h2>
        <button class="close-btn" onclick="hideProfileModal()">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="profile-section">
          <div class="profile-image-section">
            <div class="current-profile-image">
              <img id="modalProfileImage" src="" alt="프로필 이미지" />
            </div>
            <div class="profile-image-upload">
              <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageUpload(event)">
              <button type="button" onclick="document.getElementById('profileImageInput').click()">이미지 변경</button>
            </div>
          </div>
          
          <form id="profileForm">
            <div class="form-group">
              <label>이름</label>
              <input type="text" id="profileUserName" readonly>
            </div>
            
            <div class="form-group">
              <label>이메일</label>
              <input type="email" id="profileUserEmail" readonly>
            </div>
            
            <div class="form-group">
              <label>부서</label>
              <input type="text" id="profileUserDepartment" readonly>
            </div>
            
            <div class="form-group">
              <label>직책</label>
              <input type="text" id="profileUserPosition" readonly>
            </div>
          </form>
        </div>
        
        <div class="password-section">
          <h3>비밀번호 변경</h3>
          <form id="passwordChangeForm">
            <div class="form-group">
              <label>현재 비밀번호</label>
              <input type="password" id="currentPassword" required>
            </div>
            
            <div class="form-group">
              <label>새 비밀번호</label>
              <input type="password" id="newPassword" required minlength="6">
            </div>
            
            <div class="form-group">
              <label>새 비밀번호 확인</label>
              <input type="password" id="confirmPasswordChange" required>
            </div>
            
            <button type="submit" class="btn-change-password">비밀번호 변경</button>
          </form>
        </div>
      </div>
      
      <div class="modal-footer">
        <button onclick="logout()" class="btn-logout">로그아웃</button>
        <button onclick="hideProfileModal()" class="btn-close">닫기</button>
      </div>
    </div>
  </div>

  <style>
    /* 프로필 모달 스타일 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 80%;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-header h2 {
      margin: 0;
      color: #333;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      position: absolute;
      right: 20px;
      top: 20px;
      padding: 5px;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.3s ease;
      z-index: 1001;
    }
    
    .close-btn:hover {
      color: #333;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .profile-image-section {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .current-profile-image img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #667eea;
      margin-bottom: 15px;
    }
    
    .profile-image-upload button {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .form-group input[readonly] {
      background: #f5f5f5;
    }
    
    .password-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    
    .password-section h3 {
      margin-bottom: 20px;
      color: #333;
    }
    
    .btn-change-password {
      width: 100%;
      background: #28a745;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    
    .btn-change-password:hover {
      background: #218838;
    }
    
    .modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-top: 1px solid #eee;
      gap: 10px;
    }
    
    .btn-logout {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      min-width: 80px;
    }
    
    .btn-logout:hover {
      background: #c82333;
    }
    
    .btn-close {
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.3s ease;
      white-space: nowrap;
      min-width: 80px;
    }
    
    .btn-close:hover {
      background: #545b62;
    }
  </style>

</body>
</html>
