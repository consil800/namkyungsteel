<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">ë‚¨ê²½ìŠ¤í‹¸(ì£¼) ì—…ë¬´ë³´ë“œ</title>
    
    <!-- Favicons -->
    <link href="logo.jpg" rel="icon">
    <link href="logo.jpg" rel="apple-touch-icon">
    
    <link rel="stylesheet" href="shared-assets/css/main.css">
    <link rel="stylesheet" href="shared-assets/css/platform.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Database Scripts -->
    <script src="database.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f7fa;
            min-height: 100vh;
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .welcome-section h1 {
            font-size: 2rem;
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }
        
        .welcome-section p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        
        .header-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .header-btn:hover {
            background: white;
            color: #667eea;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .logout-btn:hover {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        /* ë©”ì¸ ì½˜í…ì¸  */
        .dashboard-content {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 0 2rem;
        }
        
        /* ë©”ë‰´ ê·¸ë¦¬ë“œ */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .menu-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .menu-card:hover::before {
            transform: translateY(0);
        }
        
        .menu-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: white;
        }
        
        .menu-card h3 {
            font-size: 1.25rem;
            margin: 0 0 0.75rem 0;
            color: #333;
        }
        
        .menu-card p {
            color: #666;
            line-height: 1.6;
            margin: 0;
        }
        
        /* ë¹ ë¥¸ í†µê³„ */
        .stats-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 3rem;
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .stats-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-item:hover .stat-value {
            -webkit-text-fill-color: white;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .stat-item:hover .stat-label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* ìµœê·¼ í™œë™ */
        .activity-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .activity-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .activity-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .activity-time {
            font-size: 0.875rem;
            color: #666;
        }
        
        /* ì•Œë¦¼ ë°°ì§€ */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        /* í—¤ë” ì•Œë¦¼ ë°°ì§€ */
        .notification-badge-header {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                text-align: center;
                gap: 1.5rem;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        /* ì„œë¥˜ ìŠ¹ì¸ ì¹´ë“œ ê°•ì œ í‘œì‹œ */
        #documentApprovalCard[data-admin-protected="true"] {
            display: flex !important;
            flex-direction: column !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
    </div>
    
    <!-- í—¤ë” -->
    <header class="dashboard-header">
        <div class="header-container">
            <div class="welcome-section">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="user-profile-dashboard" onclick="showProfileModal()" style="cursor: pointer;">
                        <img id="profileImageDashboard" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyNSIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPu2yqTwvc3ZnPgo8L3N2Zz4=" alt="í”„ë¡œí•„" style="width: 50px !important; height: 50px !important; min-width: 50px; min-height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; transition: all 0.3s ease; object-fit: cover; display: block;" />
                    </div>
                    <div>
                        <h1><span id="userName">ì‚¬ìš©ì</span>ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!</h1>
                        <p id="userInfo">ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <a href="#" class="header-btn" onclick="goToHomepage()">
                    <i class="fas fa-home"></i> í™ˆí˜ì´ì§€
                </a>
                <button class="header-btn" id="approvalNotificationBtn" onclick="openApprovalNotifications()" style="position: relative;">
                    <i class="fas fa-bell"></i> ì•Œë¦¼
                    <span id="approvalNotificationBadgeHeader" class="notification-badge-header" style="display: none;">0</span>
                </button>
                <button class="header-btn" id="settingsBtn" onclick="goToSettings()">
                    <i class="fas fa-cog"></i> ì„¤ì •
                </button>
                <button class="header-btn logout-btn" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
    </header>
    
    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="dashboard-content">
        <!-- ë©”ë‰´ ê·¸ë¦¬ë“œ -->
        <div class="menu-grid">
            <div class="menu-card" onclick="openWorkLog()">
                <div class="menu-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <h3>ì—…ë¬´ì¼ì§€</h3>
                <p>ì˜¤ëŠ˜ì˜ ì—…ë¬´ ë‚´ìš©ì„ ê¸°ë¡í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. í”„ë¡œì íŠ¸ë³„ ì§„í–‰ìƒí™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            
            <div class="menu-card" onclick="openCorporateCard()">
                <div class="menu-icon" style="position: relative;">
                    <i class="fas fa-credit-card"></i>
                    <span id="cardNotificationBadge" class="notification-badge" style="display: none;">0</span>
                </div>
                <h3>ë²•ì¸ì¹´ë“œ ì‚¬ìš©</h3>
                <p>ë²•ì¸ì¹´ë“œ ì‚¬ìš© ë‚´ì—­ì„ ë“±ë¡í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. ê²½ë¹„ ì²˜ë¦¬ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <!-- ìŠ¹ì¸ ì•Œë¦¼ ì¹´ë“œëŠ” í—¤ë” ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´ë˜ì–´ ìˆ¨ê¹€ ì²˜ë¦¬
            <div class="menu-card" onclick="openApprovalNotifications()" style="display: none;">
                <div class="menu-icon" style="position: relative; background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                    <i class="fas fa-bell"></i>
                    <span id="approvalNotificationBadge" class="notification-badge" style="display: none;">0</span>
                </div>
                <h3>ìŠ¹ì¸ ì•Œë¦¼</h3>
                <p>ê²°ì¬ ì„œë¥˜ ìŠ¹ì¸ ìš”ì²­ê³¼ ì•Œë¦¼ì„ í™•ì¸í•˜ì„¸ìš”. ëŒ€ê¸° ì¤‘ì¸ ìŠ¹ì¸ ê±´ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            -->
            
            <!-- ì¬ê³ ê´€ë¦¬ ì¹´ë“œëŠ” ê¸°ëŠ¥ ë¯¸êµ¬í˜„ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬
            <div class="menu-card" onclick="openInventoryManagement()">
                <div class="menu-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <i class="fas fa-boxes"></i>
                </div>
                <h3>ì¬ê³ ê´€ë¦¬</h3>
                <p>ì¬ê³  í˜„í™©ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. ì…ì¶œê³  ë‚´ì—­ê³¼ ì¬ê³  ìˆ˜ì¤€ì„ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            -->
            
            <div class="menu-card" onclick="openDocuments()">
                <div class="menu-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <h3>ê²°ì œ ì„œë¥˜</h3>
                <p>ì‚¬ì§ì„œ, ê²½ìœ„ì„œ, ì¬ì§ì¦ëª…ì„œ ë“± ê°ì¢… ê²°ì¬ ì„œë¥˜ë¥¼ ì‘ì„±í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.</p>
            </div>
            
            <div id="documentApprovalCard" class="menu-card" onclick="openDocumentApproval()">
                <div class="menu-icon" style="position: relative; background: linear-gradient(135deg, #10b981, #059669);">
                    <i class="fas fa-clipboard-check"></i>
                    <span id="documentApprovalBadge" class="notification-badge" style="display: none;">0</span>
                </div>
                <h3>ì„œë¥˜ ìŠ¹ì¸</h3>
                <p>ì§ì›ë“¤ì´ ì œì¶œí•œ ê²°ì¬ ì„œë¥˜ë¥¼ ê²€í† í•˜ê³  ìŠ¹ì¸ ì²˜ë¦¬í•˜ì„¸ìš”.</p>
            </div>
        </div>
        
        <!-- ë¹ ë¥¸ í†µê³„ -->
        <div class="stats-section">
            <div class="stats-header">
                <h2>ì´ë²ˆ ë‹¬ í˜„í™©</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="workLogCount">0</div>
                    <div class="stat-label">ì‘ì„±í•œ ì—…ë¬´ì¼ì§€</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="projectCount">0</div>
                    <div class="stat-label">ì‘ì„±í•œ ì„œë¥˜</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cardUsageCount">0</div>
                    <div class="stat-label">ë²•ì¸ì¹´ë“œ ì‚¬ìš©</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="clientCount">0</div>
                    <div class="stat-label">ê´€ë¦¬ ê±°ë˜ì²˜</div>
                </div>
            </div>
        </div>
        
        <!-- ìµœê·¼ í™œë™ -->
        <div class="activity-section">
            <div class="activity-header">
                <h2>ìµœê·¼ í™œë™</h2>
            </div>
            <div class="activity-list" id="activityList">
                <!-- ìµœê·¼ í™œë™ í•­ëª©ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </main>
    
    <script src="../../shared-assets/js/auth.js"></script>
    <script>
        // ê¸°ë³¸ ì•„ë°”íƒ€ ìƒì„± í•¨ìˆ˜
        function generateDefaultAvatar(name) {
            const initial = name ? name.charAt(0).toUpperCase() : 'U';
            // í•œê¸€ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬ë¥¼ ìœ„í•´ ì˜ë¬¸ìë§Œ ì‚¬ìš©
            const safeInitial = /^[A-Za-z]/.test(initial) ? initial : 'U';
            
            // btoa ëŒ€ì‹  ì§ì ‘ SVG URL ìƒì„±
            const svgContent = `<svg width="50" height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                <circle cx="25" cy="25" r="25" fill="#667eea"/>
                <text x="25" y="32" font-family="Arial, sans-serif" font-size="20" fill="white" text-anchor="middle" dominant-baseline="central">${safeInitial}</text>
            </svg>`;
            
            return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgContent)}`;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        document.addEventListener('DOMContentLoaded', async function() {
            // ë¨¼ì € getCurrentUserFromDB í•¨ìˆ˜ë¡œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            let user = await getCurrentUserFromDB();
            console.log('ğŸ§ª getCurrentUserFromDBì—ì„œ ê°€ì ¸ì˜¨ ì‚¬ìš©ì ì •ë³´:', user);
            console.log('ğŸ§ª ì‚¬ìš©ì ì—­í• :', user?.role);
            
            // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©ìë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° AuthManager í™•ì¸
            if (!user) {
                user = AuthManager.getCurrentUser();
                console.log('ğŸ§ª AuthManagerì—ì„œ ê°€ì ¸ì˜¨ ì‚¬ìš©ì ì •ë³´:', user);
            }
            
            // ì—¬ì „íˆ ì‚¬ìš©ìê°€ ì—†ëŠ” ê²½ìš°, 5ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„
            if (!user) {
                console.log('â° ì‚¬ìš©ì ì •ë³´ ì—†ìŒ, 5ì´ˆ í›„ ì¬ì‹œë„...');
                setTimeout(async () => {
                    const retryUser = await getCurrentUserFromDB();
                    if (!retryUser) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = 'index.html';
                    } else {
                        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œ ì‹œì‘
                        window.location.reload();
                    }
                }, 5000);
                return;
            }

            // getCurrentUserFromDBê°€ ì´ë¯¸ ìµœì‹  ì •ë³´ë¥¼ ê°€ì ¸ì™”ìœ¼ë¯€ë¡œ ì¶”ê°€ ì¡°íšŒ ë¶ˆí•„ìš”

            // ë°˜ë ¤ëœ ì‚¬ìš©ì ì²˜ë¦¬
            if (!user.is_active && user.rejection_reason) {
                alert(`ê³„ì •ì´ ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‚¬ìœ : ${user.rejection_reason}\n\në¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ê´€ë¦¬ìì—ê²Œ ì—°ë½í•´ì£¼ì„¸ìš”.`);
                sessionStorage.clear();
                window.location.href = 'index.html';
                return;
            }
            
            // ì‚¬ìš©ìë³„ í™˜ì˜ ë©”ì‹œì§€ ì„¤ì •
            let welcomeMessage = '';
            let infoText = '';
            
            // roleì´ nullì´ê±°ë‚˜ undefinedì¸ ê²½ìš°ì—ë§Œ ë¯¸ìŠ¹ì¸ ìƒíƒœë¡œ ì²˜ë¦¬
            if (!user.role) {
                welcomeMessage = user.name;
                infoText = 'â³ ê³„ì • ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ê´€ë¦¬ìì˜ ìŠ¹ì¸ í›„ ì‹œìŠ¤í…œì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            } else {
                switch(user.role) {
                    case 'master':
                        welcomeMessage = user.name || 'ë§ˆìŠ¤í„°'; // ë§ˆìŠ¤í„°
                        infoText = 'ë§ˆìŠ¤í„° ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•˜ì…¨ìŠµë‹ˆë‹¤.';
                        break;
                    case 'master_admin':
                        welcomeMessage = user.name || 'ì‹œìŠ¤í…œ ê´€ë¦¬ì';
                        infoText = 'ì‹œìŠ¤í…œ ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸í•˜ì…¨ìŠµë‹ˆë‹¤.';
                        break;
                    case 'company_admin':
                        welcomeMessage = user.name;
                        // positionê³¼ companyê°€ ì‹¤ì œë¡œ ìˆì„ ë•Œë§Œ í‘œì‹œ
                        if (user.position && user.company) {
                            infoText = `${user.position} Â· ${user.company}`;
                        } else if (user.position) {
                            infoText = user.position;
                        } else if (user.company) {
                            infoText = user.company;
                        } else {
                            infoText = 'íšŒì‚¬ ê´€ë¦¬ì';
                        }
                        break;
                    case 'company_manager':
                        welcomeMessage = user.name;
                        infoText = 'ê´€ë¦¬ì';
                        break;
                    case 'employee':
                        welcomeMessage = user.name;
                        // ë¶€ì„œëª…, ì§ì±…ì´ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì„¤ì •
                        if (user.department && user.position) {
                            infoText = `${user.department} ${user.position}`;
                        } else if (user.department) {
                            infoText = user.department;
                        } else if (user.position) {
                            infoText = user.position;
                        } else {
                            infoText = '';
                        }
                        break;
                    default:
                        welcomeMessage = user.name;
                        infoText = '';
                }
            }
            
            document.getElementById('userName').textContent = welcomeMessage;
            document.getElementById('userInfo').textContent = infoText;
            
            // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •
            const profileImage = user.profileImage || user.profile_image || generateDefaultAvatar(user.name || 'User');
            const dashboardImage = document.getElementById('profileImageDashboard');
            if (dashboardImage) {
                dashboardImage.src = profileImage;
            }
            
            // íšŒì‚¬ëª…ì„ ë‚¨ê²½ìŠ¤í‹¸(ì£¼)ë¡œ í•˜ë“œì½”ë”©
            document.getElementById('pageTitle').textContent = 'ë‚¨ê²½ìŠ¤í‹¸(ì£¼) ì—…ë¬´ë³´ë“œ';
            document.title = 'ë‚¨ê²½ìŠ¤í‹¸(ì£¼) ì—…ë¬´ë³´ë“œ';
            
            
            // ì„¤ì • ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬ (roleì´ ì—†ê±°ë‚˜ employeeì¸ ê²½ìš° ìˆ¨ê¹€)
            console.log('ğŸ”§ ì„¤ì • ë²„íŠ¼ ì²˜ë¦¬ ì‹œì‘ - ì‚¬ìš©ì ì—­í• :', user.role);
            const settingsBtn = document.getElementById('settingsBtn');
            console.log('ğŸ”§ ì„¤ì • ë²„íŠ¼ ìš”ì†Œ:', settingsBtn);
            
            if (!user.role || user.role === 'employee') {
                console.log('ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ì/ì§ì› ê³„ì • í™•ì¸ë¨ - ì„¤ì • ë²„íŠ¼ ìˆ¨ê¹€ ì²˜ë¦¬');
                if (settingsBtn) {
                    settingsBtn.style.display = 'none'; // ë¯¸ìŠ¹ì¸ ì‚¬ìš©ìë‚˜ ì§ì›ì€ ì„¤ì • ë²„íŠ¼ ìˆ¨ê¹€
                    console.log('âœ… ì„¤ì • ë²„íŠ¼ ìˆ¨ê¹€ ì™„ë£Œ');
                } else {
                    console.log('âŒ ì„¤ì • ë²„íŠ¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
            } else {
                console.log('ğŸ‘‘ ê´€ë¦¬ì ê³„ì • í™•ì¸ë¨ - ì„¤ì • ë²„íŠ¼ í‘œì‹œ');
                if (settingsBtn) {
                    settingsBtn.style.display = 'flex'; // ê´€ë¦¬ìëŠ” ì„¤ì • ë²„íŠ¼ ë³´ì´ê¸°
                    console.log('âœ… ì„¤ì • ë²„íŠ¼ í‘œì‹œ ì™„ë£Œ');
                }
            }
            
            // ì§ì›ì´ë‚˜ í™ˆí˜ì´ì§€ ê´€ë¦¬ìì˜ ê²½ìš° ê±°ë˜ì²˜ëª©ë¡ ìˆ¨ê¸°ê¸°
            if (user.role === 'employee' || user.role === 'company_manager') {
                const clientListCard = document.getElementById('clientListCard');
                if (clientListCard) {
                    clientListCard.style.display = 'none';
                }
            }
            
            // ìŠ¹ì¸ë˜ì§€ ì•Šì€ ì§ì›ì—ê²Œ ë©”ì‹œì§€ í‘œì‹œ
            if (user.role === 'employee' && (!user.is_approved && user.is_approved !== true)) {
                // ë¯¸ìŠ¹ì¸ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
                const infoElement = document.getElementById('userInfo');
                if (infoElement) {
                    infoElement.innerHTML = `<span style="color: #ff6b6b; font-weight: 600;">â³ ê³„ì • ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ê´€ë¦¬ìì˜ ìŠ¹ì¸ í›„ ì‹œìŠ¤í…œì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>`;
                }
            }
            
            // ì§ì›ë³„ ë©”ë‰´ ê¶Œí•œ ì ìš©
            applyMenuPermissions(user);
            
            // ë™ì  í†µê³„ ë° í™œë™ ë¡œë“œ
            loadUserStatistics(user);
            loadRecentActivities(user);
            
            // ì•Œë¦¼ ì²´í¬
            checkNotifications(user);
            checkApprovalNotifications(user);
            
            // ê´€ë¦¬ìì¸ ê²½ìš° ì„œë¥˜ ìŠ¹ì¸ ì¹´ë“œê°€ ìˆ¨ê²¨ì§€ì§€ ì•Šë„ë¡ ìµœì¢… ë³´ì¥
            if (user.role === 'master' || user.role === 'master_admin' || user.role === 'company_CEO' || user.role === 'company_admin' || user.role === 'company_manager') {
                // ì¦‰ì‹œ ì‹¤í–‰
                ensureDocumentApprovalCardVisible();
                
                // ê°ì‹œì ì‹œì‘
                startDocumentApprovalCardObserver();
                
                // 100ms í›„ ë‹¤ì‹œ ì‹¤í–‰
                setTimeout(() => {
                    ensureDocumentApprovalCardVisible();
                }, 100);
                
                // 500ms í›„ ë‹¤ì‹œ ì‹¤í–‰
                setTimeout(() => {
                    ensureDocumentApprovalCardVisible();
                }, 500);
                
                // 1ì´ˆ í›„ ë‹¤ì‹œ ì‹¤í–‰
                setTimeout(() => {
                    ensureDocumentApprovalCardVisible();
                }, 1000);
                
                // 5ì´ˆ í›„ ë‹¤ì‹œ ì‹¤í–‰ (ë§ˆì§€ë§‰ ë³´ì¥)
                setTimeout(() => {
                    ensureDocumentApprovalCardVisible();
                }, 5000);
            }
        });
        
        // ì„œë¥˜ ìŠ¹ì¸ ì¹´ë“œ í‘œì‹œ ë³´ì¥ í•¨ìˆ˜
        function ensureDocumentApprovalCardVisible() {
            const documentApprovalCard = document.getElementById('documentApprovalCard');
            if (documentApprovalCard) {
                documentApprovalCard.style.display = 'flex';
                documentApprovalCard.style.flexDirection = 'column';
                documentApprovalCard.style.visibility = 'visible';
                documentApprovalCard.style.opacity = '1';
                documentApprovalCard.style.position = 'relative';
                documentApprovalCard.style.zIndex = '1';
                console.log('ğŸ”’ ì„œë¥˜ ìŠ¹ì¸ ì¹´ë“œ í‘œì‹œ ë³´ì¥ ì™„ë£Œ');
            } else {
                console.error('âŒ ì„œë¥˜ ìŠ¹ì¸ ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
        }
        
        // ì„œë¥˜ ìŠ¹ì¸ ì¹´ë“œ ê°ì‹œì (MutationObserver)
        let isUpdatingStyle = false; // ë¬´í•œ ë£¨í”„ ë°©ì§€ í”Œë˜ê·¸
        function startDocumentApprovalCardObserver() {
            const documentApprovalCard = document.getElementById('documentApprovalCard');
            if (!documentApprovalCard) return;
            
            const observer = new MutationObserver(function(mutations) {
                if (isUpdatingStyle) return; // ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ ì¤‘ì´ë©´ ë¬´ì‹œ
                
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const currentStyle = documentApprovalCard.style.display;
                        if (currentStyle === 'none' || currentStyle === 'hidden') {
                            console.log('ğŸš¨ ì„œë¥˜ ìŠ¹ì¸ ì¹´ë“œê°€ ìˆ¨ê²¨ì§ ê°ì§€ - ë³µì› ì¤‘');
                            isUpdatingStyle = true; // í”Œë˜ê·¸ ì„¤ì •
                            ensureDocumentApprovalCardVisible();
                            setTimeout(() => { isUpdatingStyle = false; }, 100); // í”Œë˜ê·¸ í•´ì œ
                        }
                    }
                });
            });
            
            observer.observe(documentApprovalCard, {
                attributes: true,
                attributeFilter: ['style']
            });
            
            console.log('ğŸ‘€ ì„œë¥˜ ìŠ¹ì¸ ì¹´ë“œ ê°ì‹œì ì‹œì‘');
        }
        
        // ë©”ë‰´ ê¸°ëŠ¥ë“¤
        
        function openWorkLog() {
            showLoading();
            setTimeout(() => {
                // ì—…ë¬´ì¼ì§€ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'worklog.html';
            }, 500);
        }
        
        
        function openCorporateCard() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'corporate-card-register.html';
            }, 500);
        }
        
        function openDocuments() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'documents.html';
            }, 500);
        }
        
        function openDocumentApproval() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'document-approval.html';
            }, 500);
        }
        
        function openApprovalNotifications() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'notifications.html';
            }, 500);
        }
        
        function openInventoryManagement() {
            showLoading();
            setTimeout(() => {
                alert('ì¬ê³ ê´€ë¦¬ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
                hideLoading();
            }, 500);
        }
        
        function openReports() {
            showLoading();
            setTimeout(() => {
                alert('ë³´ê³ ì„œ ì‘ì„± ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
                hideLoading();
            }, 500);
        }
        
        // í™ˆí˜ì´ì§€ë¡œ ì´ë™ (ë¡œê·¸ì¸ ì „ ìƒíƒœ)
        function goToHomepage() {
            // ê¸°ë³¸ í”Œë«í¼ í™ˆí˜ì´ì§€ë¡œ ì´ë™
            window.location.href = 'index.html';
        }
        
        // ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™
        function goToSettings() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'admin-dashboard.html';
            }, 500);
        }
        
        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        function handleLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì‚­ì œ
                sessionStorage.clear();
                
                // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = 'index.html';
            }
        }
        
        // ì§ì›ë³„ ë©”ë‰´ ê¶Œí•œ ì ìš© (ìƒˆë¡œìš´ ê¶Œí•œ ì‹œìŠ¤í…œ)
        function applyMenuPermissions(user) {
            console.log('ğŸ”§ applyMenuPermissions ì‹œì‘ - ì‚¬ìš©ì:', user.name, 'ì—­í• :', user.role);
            
            // ë§ˆìŠ¤í„° ë˜ëŠ” ê´€ë¦¬ì ê¶Œí•œì´ ìˆìœ¼ë©´ ëª¨ë“  ë©”ë‰´ í‘œì‹œ
            if (user.role === 'master' || user.role === 'master_admin' || user.role === 'company_CEO' || user.role === 'company_admin' || user.role === 'company_manager') {
                console.log('ğŸ‘‘ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ë¨ - ëª¨ë“  ë©”ë‰´ í‘œì‹œ ì‹œì‘');
                const menuCards = document.querySelectorAll('.menu-card');
                console.log('ğŸ“‹ ì°¾ì€ ë©”ë‰´ ì¹´ë“œ ìˆ˜:', menuCards.length);
                
                menuCards.forEach((card, index) => {
                    const h3 = card.querySelector('h3');
                    const menuTitle = h3 ? h3.textContent : 'Unknown';
                    console.log(`ğŸ“‹ ë©”ë‰´ ì¹´ë“œ ${index + 1}: ${menuTitle} - í‘œì‹œ ì¤‘`);
                    
                    card.style.display = 'flex'; // Grid ì•„ì´í…œì— ì í•©í•œ display ê°’ ì‚¬ìš©
                    card.style.flexDirection = 'column'; // ì¹´ë“œ ë‚´ë¶€ ë ˆì´ì•„ì›ƒ ìœ ì§€
                    card.style.visibility = 'visible'; // ê°€ì‹œì„± ê°•ì œ ì„¤ì •
                    card.style.opacity = '1'; // íˆ¬ëª…ë„ ê°•ì œ ì„¤ì •
                    
                    // ì„œë¥˜ ìŠ¹ì¸ ì¹´ë“œëŠ” íŠ¹ë³„íˆ ë” ê°•ë ¥í•˜ê²Œ ë³´í˜¸
                    if (menuTitle === 'ì„œë¥˜ ìŠ¹ì¸') {
                        card.setAttribute('data-admin-protected', 'true');
                        console.log('ğŸ”’ ì„œë¥˜ ìŠ¹ì¸ ì¹´ë“œ ê´€ë¦¬ì ë³´í˜¸ ì„¤ì • ì™„ë£Œ');
                    }
                });
                
                console.log('âœ… ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ëª¨ë“  ë©”ë‰´ í‘œì‹œ ì™„ë£Œ:', {
                    user: user.name,
                    role: user.role,
                    department: user.department,
                    position: user.position
                });
                return;
            }
            
            // ì¼ë°˜ ì§ì›ì˜ ê²½ìš° ìŠ¹ì¸ ìƒíƒœì— ë”°ë¼ ë©”ë‰´ í‘œì‹œ
            console.log('ğŸ‘¤ ì¼ë°˜ ì§ì› ê¶Œí•œ ì²˜ë¦¬ ì‹œì‘');
            const menuCards = document.querySelectorAll('.menu-card');
            menuCards.forEach(card => {
                // ê´€ë¦¬ì ë³´í˜¸ëœ ì¹´ë“œëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
                if (card.getAttribute('data-admin-protected') === 'true') {
                    console.log('ğŸ”’ ê´€ë¦¬ì ë³´í˜¸ëœ ì¹´ë“œ ê±´ë„ˆë›°ê¸°');
                    return;
                }
                
                const h3 = card.querySelector('h3');
                if (h3) {
                    const menuTitle = h3.textContent;
                    
                    // ìŠ¹ì¸ë˜ì§€ ì•Šì€ ì§ì›ì€ ëª¨ë“  ì—…ë¬´ ë©”ë‰´ ìˆ¨ê¹€
                    if (!user.is_approved && user.is_approved !== true) {
                        if (menuTitle.includes('ì—…ë¬´ì¼ì§€') || 
                            menuTitle.includes('ë²•ì¸ì¹´ë“œ') || 
                            menuTitle.includes('ê²°ì œ ì„œë¥˜')) {
                            card.style.display = 'none';
                        } else {
                            card.style.display = 'none';
                        }
                    } else {
                        // ìŠ¹ì¸ëœ ì§ì›ì´ ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë©”ë‰´ë“¤
                        if (menuTitle.includes('ì—…ë¬´ì¼ì§€') || 
                            menuTitle.includes('ë²•ì¸ì¹´ë“œ') || 
                            menuTitle.includes('ê²°ì œ ì„œë¥˜')) {
                            card.style.display = 'flex'; // Grid ì•„ì´í…œì— ì í•©í•œ display ê°’ ì‚¬ìš©
                            card.style.flexDirection = 'column'; // ì¹´ë“œ ë‚´ë¶€ ë ˆì´ì•„ì›ƒ ìœ ì§€
                        } else {
                            card.style.display = 'none';
                        }
                    }
                }
            });
            
            // ê°„ì†Œí™”ëœ ë©”ë‰´ ê¶Œí•œ ì²˜ë¦¬ (localStorage ì œê±°)
            console.log('âœ… ê¸°ë³¸ ì—­í•  ê¸°ë°˜ ë©”ë‰´ ê¶Œí•œ ì ìš©:', {
                user: user.name,
                role: user.role,
                department: user.department,
                position: user.position
            });
        }
        

        // ë¡œë”© í™”ë©´ í‘œì‹œ/ìˆ¨ê¹€
        function showLoading() {
            document.getElementById('loadingScreen').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingScreen').classList.remove('active');
        }
        
        // ì‚¬ìš©ì í†µê³„ ë¡œë“œ (ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜)
        async function loadUserStatistics(user) {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // ì´ë²ˆ ë‹¬ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ë‚  ê³„ì‚°
            const startOfMonth = new Date(currentYear, currentMonth, 1);
            const endOfMonth = new Date(currentYear, currentMonth + 1, 0);
            
            let workLogCount = 0;
            let documentCount = 0;
            let cardUsageCount = 0;
            let clientCount = 0;
            
            try {
                // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
                if (!window.db) {
                    console.warn('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    return;
                }
                
                await window.db.init();
                
                // 1. ì„œë¥˜ ì‘ì„± ì¹´ìš´íŠ¸ (ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ)
                try {
                    const { data: documents, error: docError } = await window.db.client
                        .from('document_requests')
                        .select('id')
                        .eq('requester_id', user.id)
                        .gte('created_at', startOfMonth.toISOString())
                        .lte('created_at', endOfMonth.toISOString());
                    
                    if (!docError && documents) {
                        documentCount = documents.length;
                    }
                } catch (error) {
                    console.error('ì„œë¥˜ ì¹´ìš´íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
                }
                
                // 2. ì—…ë¬´ì¼ì§€ ì¹´ìš´íŠ¸ (í–¥í›„ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì˜ˆì •)
                // í˜„ì¬ëŠ” ì—…ë¬´ì¼ì§€ ê¸°ëŠ¥ì´ ë³„ë„ í…Œì´ë¸”ë¡œ êµ¬í˜„ë˜ì§€ ì•Šì•„ 0ìœ¼ë¡œ ì„¤ì •
                workLogCount = 0;
                
                // 3. ë²•ì¸ì¹´ë“œ ì‚¬ìš© ì¹´ìš´íŠ¸ (í–¥í›„ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì˜ˆì •)
                // í˜„ì¬ëŠ” ë²•ì¸ì¹´ë“œ ì‚¬ìš© ê¸°ëŠ¥ì´ ë³„ë„ í…Œì´ë¸”ë¡œ êµ¬í˜„ë˜ì§€ ì•Šì•„ 0ìœ¼ë¡œ ì„¤ì •
                cardUsageCount = 0;
                
                // 4. ê´€ë¦¬ ê±°ë˜ì²˜ ì¹´ìš´íŠ¸ (í–¥í›„ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì˜ˆì •)
                // í˜„ì¬ëŠ” ê±°ë˜ì²˜ ê´€ë¦¬ ê¸°ëŠ¥ì´ ë³„ë„ í…Œì´ë¸”ë¡œ êµ¬í˜„ë˜ì§€ ì•Šì•„ 0ìœ¼ë¡œ ì„¤ì •
                clientCount = 0;
                
            } catch (error) {
                console.error('í†µê³„ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            }
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('workLogCount').textContent = workLogCount;
            document.getElementById('projectCount').textContent = documentCount;
            document.getElementById('cardUsageCount').textContent = cardUsageCount;
            document.getElementById('clientCount').textContent = clientCount;
            
            console.log('ğŸ“Š ì‚¬ìš©ì í†µê³„ ë¡œë“œ ì™„ë£Œ:', {
                workLogCount,
                documentCount,
                cardUsageCount,
                clientCount
            });
        }
        
        // ìµœê·¼ í™œë™ ë¡œë“œ (ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜)
        async function loadRecentActivities(user) {
            const activities = [];
            const currentDate = new Date();
            const oneMonthAgo = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, currentDate.getDate());
            
            try {
                // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
                if (!window.db) {
                    console.warn('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    return;
                }
                
                await window.db.init();
                
                // 1. ì„œë¥˜ ì‘ì„± í™œë™ (ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ)
                try {
                    const { data: documents, error: docError } = await window.db.client
                        .from('document_requests')
                        .select('*')
                        .eq('requester_id', user.id)
                        .gte('created_at', oneMonthAgo.toISOString())
                        .order('created_at', { ascending: false })
                        .limit(5);
                    
                    if (!docError && documents) {
                        documents.forEach(doc => {
                            const docTypeNames = {
                                'proposal': 'ê¸°ì•ˆì„œ',
                                'career': 'ê²½ë ¥ì¦ëª…ì„œ',
                                'employment': 'ì¬ì§ì¦ëª…ì„œ',
                                'leave': 'ì—°ì°¨ì‹ ì²­ì„œ',
                                'resignation': 'ì‚¬ì§ì„œ',
                                'incident': 'ê²½ìœ„ì„œ',
                                'business_trip': 'ì¶œì¥ë³´ê³ ì„œ'
                            };
                            
                            activities.push({
                                type: 'document',
                                icon: 'fas fa-file-invoice',
                                title: `${docTypeNames[doc.document_type] || doc.document_type} ì‘ì„± - ${doc.title}`,
                                date: new Date(doc.created_at),
                                originalData: doc
                            });
                        });
                    }
                } catch (error) {
                    console.error('ì„œë¥˜ í™œë™ ì¡°íšŒ ì˜¤ë¥˜:', error);
                }
                
                // 2. ê¸°íƒ€ í™œë™ë“¤ (í–¥í›„ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì˜ˆì •)
                // í˜„ì¬ëŠ” ì„œë¥˜ ì‘ì„± í™œë™ë§Œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•˜ê³ 
                // ì—…ë¬´ì¼ì§€, ë²•ì¸ì¹´ë“œ, ê±°ë˜ì²˜ ê¸°ëŠ¥ì€ ë³„ë„ í…Œì´ë¸”ë¡œ êµ¬í˜„ë˜ì§€ ì•Šì•„ ì œì™¸
                
            } catch (error) {
                console.error('í™œë™ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            }
            
            // ë‚ ì§œë³„ ì •ë ¬ (ìµœì‹ ìˆœ)
            activities.sort((a, b) => b.date - a.date);
            
            // ìµœëŒ€ 8ê°œ í™œë™ë§Œ í‘œì‹œ
            const recentActivities = activities.slice(0, 8);
            
            // í™œë™ ëª©ë¡ ì—…ë°ì´íŠ¸
            const activityList = document.getElementById('activityList');
            if (recentActivities.length === 0) {
                activityList.innerHTML = `
                    <div class="activity-item" style="text-align: center; padding: 2rem;">
                        <div style="color: #666; font-size: 1.1rem;">
                            <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                            ìµœê·¼ í•œ ë‹¬ê°„ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                `;
            } else {
                activityList.innerHTML = recentActivities.map(activity => {
                    const timeAgo = getTimeAgo(activity.date);
                    return `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="${activity.icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${activity.title}</div>
                                <div class="activity-time">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            console.log('ğŸ“ ìµœê·¼ í™œë™ ë¡œë“œ ì™„ë£Œ:', recentActivities.length, 'ê°œ í™œë™');
        }
        
        // ì‹œê°„ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜
        function getTimeAgo(date) {
            const now = new Date();
            const diffInMs = now - date;
            const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
            const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            const diffInWeeks = Math.floor(diffInDays / 7);
            
            if (diffInMinutes < 60) {
                return diffInMinutes <= 1 ? 'ë°©ê¸ˆ ì „' : `${diffInMinutes}ë¶„ ì „`;
            } else if (diffInHours < 24) {
                return `${diffInHours}ì‹œê°„ ì „`;
            } else if (diffInDays < 7) {
                return diffInDays === 1 ? 'ì–´ì œ' : `${diffInDays}ì¼ ì „`;
            } else if (diffInWeeks < 4) {
                return `${diffInWeeks}ì£¼ì¼ ì „`;
            } else {
                return date.toLocaleDateString('ko-KR');
            }
        }
        
        // ì•Œë¦¼ ì²´í¬ í•¨ìˆ˜ (ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜)
        async function checkNotifications(user) {
            // ê´€ë¦¬ìë‚˜ ëŒ€í‘œìë§Œ ì•Œë¦¼ ì²´í¬
            if (user.role === 'company_admin' || user.role === 'company_manager' || user.role === 'master') {
                try {
                    // ë²•ì¸ì¹´ë“œ ì•Œë¦¼ì€ í–¥í›„ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ì´ê´€ ì˜ˆì •
                    // í˜„ì¬ëŠ” ì„œë¥˜ ìŠ¹ì¸ ì•Œë¦¼ë§Œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒ
                    const badge = document.getElementById('cardNotificationBadge');
                    if (badge) {
                        badge.style.display = 'none';
                    }
                    
                    // ìš”ì²­ ì•Œë¦¼ ì²´í¬ ì¶”ê°€
                    await checkRequestNotifications(user);
                } catch (error) {
                    console.error('ì•Œë¦¼ ì²´í¬ ì˜¤ë¥˜:', error);
                }
            }
        }
        
        // ìŠ¹ì¸ ì•Œë¦¼ ì²´í¬ (ê°€ì… ì•Œë¦¼ í¬í•¨)
        async function checkApprovalNotifications(user) {
            try {
                console.log('ğŸ”” ì•Œë¦¼ ì²´í¬ ì‹œì‘ - í˜„ì¬ ì‚¬ìš©ì:', user);
                
                // ì„œë¥˜ ìŠ¹ì¸ ëŒ€ê¸° ê±´ìˆ˜ ì²´í¬
                let documentApprovalCount = 0;
                await checkDocumentApprovalNotifications(user);
                
                // ê´€ë¦¬ìì¸ ê²½ìš°ì—ë§Œ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ì ìˆ˜ë¥¼ ì²´í¬
                let pendingCount = 0;
                if (user.role === 'master' || user.role === 'company_CEO' || user.role === 'company_admin' || user.role === 'company_manager') {
                    console.log('ğŸ‘¤ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ë¨, ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì ì¡°íšŒ ì‹œì‘');
                    
                    // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ì ìˆ˜ ì¡°íšŒ
                    if (window.db && window.db.client) {
                        try {
                            const { data, error } = await window.db.client
                                .from('users')
                                .select('id, name, email, created_at')
                                .is('role', null)  // roleì´ nullì¸ ì‚¬ìš©ìë“¤ (ìŠ¹ì¸ ëŒ€ê¸°)
                                .eq('is_active', true);
                                
                            if (!error && data) {
                                pendingCount = data.length;
                                console.log('âœ… ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì ì¡°íšŒ ì™„ë£Œ:', pendingCount, 'ëª…');
                                console.log('ğŸ“‹ ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì ëª©ë¡:', data);
                                
                                // ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì ìˆ˜ë§Œ ì¹´ìš´íŠ¸ (localStorage ì œê±°)
                                if (pendingCount > 0) {
                                    console.log('âœ… ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì í™•ì¸:', pendingCount, 'ëª…');
                                    console.log('ğŸ“‹ ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì ëª©ë¡:', data);
                                }
                            } else {
                                console.error('âŒ ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì ì¡°íšŒ ì˜¤ë¥˜:', error);
                            }
                        } catch (error) {
                            console.error('âŒ ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì ì¡°íšŒ ì˜ˆì™¸:', error);
                        }
                    } else {
                        console.warn('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    }
                } else {
                    console.log('ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ì - ìŠ¹ì¸ ëŒ€ê¸° ì‚¬ìš©ì ì²´í¬ ê±´ë„ˆëœ€');
                }
                
                // ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ì ìˆ˜ë§Œ ì•Œë¦¼ìœ¼ë¡œ í‘œì‹œ (localStorage ì œê±°)
                const totalNotificationCount = pendingCount;
                
                const badge = document.getElementById('approvalNotificationBadge');
                const headerBadge = document.getElementById('approvalNotificationBadgeHeader');
                
                if (totalNotificationCount > 0) {
                    // ê¸°ì¡´ ì¹´ë“œ ë°°ì§€ (ìˆ¨ê²¨ì§„ ìƒíƒœ)
                    if (badge) {
                        badge.textContent = totalNotificationCount;
                        badge.style.display = 'flex';
                    }
                    
                    // í—¤ë” ë°°ì§€
                    if (headerBadge) {
                        headerBadge.textContent = totalNotificationCount;
                        headerBadge.style.display = 'flex';
                    }
                } else {
                    if (badge) badge.style.display = 'none';
                    if (headerBadge) headerBadge.style.display = 'none';
                }
                
                console.log('ğŸ”” ì•Œë¦¼ ì²´í¬ ì™„ë£Œ (ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜):', {
                    userName: user.name,
                    userId: user.id,
                    pendingUserCount: pendingCount,
                    totalDisplayCount: totalNotificationCount
                });
                
            } catch (error) {
                console.error('ì•Œë¦¼ ì²´í¬ ì˜¤ë¥˜:', error);
            }
        }

        // ì„œë¥˜ ìŠ¹ì¸ ì•Œë¦¼ ì²´í¬ í•¨ìˆ˜
        async function checkDocumentApprovalNotifications(user) {
            try {
                console.log('ğŸ“‹ ì„œë¥˜ ìŠ¹ì¸ ì•Œë¦¼ ì²´í¬ ì‹œì‘ - í˜„ì¬ ì‚¬ìš©ì:', user);
                
                // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” í™•ì¸
                if (!window.db) {
                    console.warn('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    return;
                }
                
                await window.db.init();
                
                // í˜„ì¬ ì‚¬ìš©ìê°€ ìŠ¹ì¸ìì¸ ì„œë¥˜ ìš”ì²­ ì¡°íšŒ
                const { data: pendingDocuments, error } = await window.db.client
                    .from('document_requests')
                    .select('*')
                    .eq('status', 'pending')
                    .or(`current_approver_id.eq.${user.id},approver_1_id.eq.${user.id},approver_2_id.eq.${user.id}`)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('âŒ ì„œë¥˜ ìŠ¹ì¸ ëŒ€ê¸° ê±´ìˆ˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
                    return;
                }
                
                const approvalCount = pendingDocuments ? pendingDocuments.length : 0;
                console.log('ğŸ“‹ ì„œë¥˜ ìŠ¹ì¸ ëŒ€ê¸° ê±´ìˆ˜:', approvalCount);
                
                // ì„œë¥˜ ìŠ¹ì¸ ë°°ì§€ ì—…ë°ì´íŠ¸
                const documentApprovalBadge = document.getElementById('documentApprovalBadge');
                if (documentApprovalBadge) {
                    if (approvalCount > 0) {
                        documentApprovalBadge.textContent = approvalCount;
                        documentApprovalBadge.style.display = 'flex';
                    } else {
                        documentApprovalBadge.style.display = 'none';
                    }
                }
                
                // í—¤ë” ì•Œë¦¼ ë°°ì§€ë„ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì•Œë¦¼ê³¼ í•©ì‚°)
                const headerBadge = document.getElementById('approvalNotificationBadgeHeader');
                if (headerBadge) {
                    const currentHeaderCount = parseInt(headerBadge.textContent) || 0;
                    const totalCount = currentHeaderCount + approvalCount;
                    if (totalCount > 0) {
                        headerBadge.textContent = totalCount;
                        headerBadge.style.display = 'flex';
                    }
                }
                
                console.log('âœ… ì„œë¥˜ ìŠ¹ì¸ ì•Œë¦¼ ì²´í¬ ì™„ë£Œ:', approvalCount, 'ê±´');
                
            } catch (error) {
                console.error('âŒ ì„œë¥˜ ìŠ¹ì¸ ì•Œë¦¼ ì²´í¬ ì˜¤ë¥˜:', error);
            }
        }
        
        // ìš”ì²­ ì•Œë¦¼ ì²´í¬ í•¨ìˆ˜ (ê²¬ì , ì¹´íƒˆë¡œê·¸, ê¸°ìˆ ì§€ì› ìš”ì²­)
        async function checkRequestNotifications(user) {
            try {
                console.log('ğŸ“‹ ìš”ì²­ ì•Œë¦¼ ì²´í¬ ì‹œì‘ - í˜„ì¬ ì‚¬ìš©ì:', user);
                
                if (!user || !['admin', 'company_admin'].includes(user.role)) {
                    console.log('ìš”ì²­ ì•Œë¦¼ ì²´í¬ ê¶Œí•œ ì—†ìŒ');
                    return;
                }
                
                // ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ ìˆ˜ ì¡°íšŒ
                const [quoteResult, catalogResult, technicalResult] = await Promise.all([
                    supabaseClient.from('quote_requests').select('id', { count: 'exact' }).eq('status', 'pending'),
                    supabaseClient.from('catalog_requests').select('id', { count: 'exact' }).eq('status', 'pending'),
                    supabaseClient.from('technical_support_requests').select('id', { count: 'exact' }).eq('status', 'pending')
                ]);
                
                const pendingQuotes = quoteResult.count || 0;
                const pendingCatalogs = catalogResult.count || 0;
                const pendingTechnical = technicalResult.count || 0;
                const totalPendingRequests = pendingQuotes + pendingCatalogs + pendingTechnical;
                
                console.log('ğŸ“‹ ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­:', {
                    ê²¬ì : pendingQuotes,
                    ì¹´íƒˆë¡œê·¸: pendingCatalogs,
                    ê¸°ìˆ ì§€ì›: pendingTechnical,
                    ì´í•©: totalPendingRequests
                });
                
                // í—¤ë” ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì•Œë¦¼ê³¼ í•©ì‚°)
                const headerBadge = document.getElementById('approvalNotificationBadgeHeader');
                if (headerBadge) {
                    // ê¸°ì¡´ ì•Œë¦¼ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                    const currentCount = parseInt(headerBadge.textContent) || 0;
                    const existingRequestCount = parseInt(headerBadge.dataset.requestCount || '0');
                    const otherNotifications = currentCount - existingRequestCount;
                    
                    const totalNotifications = otherNotifications + totalPendingRequests;
                    
                    if (totalNotifications > 0) {
                        headerBadge.textContent = totalNotifications;
                        headerBadge.style.display = 'block';
                        headerBadge.dataset.requestCount = totalPendingRequests;
                    } else {
                        headerBadge.style.display = 'none';
                        headerBadge.dataset.requestCount = '0';
                    }
                }
                
                // admin-dashboard.htmlì˜ ê²¬ì ìš”ì²­ ì¹´ë“œ ë°°ì§€ ì—…ë°ì´íŠ¸ (ìˆë‹¤ë©´)
                if (window.location.pathname.includes('admin-dashboard.html')) {
                    const requestBadge = document.getElementById('requestNotificationBadge');
                    if (requestBadge) {
                        if (totalPendingRequests > 0) {
                            requestBadge.style.display = 'flex';
                            requestBadge.querySelector('span').textContent = totalPendingRequests;
                        } else {
                            requestBadge.style.display = 'none';
                        }
                    }
                }
                
                console.log('âœ… ìš”ì²­ ì•Œë¦¼ ì²´í¬ ì™„ë£Œ:', totalPendingRequests, 'ê±´');
                
            } catch (error) {
                console.error('âŒ ìš”ì²­ ì•Œë¦¼ ì²´í¬ ì˜¤ë¥˜:', error);
            }
        }

        // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function getCurrentUserFromDB() {
            try {
                console.log('ğŸ” getCurrentUserFromDB ì‹œì‘');
                
                if (!window.db) {
                    console.warn('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    return null;
                }
                
                await window.db.init();
                console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œê·¸ì¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const loginInfo = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('ğŸ“‹ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ë¡œê·¸ì¸ ì •ë³´:', loginInfo);
                
                if (!loginInfo || (!loginInfo.email && !loginInfo.id)) {
                    console.error('âŒ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return null;
                }
                
                // Supabase users í…Œì´ë¸”ì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (ì´ë©”ì¼ ë˜ëŠ” IDë¡œ)
                let user, error;
                if (loginInfo.email && loginInfo.email !== 'null') {
                    // ì´ë©”ì¼ë¡œ ì¡°íšŒ (Google ë¡œê·¸ì¸) - is_active ì¡°ê±´ ì œê±°
                    console.log('ğŸ” ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ:', loginInfo.email);
                    const result = await window.db.client
                        .from('users')
                        .select('*')
                        .eq('email', loginInfo.email)
                        .single();
                    user = result.data;
                    error = result.error;
                    console.log('ğŸ“Š ì´ë©”ì¼ ì¡°íšŒ ê²°ê³¼:', { user, error });
                } else if (loginInfo.id) {
                    // IDë¡œ ì¡°íšŒ (ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì—ì„œ ì´ë©”ì¼ì´ ì—†ëŠ” ê²½ìš°) - is_active ì¡°ê±´ ì œê±°
                    console.log('ğŸ” IDë¡œ ì‚¬ìš©ì ì¡°íšŒ:', loginInfo.id);
                    const result = await window.db.client
                        .from('users')
                        .select('*')
                        .eq('id', loginInfo.id)
                        .single();
                    user = result.data;
                    error = result.error;
                    console.log('ğŸ“Š ID ì¡°íšŒ ê²°ê³¼:', { user, error });
                }
                
                if (error) {
                    console.error('âŒ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                    return null;
                }
                
                if (!user) {
                    console.error('âŒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return null;
                }
                
                console.log('âœ… ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì„±ê³µ:', user);
                
                // ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ sessionStorageì— ì €ì¥
                const updatedUser = {
                    id: user.id,
                    email: user.email,
                    name: user.name,
                    role: user.role,
                    department: user.department,
                    position: user.position,
                    company_domain: user.company_domain,
                    company_name: user.company_name,
                    profileImage: user.profile_image,
                    profile_image: user.profile_image,
                    oauth_id: user.oauth_id,
                    oauth_provider: user.oauth_provider,
                    provider: user.oauth_provider || 'email',
                    is_approved: user.is_approved,
                    is_active: user.is_active,
                    permissions: AuthManager.ROLE_PERMISSIONS[user.role] || AuthManager.ROLE_PERMISSIONS['employee']
                };
                sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
                sessionStorage.setItem('userRole', user.role);
                sessionStorage.setItem('userName', user.name);
                console.log('âœ… sessionStorage ì—…ë°ì´íŠ¸ ì™„ë£Œ:', updatedUser);
                
                return updatedUser;
            } catch (error) {
                console.error('âŒ getCurrentUserFromDB ì˜¤ë¥˜:', error);
                return null;
            }
        }

        // ê¸°ë³¸ ì•„ë°”íƒ€ ìƒì„± í•¨ìˆ˜
        function generateDefaultAvatar(name) {
            const initials = (name || 'U').substring(0, 2).toUpperCase();
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            // ë°°ê²½ìƒ‰ ì„¤ì •
            ctx.fillStyle = '#667eea';
            ctx.fillRect(0, 0, 100, 100);
            
            // í…ìŠ¤íŠ¸ ì„¤ì •
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initials, 50, 50);
            
            return canvas.toDataURL();
        }

        // ë‘ ë²ˆì§¸ DOMContentLoadedëŠ” ì œê±° (ì²« ë²ˆì§¸ì— í†µí•©ë¨)
    </script>

    <!-- í”„ë¡œí•„ ëª¨ë‹¬ -->
    <div class="modal" id="profileModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>í”„ë¡œí•„ ì„¤ì •</h2>
                <button class="close-btn" onclick="hideProfileModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="profile-section">
                    <div class="profile-image-section">
                        <div class="current-profile-image">
                            <img id="modalProfileImage" src="" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" />
                        </div>
                        <div class="profile-image-upload">
                            <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageUpload(event)">
                            <button type="button" onclick="document.getElementById('profileImageInput').click()">ì´ë¯¸ì§€ ë³€ê²½</button>
                        </div>
                    </div>
                    
                    <form id="profileForm">
                        <div class="form-group">
                            <label>ì´ë¦„</label>
                            <input type="text" id="profileUserName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <div class="form-group">
                            <label>ì´ë©”ì¼</label>
                            <input type="email" id="profileUserEmail" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <div class="form-group">
                            <label>ë¶€ì„œ</label>
                            <input type="text" id="profileUserDepartment" placeholder="ë¶€ì„œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <div class="form-group">
                            <label>ì§ì±…</label>
                            <input type="text" id="profileUserPosition" placeholder="ì§ì±…ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <div class="form-group">
                            <label>ì—°ë½ì²˜</label>
                            <input type="tel" id="profileUserPhone" placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        
                        <button type="submit" class="btn-save-profile">í”„ë¡œí•„ ì €ì¥</button>
                    </form>
                </div>
                
                <div class="password-section">
                    <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                    <form id="passwordChangeForm">
                        <div class="form-group">
                            <label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        
                        <div class="form-group">
                            <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="newPassword" required minlength="6">
                        </div>
                        
                        <div class="form-group">
                            <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        
                        <button type="submit" class="btn-change-password">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    </form>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="handleLogout()" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
                <button onclick="hideProfileModal()" class="btn-close">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <style>
        /* í”„ë¡œí•„ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .profile-image-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .current-profile-image img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            margin-bottom: 15px;
        }
        
        .profile-image-upload button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group input[readonly] {
            background: #f5f5f5;
        }
        
        .btn-save-profile {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        
        .btn-save-profile:hover {
            background: #5a6fd8;
        }
        
        .password-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .password-section h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .btn-change-password {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .btn-change-password:hover {
            background: #218838;
        }
        
        .modal-footer {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        
        .btn-logout {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-logout:hover {
            background: #c82333;
        }
        
        .btn-close {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .btn-close:hover {
            background: #545b62;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 15px;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        /* í”„ë¡œí•„ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .user-profile-dashboard {
            position: relative;
            display: inline-block;
        }
        
        .user-profile-dashboard:hover img {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .user-profile-dashboard img {
            width: 50px !important;
            height: 50px !important;
            min-width: 50px !important;
            min-height: 50px !important;
            max-width: 50px !important;
            max-height: 50px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            display: block !important;
            cursor: pointer !important;
            border: 2px solid #fff !important;
            transition: all 0.3s ease !important;
        }
    </style>

    <script>
        // í”„ë¡œí•„ ëª¨ë‹¬ í‘œì‹œ (ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜)
        async function showProfileModal() {
            const currentUser = await getCurrentUserFromDB();
            if (!currentUser) return;
            
            // í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •
            const modalProfileImage = document.getElementById('modalProfileImage');
            if (currentUser.profile_image || currentUser.profileImage) {
                modalProfileImage.src = currentUser.profile_image || currentUser.profileImage;
            } else {
                // ê¸°ë³¸ ì•„ë°”íƒ€ ìƒì„±
                modalProfileImage.src = generateDefaultAvatar(currentUser.name || currentUser.email);
            }
            
            // í”„ë¡œí•„ ì •ë³´ ì±„ìš°ê¸° (ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ ìµœì‹  ì •ë³´)
            document.getElementById('profileUserName').value = currentUser.name || '';
            document.getElementById('profileUserEmail').value = currentUser.email || '';
            document.getElementById('profileUserDepartment').value = currentUser.department || '';
            document.getElementById('profileUserPosition').value = currentUser.position || '';
            document.getElementById('profileUserPhone').value = currentUser.phone || '';
            
            document.getElementById('profileModal').style.display = 'flex';
        }
        
        // í”„ë¡œí•„ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
        function hideProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            // í¼ ì´ˆê¸°í™”
            document.getElementById('passwordChangeForm').reset();
        }
        
        
        // í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜)
        async function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // íŒŒì¼ í¬ê¸° ì œí•œ (2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 2MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ì´ë¯¸ì§€ íŒŒì¼ í™•ì¸
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageData = e.target.result;
                
                try {
                    const currentUser = await getCurrentUserFromDB();
                    if (!currentUser) {
                        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // ë°ì´í„°ë² ì´ìŠ¤ì— ì—…ë°ì´íŠ¸
                    if (window.db && window.db.client) {
                        try {
                            let updateResult;
                            if (currentUser.email) {
                                // ì´ë©”ì¼ë¡œ ì—…ë°ì´íŠ¸ (Google ì‚¬ìš©ì)
                                updateResult = await window.db.client
                                    .from('users')
                                    .update({ 
                                        profile_image: imageData,
                                        updated_at: new Date().toISOString()
                                    })
                                    .eq('email', currentUser.email)
                                    .select();
                            } else if (currentUser.id) {
                                // IDë¡œ ì—…ë°ì´íŠ¸ (ì¹´ì¹´ì˜¤ ì‚¬ìš©ì)
                                updateResult = await window.db.client
                                    .from('users')
                                    .update({ 
                                        profile_image: imageData,
                                        updated_at: new Date().toISOString()
                                    })
                                    .eq('id', currentUser.id)
                                    .select();
                            }
                            
                            const { data, error } = updateResult;
                                
                            if (error) {
                                console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                                alert('í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                return;
                            } else {
                                console.log('í”„ë¡œí•„ ì´ë¯¸ì§€ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                            }
                        } catch (dbError) {
                            console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜:', dbError);
                            alert('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            return;
                        }
                    }
                    
                    // UI ì—…ë°ì´íŠ¸
                    const modalProfileImage = document.getElementById('modalProfileImage');
                    const dashboardProfileImage = document.getElementById('profileImageDashboard');
                    
                    if (modalProfileImage) modalProfileImage.src = imageData;
                    if (dashboardProfileImage) dashboardProfileImage.src = imageData;
                    
                    // í—¤ë”ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€ë„ ì—…ë°ì´íŠ¸
                    const headerProfileImages = document.querySelectorAll('.user-profile-dashboard img');
                    headerProfileImages.forEach(img => {
                        img.src = imageData;
                    });
                    
                    alert('í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜:', error);
                    alert('í”„ë¡œí•„ ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }
        
        // í”„ë¡œí•„ ì €ì¥ (ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜)
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('profileUserName').value.trim();
            const email = document.getElementById('profileUserEmail').value.trim();
            const department = document.getElementById('profileUserDepartment').value.trim();
            const position = document.getElementById('profileUserPosition').value.trim();
            const phone = document.getElementById('profileUserPhone').value.trim();
            
            if (!name || !email) {
                alert('ì´ë¦„ê³¼ ì´ë©”ì¼ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }
            
            try {
                const currentUser = await getCurrentUserFromDB();
                if (!currentUser) {
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ë°ì´í„°ë² ì´ìŠ¤ì— ì—…ë°ì´íŠ¸
                if (window.db && window.db.client) {
                    let updateResult;
                    if (currentUser.email) {
                        // ì´ë©”ì¼ë¡œ ì—…ë°ì´íŠ¸ (Google ì‚¬ìš©ì)
                        updateResult = await window.db.client
                            .from('users')
                            .update({
                                name: name,
                                department: department,
                                position: position,
                                phone: phone,
                                updated_at: new Date().toISOString()
                            })
                            .eq('email', currentUser.email)
                            .select();
                    } else if (currentUser.id) {
                        // IDë¡œ ì—…ë°ì´íŠ¸ (ì¹´ì¹´ì˜¤ ì‚¬ìš©ì)
                        updateResult = await window.db.client
                            .from('users')
                            .update({
                                name: name,
                                department: department,
                                position: position,
                                phone: phone,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', currentUser.id)
                            .select();
                    }
                    
                    const { data, error } = updateResult;
                    
                    if (error) {
                        console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                        alert('í”„ë¡œí•„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    console.log('í”„ë¡œí•„ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                }
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                document.getElementById('userName').textContent = name;
                document.getElementById('userInfo').textContent = `${position || 'ì§ê¸‰'} | ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”.`;
                
                // í”„ë¡œí•„ ì´ë¯¸ì§€ë„ ì—…ë°ì´íŠ¸
                const profileImage = currentUser.profile_image || generateDefaultAvatar(name);
                const dashboardImage = document.getElementById('profileImageDashboard');
                if (dashboardImage) {
                    dashboardImage.src = profileImage;
                }
                
                alert('í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                hideProfileModal();
                
            } catch (error) {
                console.error('í”„ë¡œí•„ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('í”„ë¡œí•„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        document.getElementById('passwordChangeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
            this.reset();
        });
        
    </script>
</body>
</html>