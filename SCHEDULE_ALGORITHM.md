# 스케줄 생성 알고리즘 상세 문서

> 지역 블록 단위 배정 알고리즘 v4 (2026-01-04)
> ChatGPT Ultra Think + Claude 협업 설계

## 알고리즘 개요

철강 영업팀의 효율적인 방문 스케줄을 자동 생성하는 알고리즘입니다.
**같은 지역 업체를 연속된 날에 배정**하여 이동 시간을 최소화합니다.

## 핵심 로직 (4단계)

### 1. 지역별 그룹화
```
업체 → 지역(region) 기준으로 그룹화
각 그룹 내에서 last_visit_date 오름차순 정렬 (오래된 것 먼저)
```

### 2. 소수 지역 병합
```
업체 수 < min인 지역 → 가장 가까운 일반 지역에 흡수

예시: 경산(1개) + 경주(24개), min=4
→ 경산은 min 미만이므로 경주에 병합
→ 결과: 경주(25개)
```

**거리 계산**: Haversine 공식으로 지역 중심점(centroid) 간 거리 측정

### 3. 베이스캠프 거리 조정
```
베이스캠프: 부산광역시 사상구 (남경철강 본사)
좌표: 35.1547, 128.9914

거리별 하루 방문 수 조정:
- < 50km  : max 그대로 (김해, 양산)
- 50-100km: max - 1 (창원, 밀양)
- > 100km : max - 2 (포항, 경주, 대구)
```

**이유**: 먼 지역은 왕복 이동 시간이 길어 실제 방문 가능 업체 수가 줄어듦

### 4. 잔여 페널티 (균등 분배)
```
마지막 날에 min 미만이 남지 않도록 균등 분배

예시: 11개 업체, min=3, max=5
나쁜 분배: 5 + 5 + 1 (마지막 1개 < min)
좋은 분배: 6 + 5 (2일로 조정)
```

## 옵션별 설정값

| 옵션 | min | max | target | 용도 |
|------|-----|-----|--------|------|
| 1~3개 | 1 | 3 | 2 | 신규/VIP 집중 |
| 3~4개 | 3 | 4 | 3 | 일반 방문 |
| 4~5개 | 4 | 5 | 4 | 표준 영업 |
| 5~7개 | 5 | 7 | 6 | 밀집 지역 |

## 헬퍼 함수

### calculateRegionCentroid()
```javascript
// 지역 내 업체들의 중심점 계산
function calculateRegionCentroid(companies) {
  const validCoords = companies.filter(c => c.latitude && c.longitude);
  return {
    lat: 평균 위도,
    lng: 평균 경도
  };
}
```

### haversineDistance()
```javascript
// 두 좌표 간 거리 계산 (km)
function haversineDistance(lat1, lng1, lat2, lng2) {
  const R = 6371; // 지구 반경 (km)
  // Haversine 공식 적용
  return 거리(km);
}
```

## 알고리즘 흐름도

```
┌─────────────────────────────────────────────────┐
│ 1. 업체 목록 로드 + 필터 적용                   │
│    (색상, 지역, 검색어, Pre-flight 제외)         │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│ 2. 지역별 그룹화                                │
│    Map<region, companies[]>                     │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│ 3. 소수 지역 병합                               │
│    업체 수 < min → 가장 가까운 지역에 흡수       │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│ 4. 지역 우선순위 정렬                           │
│    가장 오래된 방문 업체가 있는 지역 먼저        │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│ 5. 베이스캠프 거리 계산 → max 조정              │
│    50km 초과: -1, 100km 초과: -2                │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│ 6. 잔여 페널티 계산 → 균등 분배                 │
│    마지막 날 min 미만 방지                      │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│ 7. 날짜별 배정 + 캘린더 렌더링                  │
└─────────────────────────────────────────────────┘
```

## 콘솔 로그 예시

```
📊 지역 블록 단위 알고리즘 v4: ChatGPT Ultra Think + Claude 협업
  총 업체: 25개
  옵션: min=4, max=5, target=4
  📍 소수 지역 병합: 1개 지역 (경산:1개)
    🔗 경산(1개) → 경주에 병합 (거리: 42km)
  지역 그룹 수: 1개
  🚗 경주: 베이스캠프에서 118km → max 5 → 3로 조정
  📊 경주: 25개 → 9일 분배 [3, 3, 3, 3, 3, 3, 3, 2, 2]
```

## Pre-flight 체크

스케줄 생성 전 좌표 없는 업체를 사전 확인합니다.

| 상태 | 설명 |
|------|------|
| 좌표 있음 | 정상 배정 대상 |
| 좌표 없음 | 제외 또는 수동 입력 필요 |

**주소 유형별 좌표 변환 가능 여부**:
- 도로명 주소: 변환 가능
- 지번 주소: 변환 가능
- 산 주소: 변환 불가 (제외 권장)

---
*최종 업데이트: 2026-01-04*
