<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">남경스틸(주) 업무보드</title>
    
    <!-- Favicons -->
    <link href="logo.jpg" rel="icon">
    <link href="logo.jpg" rel="apple-touch-icon">
    
    <link rel="stylesheet" href="shared-assets/css/main.css">
    <link rel="stylesheet" href="shared-assets/css/platform.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Database Scripts -->
    <script src="database.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f7fa;
            min-height: 100vh;
            font-family: 'Noto Sans KR', sans-serif;
        }
        
        /* 헤더 스타일 */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .welcome-section h1 {
            font-size: 2rem;
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }
        
        .welcome-section p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        
        .header-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .header-btn:hover {
            background: white;
            color: #667eea;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .logout-btn:hover {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        /* 메인 콘텐츠 */
        .dashboard-content {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 0 2rem;
        }
        
        /* 메뉴 그리드 */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .menu-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .menu-card:hover::before {
            transform: translateY(0);
        }
        
        .menu-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            color: white;
        }
        
        .menu-card h3 {
            font-size: 1.25rem;
            margin: 0 0 0.75rem 0;
            color: #333;
        }
        
        .menu-card p {
            color: #666;
            line-height: 1.6;
            margin: 0;
        }
        
        /* 빠른 통계 */
        .stats-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 3rem;
        }
        
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .stats-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-item:hover .stat-value {
            -webkit-text-fill-color: white;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .stat-item:hover .stat-label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* 최근 활동 */
        .activity-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .activity-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .activity-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .activity-time {
            font-size: 0.875rem;
            color: #666;
        }
        
        /* 알림 배지 */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        /* 헤더 알림 배지 */
        .notification-badge-header {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* 반응형 */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                text-align: center;
                gap: 1.5rem;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* 로딩 애니메이션 */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        /* 서류 승인 카드 강제 표시 */
        #documentApprovalCard[data-admin-protected="true"] {
            display: flex !important;
            flex-direction: column !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 로딩 화면 -->
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
    </div>
    
    <!-- 헤더 -->
    <header class="dashboard-header">
        <div class="header-container">
            <div class="welcome-section">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="user-profile-dashboard" onclick="showProfileModal()" style="cursor: pointer;">
                        <img id="profileImageDashboard" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyNSIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPu2yqTwvc3ZnPgo8L3N2Zz4=" alt="프로필" style="width: 50px !important; height: 50px !important; min-width: 50px; min-height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; transition: all 0.3s ease; object-fit: cover; display: block;" />
                    </div>
                    <div>
                        <h1><span id="userName">사용자</span>님, 환영합니다!</h1>
                        <p id="userInfo">오늘도 좋은 하루 되세요.</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <a href="#" class="header-btn" onclick="goToHomepage()">
                    <i class="fas fa-home"></i> 홈페이지
                </a>
                <button class="header-btn" id="approvalNotificationBtn" onclick="openApprovalNotifications()" style="position: relative;">
                    <i class="fas fa-bell"></i> 알림
                    <span id="approvalNotificationBadgeHeader" class="notification-badge-header" style="display: none;">0</span>
                </button>
                <button class="header-btn" id="settingsBtn" onclick="goToSettings()">
                    <i class="fas fa-cog"></i> 설정
                </button>
                <button class="header-btn logout-btn" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> 로그아웃
                </button>
            </div>
        </div>
    </header>
    
    <!-- 메인 콘텐츠 -->
    <main class="dashboard-content">
        <!-- 메뉴 그리드 -->
        <div class="menu-grid">
            <div class="menu-card" onclick="openWorkLog()">
                <div class="menu-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <h3>업무일지</h3>
                <p>오늘의 업무 내용을 기록하고 관리하세요. 프로젝트별 진행상황을 확인할 수 있습니다.</p>
            </div>
            
            
            <div class="menu-card" onclick="openCorporateCard()">
                <div class="menu-icon" style="position: relative;">
                    <i class="fas fa-credit-card"></i>
                    <span id="cardNotificationBadge" class="notification-badge" style="display: none;">0</span>
                </div>
                <h3>법인카드 사용</h3>
                <p>법인카드 사용 내역을 등록하고 관리하세요. 경비 처리 현황을 확인할 수 있습니다.</p>
            </div>
            
            <!-- 승인 알림 카드는 헤더 버튼으로 대체되어 숨김 처리
            <div class="menu-card" onclick="openApprovalNotifications()" style="display: none;">
                <div class="menu-icon" style="position: relative; background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                    <i class="fas fa-bell"></i>
                    <span id="approvalNotificationBadge" class="notification-badge" style="display: none;">0</span>
                </div>
                <h3>승인 알림</h3>
                <p>결재 서류 승인 요청과 알림을 확인하세요. 대기 중인 승인 건을 처리할 수 있습니다.</p>
            </div>
            -->
            
            <!-- 재고관리 카드는 기능 미구현으로 숨김 처리
            <div class="menu-card" onclick="openInventoryManagement()">
                <div class="menu-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <i class="fas fa-boxes"></i>
                </div>
                <h3>재고관리</h3>
                <p>재고 현황을 확인하고 관리하세요. 입출고 내역과 재고 수준을 모니터링할 수 있습니다.</p>
            </div>
            -->
            
            <div class="menu-card" onclick="openDocuments()">
                <div class="menu-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <h3>결제 서류</h3>
                <p>사직서, 경위서, 재직증명서 등 각종 결재 서류를 작성하고 관리하세요.</p>
            </div>
            
            <div id="documentApprovalCard" class="menu-card" onclick="openDocumentApproval()">
                <div class="menu-icon" style="position: relative; background: linear-gradient(135deg, #10b981, #059669);">
                    <i class="fas fa-clipboard-check"></i>
                    <span id="documentApprovalBadge" class="notification-badge" style="display: none;">0</span>
                </div>
                <h3>서류 승인</h3>
                <p>직원들이 제출한 결재 서류를 검토하고 승인 처리하세요.</p>
            </div>
        </div>
        
        <!-- 빠른 통계 -->
        <div class="stats-section">
            <div class="stats-header">
                <h2>이번 달 현황</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="workLogCount">0</div>
                    <div class="stat-label">작성한 업무일지</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="projectCount">0</div>
                    <div class="stat-label">작성한 서류</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cardUsageCount">0</div>
                    <div class="stat-label">법인카드 사용</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="clientCount">0</div>
                    <div class="stat-label">관리 거래처</div>
                </div>
            </div>
        </div>
        
        <!-- 최근 활동 -->
        <div class="activity-section">
            <div class="activity-header">
                <h2>최근 활동</h2>
            </div>
            <div class="activity-list" id="activityList">
                <!-- 최근 활동 항목들이 동적으로 추가됩니다 -->
            </div>
        </div>
    </main>
    
    <script src="../../shared-assets/js/auth.js"></script>
    <script>
        // 기본 아바타 생성 함수
        function generateDefaultAvatar(name) {
            const initial = name ? name.charAt(0).toUpperCase() : 'U';
            // 한글이나 특수문자 처리를 위해 영문자만 사용
            const safeInitial = /^[A-Za-z]/.test(initial) ? initial : 'U';
            
            // btoa 대신 직접 SVG URL 생성
            const svgContent = `<svg width="50" height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                <circle cx="25" cy="25" r="25" fill="#667eea"/>
                <text x="25" y="32" font-family="Arial, sans-serif" font-size="20" fill="white" text-anchor="middle" dominant-baseline="central">${safeInitial}</text>
            </svg>`;
            
            return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgContent)}`;
        }
        
        // 페이지 로드 시 사용자 정보 표시
        document.addEventListener('DOMContentLoaded', async function() {
            // 먼저 getCurrentUserFromDB 함수로 사용자 정보 가져오기
            let user = await getCurrentUserFromDB();
            console.log('🧪 getCurrentUserFromDB에서 가져온 사용자 정보:', user);
            console.log('🧪 사용자 역할:', user?.role);
            
            // 데이터베이스에서 사용자를 찾지 못한 경우 AuthManager 확인
            if (!user) {
                user = AuthManager.getCurrentUser();
                console.log('🧪 AuthManager에서 가져온 사용자 정보:', user);
            }
            
            // 여전히 사용자가 없는 경우, 5초 대기 후 재시도
            if (!user) {
                console.log('⏰ 사용자 정보 없음, 5초 후 재시도...');
                setTimeout(async () => {
                    const retryUser = await getCurrentUserFromDB();
                    if (!retryUser) {
                        alert('로그인이 필요합니다.');
                        window.location.href = 'index.html';
                    } else {
                        // 페이지 새로고침하여 다시 시작
                        window.location.reload();
                    }
                }, 5000);
                return;
            }

            // getCurrentUserFromDB가 이미 최신 정보를 가져왔으므로 추가 조회 불필요

            // 반려된 사용자 처리
            if (!user.is_active && user.rejection_reason) {
                alert(`계정이 반려되었습니다.\n사유: ${user.rejection_reason}\n\n문의사항이 있으시면 관리자에게 연락해주세요.`);
                sessionStorage.clear();
                window.location.href = 'index.html';
                return;
            }
            
            // 사용자별 환영 메시지 설정
            let welcomeMessage = '';
            let infoText = '';
            
            // role이 null이거나 undefined인 경우에만 미승인 상태로 처리
            if (!user.role) {
                welcomeMessage = user.name;
                infoText = '⏳ 계정 승인 대기 중입니다. 관리자의 승인 후 시스템을 이용할 수 있습니다.';
            } else {
                switch(user.role) {
                    case 'master':
                        welcomeMessage = user.name || '마스터'; // 마스터
                        infoText = '마스터 관리자로 로그인하셨습니다.';
                        break;
                    case 'master_admin':
                        welcomeMessage = user.name || '시스템 관리자';
                        infoText = '시스템 관리자로 로그인하셨습니다.';
                        break;
                    case 'company_admin':
                        welcomeMessage = user.name;
                        // position과 company가 실제로 있을 때만 표시
                        if (user.position && user.company) {
                            infoText = `${user.position} · ${user.company}`;
                        } else if (user.position) {
                            infoText = user.position;
                        } else if (user.company) {
                            infoText = user.company;
                        } else {
                            infoText = '회사 관리자';
                        }
                        break;
                    case 'company_manager':
                        welcomeMessage = user.name;
                        infoText = '관리자';
                        break;
                    case 'employee':
                        welcomeMessage = user.name;
                        // 부서명, 직책이 없으면 빈 문자열로 설정
                        if (user.department && user.position) {
                            infoText = `${user.department} ${user.position}`;
                        } else if (user.department) {
                            infoText = user.department;
                        } else if (user.position) {
                            infoText = user.position;
                        } else {
                            infoText = '';
                        }
                        break;
                    default:
                        welcomeMessage = user.name;
                        infoText = '';
                }
            }
            
            document.getElementById('userName').textContent = welcomeMessage;
            document.getElementById('userInfo').textContent = infoText;
            
            // 프로필 이미지 설정
            const profileImage = user.profileImage || user.profile_image || generateDefaultAvatar(user.name || 'User');
            const dashboardImage = document.getElementById('profileImageDashboard');
            if (dashboardImage) {
                dashboardImage.src = profileImage;
            }
            
            // 회사명을 남경스틸(주)로 하드코딩
            document.getElementById('pageTitle').textContent = '남경스틸(주) 업무보드';
            document.title = '남경스틸(주) 업무보드';
            
            
            // 설정 버튼 표시/숨김 처리 (role이 없거나 employee인 경우 숨김)
            console.log('🔧 설정 버튼 처리 시작 - 사용자 역할:', user.role);
            const settingsBtn = document.getElementById('settingsBtn');
            console.log('🔧 설정 버튼 요소:', settingsBtn);
            
            if (!user.role || user.role === 'employee') {
                console.log('👤 일반 사용자/직원 계정 확인됨 - 설정 버튼 숨김 처리');
                if (settingsBtn) {
                    settingsBtn.style.display = 'none'; // 미승인 사용자나 직원은 설정 버튼 숨김
                    console.log('✅ 설정 버튼 숨김 완료');
                } else {
                    console.log('❌ 설정 버튼 요소를 찾을 수 없음');
                }
            } else {
                console.log('👑 관리자 계정 확인됨 - 설정 버튼 표시');
                if (settingsBtn) {
                    settingsBtn.style.display = 'flex'; // 관리자는 설정 버튼 보이기
                    console.log('✅ 설정 버튼 표시 완료');
                }
            }
            
            // 직원이나 홈페이지 관리자의 경우 거래처목록 숨기기
            if (user.role === 'employee' || user.role === 'company_manager') {
                const clientListCard = document.getElementById('clientListCard');
                if (clientListCard) {
                    clientListCard.style.display = 'none';
                }
            }
            
            // 승인되지 않은 직원에게 메시지 표시
            if (user.role === 'employee' && (!user.is_approved && user.is_approved !== true)) {
                // 미승인 상태 메시지 표시
                const infoElement = document.getElementById('userInfo');
                if (infoElement) {
                    infoElement.innerHTML = `<span style="color: #ff6b6b; font-weight: 600;">⏳ 계정 승인 대기 중입니다. 관리자의 승인 후 시스템을 이용할 수 있습니다.</span>`;
                }
            }
            
            // 직원별 메뉴 권한 적용
            applyMenuPermissions(user);
            
            // 동적 통계 및 활동 로드
            loadUserStatistics(user);
            loadRecentActivities(user);
            
            // 알림 체크
            checkNotifications(user);
            checkApprovalNotifications(user);
            
            // 관리자인 경우 서류 승인 카드가 숨겨지지 않도록 최종 보장
            if (user.role === 'master' || user.role === 'master_admin' || user.role === 'company_CEO' || user.role === 'company_admin' || user.role === 'company_manager') {
                // 즉시 실행
                ensureDocumentApprovalCardVisible();
                
                // 감시자 시작
                startDocumentApprovalCardObserver();
                
                // 100ms 후 다시 실행
                setTimeout(() => {
                    ensureDocumentApprovalCardVisible();
                }, 100);
                
                // 500ms 후 다시 실행
                setTimeout(() => {
                    ensureDocumentApprovalCardVisible();
                }, 500);
                
                // 1초 후 다시 실행
                setTimeout(() => {
                    ensureDocumentApprovalCardVisible();
                }, 1000);
                
                // 5초 후 다시 실행 (마지막 보장)
                setTimeout(() => {
                    ensureDocumentApprovalCardVisible();
                }, 5000);
            }
        });
        
        // 서류 승인 카드 표시 보장 함수
        function ensureDocumentApprovalCardVisible() {
            const documentApprovalCard = document.getElementById('documentApprovalCard');
            if (documentApprovalCard) {
                documentApprovalCard.style.display = 'flex';
                documentApprovalCard.style.flexDirection = 'column';
                documentApprovalCard.style.visibility = 'visible';
                documentApprovalCard.style.opacity = '1';
                documentApprovalCard.style.position = 'relative';
                documentApprovalCard.style.zIndex = '1';
                console.log('🔒 서류 승인 카드 표시 보장 완료');
            } else {
                console.error('❌ 서류 승인 카드를 찾을 수 없음');
            }
        }
        
        // 서류 승인 카드 감시자 (MutationObserver)
        let isUpdatingStyle = false; // 무한 루프 방지 플래그
        function startDocumentApprovalCardObserver() {
            const documentApprovalCard = document.getElementById('documentApprovalCard');
            if (!documentApprovalCard) return;
            
            const observer = new MutationObserver(function(mutations) {
                if (isUpdatingStyle) return; // 스타일 업데이트 중이면 무시
                
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const currentStyle = documentApprovalCard.style.display;
                        if (currentStyle === 'none' || currentStyle === 'hidden') {
                            console.log('🚨 서류 승인 카드가 숨겨짐 감지 - 복원 중');
                            isUpdatingStyle = true; // 플래그 설정
                            ensureDocumentApprovalCardVisible();
                            setTimeout(() => { isUpdatingStyle = false; }, 100); // 플래그 해제
                        }
                    }
                });
            });
            
            observer.observe(documentApprovalCard, {
                attributes: true,
                attributeFilter: ['style']
            });
            
            console.log('👀 서류 승인 카드 감시자 시작');
        }
        
        // 메뉴 기능들
        
        function openWorkLog() {
            showLoading();
            setTimeout(() => {
                // 업무일지 페이지로 이동
                window.location.href = 'worklog.html';
            }, 500);
        }
        
        
        function openCorporateCard() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'corporate-card-register.html';
            }, 500);
        }
        
        function openDocuments() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'documents.html';
            }, 500);
        }
        
        function openDocumentApproval() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'document-approval.html';
            }, 500);
        }
        
        function openApprovalNotifications() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'notifications.html';
            }, 500);
        }
        
        function openInventoryManagement() {
            showLoading();
            setTimeout(() => {
                alert('재고관리 기능은 준비 중입니다.');
                hideLoading();
            }, 500);
        }
        
        function openReports() {
            showLoading();
            setTimeout(() => {
                alert('보고서 작성 기능은 준비 중입니다.');
                hideLoading();
            }, 500);
        }
        
        // 홈페이지로 이동 (로그인 전 상태)
        function goToHomepage() {
            // 기본 플랫폼 홈페이지로 이동
            window.location.href = 'index.html';
        }
        
        // 설정 페이지로 이동
        function goToSettings() {
            showLoading();
            setTimeout(() => {
                window.location.href = 'admin-dashboard.html';
            }, 500);
        }
        
        // 로그아웃 처리
        function handleLogout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                // 세션 스토리지 삭제
                sessionStorage.clear();
                
                // 로그인 페이지로 이동
                window.location.href = 'index.html';
            }
        }
        
        // 직원별 메뉴 권한 적용 (새로운 권한 시스템)
        function applyMenuPermissions(user) {
            console.log('🔧 applyMenuPermissions 시작 - 사용자:', user.name, '역할:', user.role);
            
            // 마스터 또는 관리자 권한이 있으면 모든 메뉴 표시
            if (user.role === 'master' || user.role === 'master_admin' || user.role === 'company_CEO' || user.role === 'company_admin' || user.role === 'company_manager') {
                console.log('👑 관리자 권한 확인됨 - 모든 메뉴 표시 시작');
                const menuCards = document.querySelectorAll('.menu-card');
                console.log('📋 찾은 메뉴 카드 수:', menuCards.length);
                
                menuCards.forEach((card, index) => {
                    const h3 = card.querySelector('h3');
                    const menuTitle = h3 ? h3.textContent : 'Unknown';
                    console.log(`📋 메뉴 카드 ${index + 1}: ${menuTitle} - 표시 중`);
                    
                    card.style.display = 'flex'; // Grid 아이템에 적합한 display 값 사용
                    card.style.flexDirection = 'column'; // 카드 내부 레이아웃 유지
                    card.style.visibility = 'visible'; // 가시성 강제 설정
                    card.style.opacity = '1'; // 투명도 강제 설정
                    
                    // 서류 승인 카드는 특별히 더 강력하게 보호
                    if (menuTitle === '서류 승인') {
                        card.setAttribute('data-admin-protected', 'true');
                        console.log('🔒 서류 승인 카드 관리자 보호 설정 완료');
                    }
                });
                
                console.log('✅ 관리자 권한으로 모든 메뉴 표시 완료:', {
                    user: user.name,
                    role: user.role,
                    department: user.department,
                    position: user.position
                });
                return;
            }
            
            // 일반 직원의 경우 승인 상태에 따라 메뉴 표시
            console.log('👤 일반 직원 권한 처리 시작');
            const menuCards = document.querySelectorAll('.menu-card');
            menuCards.forEach(card => {
                // 관리자 보호된 카드는 건드리지 않음
                if (card.getAttribute('data-admin-protected') === 'true') {
                    console.log('🔒 관리자 보호된 카드 건너뛰기');
                    return;
                }
                
                const h3 = card.querySelector('h3');
                if (h3) {
                    const menuTitle = h3.textContent;
                    
                    // 승인되지 않은 직원은 모든 업무 메뉴 숨김
                    if (!user.is_approved && user.is_approved !== true) {
                        if (menuTitle.includes('업무일지') || 
                            menuTitle.includes('법인카드') || 
                            menuTitle.includes('결제 서류')) {
                            card.style.display = 'none';
                        } else {
                            card.style.display = 'none';
                        }
                    } else {
                        // 승인된 직원이 기본적으로 사용할 수 있는 메뉴들
                        if (menuTitle.includes('업무일지') || 
                            menuTitle.includes('법인카드') || 
                            menuTitle.includes('결제 서류')) {
                            card.style.display = 'flex'; // Grid 아이템에 적합한 display 값 사용
                            card.style.flexDirection = 'column'; // 카드 내부 레이아웃 유지
                        } else {
                            card.style.display = 'none';
                        }
                    }
                }
            });
            
            // 간소화된 메뉴 권한 처리 (localStorage 제거)
            console.log('✅ 기본 역할 기반 메뉴 권한 적용:', {
                user: user.name,
                role: user.role,
                department: user.department,
                position: user.position
            });
        }
        

        // 로딩 화면 표시/숨김
        function showLoading() {
            document.getElementById('loadingScreen').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingScreen').classList.remove('active');
        }
        
        // 사용자 통계 로드 (데이터베이스 기반)
        async function loadUserStatistics(user) {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // 이번 달 첫날과 마지막날 계산
            const startOfMonth = new Date(currentYear, currentMonth, 1);
            const endOfMonth = new Date(currentYear, currentMonth + 1, 0);
            
            let workLogCount = 0;
            let documentCount = 0;
            let cardUsageCount = 0;
            let clientCount = 0;
            
            try {
                // 데이터베이스 초기화
                if (!window.db) {
                    console.warn('⚠️ 데이터베이스가 초기화되지 않음');
                    return;
                }
                
                await window.db.init();
                
                // 1. 서류 작성 카운트 (데이터베이스에서)
                try {
                    const { data: documents, error: docError } = await window.db.client
                        .from('document_requests')
                        .select('id')
                        .eq('requester_id', user.id)
                        .gte('created_at', startOfMonth.toISOString())
                        .lte('created_at', endOfMonth.toISOString());
                    
                    if (!docError && documents) {
                        documentCount = documents.length;
                    }
                } catch (error) {
                    console.error('서류 카운트 조회 오류:', error);
                }
                
                // 2. 업무일지 카운트 (향후 데이터베이스 연동 예정)
                // 현재는 업무일지 기능이 별도 테이블로 구현되지 않아 0으로 설정
                workLogCount = 0;
                
                // 3. 법인카드 사용 카운트 (향후 데이터베이스 연동 예정)
                // 현재는 법인카드 사용 기능이 별도 테이블로 구현되지 않아 0으로 설정
                cardUsageCount = 0;
                
                // 4. 관리 거래처 카운트 (향후 데이터베이스 연동 예정)
                // 현재는 거래처 관리 기능이 별도 테이블로 구현되지 않아 0으로 설정
                clientCount = 0;
                
            } catch (error) {
                console.error('통계 데이터 로드 중 오류:', error);
            }
            
            // 통계 업데이트
            document.getElementById('workLogCount').textContent = workLogCount;
            document.getElementById('projectCount').textContent = documentCount;
            document.getElementById('cardUsageCount').textContent = cardUsageCount;
            document.getElementById('clientCount').textContent = clientCount;
            
            console.log('📊 사용자 통계 로드 완료:', {
                workLogCount,
                documentCount,
                cardUsageCount,
                clientCount
            });
        }
        
        // 최근 활동 로드 (데이터베이스 기반)
        async function loadRecentActivities(user) {
            const activities = [];
            const currentDate = new Date();
            const oneMonthAgo = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, currentDate.getDate());
            
            try {
                // 데이터베이스 초기화
                if (!window.db) {
                    console.warn('⚠️ 데이터베이스가 초기화되지 않음');
                    return;
                }
                
                await window.db.init();
                
                // 1. 서류 작성 활동 (데이터베이스에서)
                try {
                    const { data: documents, error: docError } = await window.db.client
                        .from('document_requests')
                        .select('*')
                        .eq('requester_id', user.id)
                        .gte('created_at', oneMonthAgo.toISOString())
                        .order('created_at', { ascending: false })
                        .limit(5);
                    
                    if (!docError && documents) {
                        documents.forEach(doc => {
                            const docTypeNames = {
                                'proposal': '기안서',
                                'career': '경력증명서',
                                'employment': '재직증명서',
                                'leave': '연차신청서',
                                'resignation': '사직서',
                                'incident': '경위서',
                                'business_trip': '출장보고서'
                            };
                            
                            activities.push({
                                type: 'document',
                                icon: 'fas fa-file-invoice',
                                title: `${docTypeNames[doc.document_type] || doc.document_type} 작성 - ${doc.title}`,
                                date: new Date(doc.created_at),
                                originalData: doc
                            });
                        });
                    }
                } catch (error) {
                    console.error('서류 활동 조회 오류:', error);
                }
                
                // 2. 기타 활동들 (향후 데이터베이스 연동 예정)
                // 현재는 서류 작성 활동만 데이터베이스에서 조회하고
                // 업무일지, 법인카드, 거래처 기능은 별도 테이블로 구현되지 않아 제외
                
            } catch (error) {
                console.error('활동 데이터 로드 중 오류:', error);
            }
            
            // 날짜별 정렬 (최신순)
            activities.sort((a, b) => b.date - a.date);
            
            // 최대 8개 활동만 표시
            const recentActivities = activities.slice(0, 8);
            
            // 활동 목록 업데이트
            const activityList = document.getElementById('activityList');
            if (recentActivities.length === 0) {
                activityList.innerHTML = `
                    <div class="activity-item" style="text-align: center; padding: 2rem;">
                        <div style="color: #666; font-size: 1.1rem;">
                            <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                            최근 한 달간 활동 내역이 없습니다.
                        </div>
                    </div>
                `;
            } else {
                activityList.innerHTML = recentActivities.map(activity => {
                    const timeAgo = getTimeAgo(activity.date);
                    return `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="${activity.icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${activity.title}</div>
                                <div class="activity-time">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            console.log('📝 최근 활동 로드 완료:', recentActivities.length, '개 활동');
        }
        
        // 시간 차이 계산 함수
        function getTimeAgo(date) {
            const now = new Date();
            const diffInMs = now - date;
            const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
            const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            const diffInWeeks = Math.floor(diffInDays / 7);
            
            if (diffInMinutes < 60) {
                return diffInMinutes <= 1 ? '방금 전' : `${diffInMinutes}분 전`;
            } else if (diffInHours < 24) {
                return `${diffInHours}시간 전`;
            } else if (diffInDays < 7) {
                return diffInDays === 1 ? '어제' : `${diffInDays}일 전`;
            } else if (diffInWeeks < 4) {
                return `${diffInWeeks}주일 전`;
            } else {
                return date.toLocaleDateString('ko-KR');
            }
        }
        
        // 알림 체크 함수 (데이터베이스 기반)
        async function checkNotifications(user) {
            // 관리자나 대표자만 알림 체크
            if (user.role === 'company_admin' || user.role === 'company_manager' || user.role === 'master') {
                try {
                    // 법인카드 알림은 향후 데이터베이스로 이관 예정
                    // 현재는 서류 승인 알림만 데이터베이스에서 조회
                    const badge = document.getElementById('cardNotificationBadge');
                    if (badge) {
                        badge.style.display = 'none';
                    }
                    
                    // 요청 알림 체크 추가
                    await checkRequestNotifications(user);
                } catch (error) {
                    console.error('알림 체크 오류:', error);
                }
            }
        }
        
        // 승인 알림 체크 (가입 알림 포함)
        async function checkApprovalNotifications(user) {
            try {
                console.log('🔔 알림 체크 시작 - 현재 사용자:', user);
                
                // 서류 승인 대기 건수 체크
                let documentApprovalCount = 0;
                await checkDocumentApprovalNotifications(user);
                
                // 관리자인 경우에만 승인 대기 중인 사용자 수를 체크
                let pendingCount = 0;
                if (user.role === 'master' || user.role === 'company_CEO' || user.role === 'company_admin' || user.role === 'company_manager') {
                    console.log('👤 관리자 권한 확인됨, 승인 대기 사용자 조회 시작');
                    
                    // 데이터베이스에서 승인 대기 중인 사용자 수 조회
                    if (window.db && window.db.client) {
                        try {
                            const { data, error } = await window.db.client
                                .from('users')
                                .select('id, name, email, created_at')
                                .is('role', null)  // role이 null인 사용자들 (승인 대기)
                                .eq('is_active', true);
                                
                            if (!error && data) {
                                pendingCount = data.length;
                                console.log('✅ 승인 대기 사용자 조회 완료:', pendingCount, '명');
                                console.log('📋 승인 대기 사용자 목록:', data);
                                
                                // 승인 대기 사용자 수만 카운트 (localStorage 제거)
                                if (pendingCount > 0) {
                                    console.log('✅ 승인 대기 사용자 확인:', pendingCount, '명');
                                    console.log('📋 승인 대기 사용자 목록:', data);
                                }
                            } else {
                                console.error('❌ 승인 대기 사용자 조회 오류:', error);
                            }
                        } catch (error) {
                            console.error('❌ 승인 대기 사용자 조회 예외:', error);
                        }
                    } else {
                        console.warn('⚠️ 데이터베이스 클라이언트가 초기화되지 않음');
                    }
                } else {
                    console.log('👤 일반 사용자 - 승인 대기 사용자 체크 건너뜀');
                }
                
                // 승인 대기 중인 사용자 수만 알림으로 표시 (localStorage 제거)
                const totalNotificationCount = pendingCount;
                
                const badge = document.getElementById('approvalNotificationBadge');
                const headerBadge = document.getElementById('approvalNotificationBadgeHeader');
                
                if (totalNotificationCount > 0) {
                    // 기존 카드 배지 (숨겨진 상태)
                    if (badge) {
                        badge.textContent = totalNotificationCount;
                        badge.style.display = 'flex';
                    }
                    
                    // 헤더 배지
                    if (headerBadge) {
                        headerBadge.textContent = totalNotificationCount;
                        headerBadge.style.display = 'flex';
                    }
                } else {
                    if (badge) badge.style.display = 'none';
                    if (headerBadge) headerBadge.style.display = 'none';
                }
                
                console.log('🔔 알림 체크 완료 (데이터베이스 기반):', {
                    userName: user.name,
                    userId: user.id,
                    pendingUserCount: pendingCount,
                    totalDisplayCount: totalNotificationCount
                });
                
            } catch (error) {
                console.error('알림 체크 오류:', error);
            }
        }

        // 서류 승인 알림 체크 함수
        async function checkDocumentApprovalNotifications(user) {
            try {
                console.log('📋 서류 승인 알림 체크 시작 - 현재 사용자:', user);
                
                // 데이터베이스 초기화 확인
                if (!window.db) {
                    console.warn('⚠️ 데이터베이스가 초기화되지 않음');
                    return;
                }
                
                await window.db.init();
                
                // 현재 사용자가 승인자인 서류 요청 조회
                const { data: pendingDocuments, error } = await window.db.client
                    .from('document_requests')
                    .select('*')
                    .eq('status', 'pending')
                    .or(`current_approver_id.eq.${user.id},approver_1_id.eq.${user.id},approver_2_id.eq.${user.id}`)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('❌ 서류 승인 대기 건수 조회 오류:', error);
                    return;
                }
                
                const approvalCount = pendingDocuments ? pendingDocuments.length : 0;
                console.log('📋 서류 승인 대기 건수:', approvalCount);
                
                // 서류 승인 배지 업데이트
                const documentApprovalBadge = document.getElementById('documentApprovalBadge');
                if (documentApprovalBadge) {
                    if (approvalCount > 0) {
                        documentApprovalBadge.textContent = approvalCount;
                        documentApprovalBadge.style.display = 'flex';
                    } else {
                        documentApprovalBadge.style.display = 'none';
                    }
                }
                
                // 헤더 알림 배지도 업데이트 (기존 알림과 합산)
                const headerBadge = document.getElementById('approvalNotificationBadgeHeader');
                if (headerBadge) {
                    const currentHeaderCount = parseInt(headerBadge.textContent) || 0;
                    const totalCount = currentHeaderCount + approvalCount;
                    if (totalCount > 0) {
                        headerBadge.textContent = totalCount;
                        headerBadge.style.display = 'flex';
                    }
                }
                
                console.log('✅ 서류 승인 알림 체크 완료:', approvalCount, '건');
                
            } catch (error) {
                console.error('❌ 서류 승인 알림 체크 오류:', error);
            }
        }
        
        // 요청 알림 체크 함수 (견적, 카탈로그, 기술지원 요청)
        async function checkRequestNotifications(user) {
            try {
                console.log('📋 요청 알림 체크 시작 - 현재 사용자:', user);
                
                if (!user || !['admin', 'company_admin'].includes(user.role)) {
                    console.log('요청 알림 체크 권한 없음');
                    return;
                }
                
                // 대기 중인 요청 수 조회
                const [quoteResult, catalogResult, technicalResult] = await Promise.all([
                    supabaseClient.from('quote_requests').select('id', { count: 'exact' }).eq('status', 'pending'),
                    supabaseClient.from('catalog_requests').select('id', { count: 'exact' }).eq('status', 'pending'),
                    supabaseClient.from('technical_support_requests').select('id', { count: 'exact' }).eq('status', 'pending')
                ]);
                
                const pendingQuotes = quoteResult.count || 0;
                const pendingCatalogs = catalogResult.count || 0;
                const pendingTechnical = technicalResult.count || 0;
                const totalPendingRequests = pendingQuotes + pendingCatalogs + pendingTechnical;
                
                console.log('📋 대기 중인 요청:', {
                    견적: pendingQuotes,
                    카탈로그: pendingCatalogs,
                    기술지원: pendingTechnical,
                    총합: totalPendingRequests
                });
                
                // 헤더 알림 배지 업데이트 (기존 알림과 합산)
                const headerBadge = document.getElementById('approvalNotificationBadgeHeader');
                if (headerBadge) {
                    // 기존 알림 수 가져오기
                    const currentCount = parseInt(headerBadge.textContent) || 0;
                    const existingRequestCount = parseInt(headerBadge.dataset.requestCount || '0');
                    const otherNotifications = currentCount - existingRequestCount;
                    
                    const totalNotifications = otherNotifications + totalPendingRequests;
                    
                    if (totalNotifications > 0) {
                        headerBadge.textContent = totalNotifications;
                        headerBadge.style.display = 'block';
                        headerBadge.dataset.requestCount = totalPendingRequests;
                    } else {
                        headerBadge.style.display = 'none';
                        headerBadge.dataset.requestCount = '0';
                    }
                }
                
                // admin-dashboard.html의 견적요청 카드 배지 업데이트 (있다면)
                if (window.location.pathname.includes('admin-dashboard.html')) {
                    const requestBadge = document.getElementById('requestNotificationBadge');
                    if (requestBadge) {
                        if (totalPendingRequests > 0) {
                            requestBadge.style.display = 'flex';
                            requestBadge.querySelector('span').textContent = totalPendingRequests;
                        } else {
                            requestBadge.style.display = 'none';
                        }
                    }
                }
                
                console.log('✅ 요청 알림 체크 완료:', totalPendingRequests, '건');
                
            } catch (error) {
                console.error('❌ 요청 알림 체크 오류:', error);
            }
        }

        // 데이터베이스에서 현재 사용자 정보 가져오기
        async function getCurrentUserFromDB() {
            try {
                console.log('🔍 getCurrentUserFromDB 시작');
                
                if (!window.db) {
                    console.warn('⚠️ 데이터베이스가 초기화되지 않음');
                    return null;
                }
                
                await window.db.init();
                console.log('✅ 데이터베이스 초기화 완료');
                
                // 세션 스토리지에서 로그인 정보 가져오기
                const loginInfo = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('📋 세션 스토리지 로그인 정보:', loginInfo);
                
                if (!loginInfo || (!loginInfo.email && !loginInfo.id)) {
                    console.error('❌ 로그인 정보가 없습니다.');
                    return null;
                }
                
                // Supabase users 테이블에서 최신 사용자 정보 조회 (이메일 또는 ID로)
                let user, error;
                if (loginInfo.email && loginInfo.email !== 'null') {
                    // 이메일로 조회 (Google 로그인) - is_active 조건 제거
                    console.log('🔍 이메일로 사용자 조회:', loginInfo.email);
                    const result = await window.db.client
                        .from('users')
                        .select('*')
                        .eq('email', loginInfo.email)
                        .single();
                    user = result.data;
                    error = result.error;
                    console.log('📊 이메일 조회 결과:', { user, error });
                } else if (loginInfo.id) {
                    // ID로 조회 (카카오 로그인에서 이메일이 없는 경우) - is_active 조건 제거
                    console.log('🔍 ID로 사용자 조회:', loginInfo.id);
                    const result = await window.db.client
                        .from('users')
                        .select('*')
                        .eq('id', loginInfo.id)
                        .single();
                    user = result.data;
                    error = result.error;
                    console.log('📊 ID 조회 결과:', { user, error });
                }
                
                if (error) {
                    console.error('❌ 사용자 정보 조회 오류:', error);
                    return null;
                }
                
                if (!user) {
                    console.error('❌ 사용자를 찾을 수 없습니다');
                    return null;
                }
                
                console.log('✅ 사용자 정보 조회 성공:', user);
                
                // 업데이트된 사용자 정보를 sessionStorage에 저장
                const updatedUser = {
                    id: user.id,
                    email: user.email,
                    name: user.name,
                    role: user.role,
                    department: user.department,
                    position: user.position,
                    company_domain: user.company_domain,
                    company_name: user.company_name,
                    profileImage: user.profile_image,
                    profile_image: user.profile_image,
                    oauth_id: user.oauth_id,
                    oauth_provider: user.oauth_provider,
                    provider: user.oauth_provider || 'email',
                    is_approved: user.is_approved,
                    is_active: user.is_active,
                    permissions: AuthManager.ROLE_PERMISSIONS[user.role] || AuthManager.ROLE_PERMISSIONS['employee']
                };
                sessionStorage.setItem('currentUser', JSON.stringify(updatedUser));
                sessionStorage.setItem('userRole', user.role);
                sessionStorage.setItem('userName', user.name);
                console.log('✅ sessionStorage 업데이트 완료:', updatedUser);
                
                return updatedUser;
            } catch (error) {
                console.error('❌ getCurrentUserFromDB 오류:', error);
                return null;
            }
        }

        // 기본 아바타 생성 함수
        function generateDefaultAvatar(name) {
            const initials = (name || 'U').substring(0, 2).toUpperCase();
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            // 배경색 설정
            ctx.fillStyle = '#667eea';
            ctx.fillRect(0, 0, 100, 100);
            
            // 텍스트 설정
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initials, 50, 50);
            
            return canvas.toDataURL();
        }

        // 두 번째 DOMContentLoaded는 제거 (첫 번째에 통합됨)
    </script>

    <!-- 프로필 모달 -->
    <div class="modal" id="profileModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>프로필 설정</h2>
                <button class="close-btn" onclick="hideProfileModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="profile-section">
                    <div class="profile-image-section">
                        <div class="current-profile-image">
                            <img id="modalProfileImage" src="" alt="프로필 이미지" />
                        </div>
                        <div class="profile-image-upload">
                            <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageUpload(event)">
                            <button type="button" onclick="document.getElementById('profileImageInput').click()">이미지 변경</button>
                        </div>
                    </div>
                    
                    <form id="profileForm">
                        <div class="form-group">
                            <label>이름</label>
                            <input type="text" id="profileUserName" placeholder="이름을 입력하세요">
                        </div>
                        
                        <div class="form-group">
                            <label>이메일</label>
                            <input type="email" id="profileUserEmail" placeholder="이메일을 입력하세요">
                        </div>
                        
                        <div class="form-group">
                            <label>부서</label>
                            <input type="text" id="profileUserDepartment" placeholder="부서를 입력하세요">
                        </div>
                        
                        <div class="form-group">
                            <label>직책</label>
                            <input type="text" id="profileUserPosition" placeholder="직책을 입력하세요">
                        </div>
                        
                        <div class="form-group">
                            <label>연락처</label>
                            <input type="tel" id="profileUserPhone" placeholder="연락처를 입력하세요">
                        </div>
                        
                        <button type="submit" class="btn-save-profile">프로필 저장</button>
                    </form>
                </div>
                
                <div class="password-section">
                    <h3>비밀번호 변경</h3>
                    <form id="passwordChangeForm">
                        <div class="form-group">
                            <label>현재 비밀번호</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        
                        <div class="form-group">
                            <label>새 비밀번호</label>
                            <input type="password" id="newPassword" required minlength="6">
                        </div>
                        
                        <div class="form-group">
                            <label>새 비밀번호 확인</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        
                        <button type="submit" class="btn-change-password">비밀번호 변경</button>
                    </form>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="handleLogout()" class="btn-logout">로그아웃</button>
                <button onclick="hideProfileModal()" class="btn-close">닫기</button>
            </div>
        </div>
    </div>

    <style>
        /* 프로필 모달 스타일 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .profile-image-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .current-profile-image img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            margin-bottom: 15px;
        }
        
        .profile-image-upload button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group input[readonly] {
            background: #f5f5f5;
        }
        
        .btn-save-profile {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        
        .btn-save-profile:hover {
            background: #5a6fd8;
        }
        
        .password-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .password-section h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .btn-change-password {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .btn-change-password:hover {
            background: #218838;
        }
        
        .modal-footer {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        
        .btn-logout {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-logout:hover {
            background: #c82333;
        }
        
        .btn-close {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .btn-close:hover {
            background: #545b62;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 15px;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        /* 프로필 이미지 스타일 */
        .user-profile-dashboard {
            position: relative;
            display: inline-block;
        }
        
        .user-profile-dashboard:hover img {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .user-profile-dashboard img {
            width: 50px !important;
            height: 50px !important;
            min-width: 50px !important;
            min-height: 50px !important;
            max-width: 50px !important;
            max-height: 50px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            display: block !important;
            cursor: pointer !important;
            border: 2px solid #fff !important;
            transition: all 0.3s ease !important;
        }
    </style>

    <script>
        // 프로필 모달 표시 (데이터베이스 기반)
        async function showProfileModal() {
            const currentUser = await getCurrentUserFromDB();
            if (!currentUser) return;
            
            // 프로필 이미지 설정
            const modalProfileImage = document.getElementById('modalProfileImage');
            if (currentUser.profile_image || currentUser.profileImage) {
                modalProfileImage.src = currentUser.profile_image || currentUser.profileImage;
            } else {
                // 기본 아바타 생성
                modalProfileImage.src = generateDefaultAvatar(currentUser.name || currentUser.email);
            }
            
            // 프로필 정보 채우기 (데이터베이스에서 가져온 최신 정보)
            document.getElementById('profileUserName').value = currentUser.name || '';
            document.getElementById('profileUserEmail').value = currentUser.email || '';
            document.getElementById('profileUserDepartment').value = currentUser.department || '';
            document.getElementById('profileUserPosition').value = currentUser.position || '';
            document.getElementById('profileUserPhone').value = currentUser.phone || '';
            
            document.getElementById('profileModal').style.display = 'flex';
        }
        
        // 프로필 모달 숨기기
        function hideProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            // 폼 초기화
            document.getElementById('passwordChangeForm').reset();
        }
        
        
        // 프로필 이미지 업로드 (데이터베이스 기반)
        async function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 파일 크기 제한 (2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('이미지 크기는 2MB 이하여야 합니다.');
                return;
            }
            
            // 이미지 파일 확인
            if (!file.type.startsWith('image/')) {
                alert('이미지 파일만 업로드 가능합니다.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageData = e.target.result;
                
                try {
                    const currentUser = await getCurrentUserFromDB();
                    if (!currentUser) {
                        alert('사용자 정보를 가져올 수 없습니다.');
                        return;
                    }
                    
                    // 데이터베이스에 업데이트
                    if (window.db && window.db.client) {
                        try {
                            let updateResult;
                            if (currentUser.email) {
                                // 이메일로 업데이트 (Google 사용자)
                                updateResult = await window.db.client
                                    .from('users')
                                    .update({ 
                                        profile_image: imageData,
                                        updated_at: new Date().toISOString()
                                    })
                                    .eq('email', currentUser.email)
                                    .select();
                            } else if (currentUser.id) {
                                // ID로 업데이트 (카카오 사용자)
                                updateResult = await window.db.client
                                    .from('users')
                                    .update({ 
                                        profile_image: imageData,
                                        updated_at: new Date().toISOString()
                                    })
                                    .eq('id', currentUser.id)
                                    .select();
                            }
                            
                            const { data, error } = updateResult;
                                
                            if (error) {
                                console.error('데이터베이스 업데이트 오류:', error);
                                alert('프로필 이미지 저장 중 오류가 발생했습니다.');
                                return;
                            } else {
                                console.log('프로필 이미지 데이터베이스 업데이트 완료');
                            }
                        } catch (dbError) {
                            console.error('데이터베이스 연결 오류:', dbError);
                            alert('데이터베이스 연결 오류가 발생했습니다.');
                            return;
                        }
                    }
                    
                    // UI 업데이트
                    const modalProfileImage = document.getElementById('modalProfileImage');
                    const dashboardProfileImage = document.getElementById('profileImageDashboard');
                    
                    if (modalProfileImage) modalProfileImage.src = imageData;
                    if (dashboardProfileImage) dashboardProfileImage.src = imageData;
                    
                    // 헤더의 프로필 이미지도 업데이트
                    const headerProfileImages = document.querySelectorAll('.user-profile-dashboard img');
                    headerProfileImages.forEach(img => {
                        img.src = imageData;
                    });
                    
                    alert('프로필 이미지가 변경되었습니다.');
                } catch (error) {
                    console.error('프로필 이미지 저장 오류:', error);
                    alert('프로필 이미지 저장 중 오류가 발생했습니다: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }
        
        // 프로필 저장 (데이터베이스 기반)
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('profileUserName').value.trim();
            const email = document.getElementById('profileUserEmail').value.trim();
            const department = document.getElementById('profileUserDepartment').value.trim();
            const position = document.getElementById('profileUserPosition').value.trim();
            const phone = document.getElementById('profileUserPhone').value.trim();
            
            if (!name || !email) {
                alert('이름과 이메일은 필수 입력 항목입니다.');
                return;
            }
            
            try {
                const currentUser = await getCurrentUserFromDB();
                if (!currentUser) {
                    alert('사용자 정보를 가져올 수 없습니다.');
                    return;
                }
                
                // 데이터베이스에 업데이트
                if (window.db && window.db.client) {
                    let updateResult;
                    if (currentUser.email) {
                        // 이메일로 업데이트 (Google 사용자)
                        updateResult = await window.db.client
                            .from('users')
                            .update({
                                name: name,
                                department: department,
                                position: position,
                                phone: phone,
                                updated_at: new Date().toISOString()
                            })
                            .eq('email', currentUser.email)
                            .select();
                    } else if (currentUser.id) {
                        // ID로 업데이트 (카카오 사용자)
                        updateResult = await window.db.client
                            .from('users')
                            .update({
                                name: name,
                                department: department,
                                position: position,
                                phone: phone,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', currentUser.id)
                            .select();
                    }
                    
                    const { data, error } = updateResult;
                    
                    if (error) {
                        console.error('데이터베이스 업데이트 오류:', error);
                        alert('프로필 저장 중 오류가 발생했습니다.');
                        return;
                    }
                    
                    console.log('프로필 데이터베이스 업데이트 완료');
                }
                
                // 화면 업데이트
                document.getElementById('userName').textContent = name;
                document.getElementById('userInfo').textContent = `${position || '직급'} | 오늘도 좋은 하루 되세요.`;
                
                // 프로필 이미지도 업데이트
                const profileImage = currentUser.profile_image || generateDefaultAvatar(name);
                const dashboardImage = document.getElementById('profileImageDashboard');
                if (dashboardImage) {
                    dashboardImage.src = profileImage;
                }
                
                alert('프로필이 성공적으로 저장되었습니다.');
                hideProfileModal();
                
            } catch (error) {
                console.error('프로필 저장 오류:', error);
                alert('프로필 저장 중 오류가 발생했습니다: ' + error.message);
            }
        });

        // 비밀번호 변경
        document.getElementById('passwordChangeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('새 비밀번호와 확인 비밀번호가 일치하지 않습니다.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('비밀번호는 최소 6자 이상이어야 합니다.');
                return;
            }
            
            alert('비밀번호 변경 기능은 준비 중입니다.');
            this.reset();
        });
        
    </script>
</body>
</html>