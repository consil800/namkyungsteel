# 스케줄 생성 알고리즘 v6.2.2f

> schedule-generator.js 상세 설명

## 개요

철강 영업팀의 방문 스케줄을 자동 생성합니다.
- **점수 기반 우선순위**로 업체 선정
- **TSP 알고리즘**으로 경로 최적화
- **업체 고정 배정** + **같은 지역 우선 배정**

## 핵심 기능

### 1. 업체 고정 배정 (v6.2)

특정 업체를 특정 날짜에 미리 고정할 수 있습니다.

```
1. "📌 고정 모드" 버튼 클릭
2. 고정할 날짜 선택
3. 업체 클릭 → 해당 날짜에 고정
4. "스케줄 생성" → 고정 업체 먼저 배정
```

### 2. 같은 지역 우선 배정 (v6.2.1)

고정 업체가 있는 날은 **같은 지역 업체를 우선 배정**합니다.

```javascript
// remainingPool 전체에서 같은 지역 업체 검색
const sameRegionCandidates = remainingPool.filter(c => c.region === pinnedRegion);
```

| 조건 | 동작 |
|------|------|
| 같은 지역 충분 | 같은 지역 업체만 배정 |
| 같은 지역 부족 | 같은 지역 + 인근 지역 혼합 |

## 우선순위 점수

| 항목 | 설명 |
|------|------|
| 방문 오래된 업체 | staleDays 기반 (0~10점) |
| 방문 횟수 적은 업체 | visit_count 기반 |
| 월 2회 제한 | 월 3회 이상 차단 |
| 지역 쿨다운 | 같은 지역 3~4일 연속 억제 |
| 월/금 근거리 | 본사 60km 이내 보너스 |

## 경로 최적화

1. **Nearest Neighbor**: 가장 가까운 업체 순서로 초기 경로
2. **2-opt 개선**: 교차 경로 제거

## 설정값

```
본사 좌표: 35.1547, 128.9914 (부산 사상구)
```

| 방문 옵션 | min | max | target |
|----------|-----|-----|--------|
| 1~3개 | 1 | 3 | 2 |
| 4~5개 | 4 | 5 | 5 |
| 6~8개 | 6 | 8 | 7 |
| 9~11개 | 9 | 11 | 10 |

## 제약 완화

후보 부족 시 단계적 완화:

| Level | 월 제한 | 지역 쿨다운 |
|-------|---------|-------------|
| 0 | 2회 | 3일 |
| 1 | 3회 | 2일 |
| 2 | 무제한 | 1일 |

## 저장/불러오기

- **테이블**: `visit_schedule_plans`
- **형식**: JSONB (version, days, pinnedCompanies)

### 3. 업체 상세 페이지 바로가기 (v6.2.2)

업체 아이템에서 상세 페이지로 바로 이동할 수 있습니다.

| 방법 | 동작 |
|------|------|
| ℹ️ 버튼 클릭 | 새 탭에서 상세 페이지 열기 |
| 더블클릭 | 새 탭에서 상세 페이지 열기 |

```
ChatGPT 검증 결과:
- SortableJS filter 옵션으로 버튼 드래그 차단
- 새 탭 열기로 스케줄 작업 상태 유지
- 이벤트 위임 방식으로 동적 DOM 대응
```

### 4. 뒤로가기 시 스케줄 복원 (v6.2.2f)

업체 상세 페이지에서 **뒤로가기**하면 스케줄이 자동 복원됩니다.

| 기능 | 설명 |
|------|------|
| sessionStorage 저장 | 페이지 이동 전 스케줄 상태 저장 |
| bfcache 지원 | 브라우저 뒤로가기 캐시에서 복원 시 자동 감지 |
| 30분 유효기간 | 저장 후 30분 이내만 복원 (오래된 데이터 방지) |

```javascript
// 저장 키
const SCHEDULE_NAV_KEY = 'schedule_nav_state';

// 저장 데이터
{
  timestamp: Date.now(),
  schedule: [...],      // 날짜별 배정 업체
  unassigned: [...],    // 미배정 업체
  pinnedCompanies: [...], // 고정 업체
  startDate, endDate, visitOption
}
```

**작동 흐름:**
```
1. 업체 더블클릭 → saveScheduleStateBeforeNav() 호출
2. sessionStorage에 스케줄 상태 저장
3. company-detail.html로 이동
4. 뒤로가기 클릭
5. bfcache 또는 DOMContentLoaded에서 복원
6. 스케줄 자동 렌더링
```

---
*최종 업데이트: 2026-01-12 (v6.2.2f 뒤로가기 스케줄 복원)*
