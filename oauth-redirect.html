<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬</title>
    
    <!-- Favicons -->
    <link href="logo.jpg" rel="icon">
    <link href="logo.jpg" rel="apple-touch-icon">
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
        <h2>ğŸ” ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...</h2>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <script type="module">
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        const supabaseUrl = 'https://zgyawfmjconubxaiamod.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpneWF3Zm1qY29udWJ4YWlhbW9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI2MDU0MDUsImV4cCI6MjA0ODE4MTQwNX0.ZMjZCPyQOJFRCpP_CdQ7UqKDbKHwmLBueqsqVlL8FL4';
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        // URLì—ì„œ í† í° ì •ë³´ ì¶”ì¶œ
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        const accessToken = hashParams.get('access_token') || urlParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token') || urlParams.get('refresh_token');
        
        if (accessToken) {
            console.log('âœ… OAuth í† í° ë°œê²¬, ì²˜ë¦¬ ì¤‘...');
            
            try {
                // Supabase ì„¸ì…˜ ì„¤ì •
                const { data: { session }, error: sessionError } = await supabase.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken
                });
                
                if (sessionError) {
                    console.error('âŒ ì„¸ì…˜ ì„¤ì • ì˜¤ë¥˜:', sessionError);
                    throw sessionError;
                }
                
                console.log('âœ… ì„¸ì…˜ ì„¤ì • ì™„ë£Œ:', session);
                
                // public.users í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì í™•ì¸/ìƒì„±
                const provider = session.user.app_metadata?.provider || 'unknown';
                const userEmail = session.user.email;
                const userId = session.user.id;
                
                let existingUser, fetchError;
                
                if (userEmail) {
                    // ì´ë©”ì¼ì´ ìˆëŠ” ê²½ìš° ì´ë©”ì¼ë¡œ ì¡°íšŒ
                    const result = await supabase
                        .from('users')
                        .select('*')
                        .eq('email', userEmail)
                        .single();
                    existingUser = result.data;
                    fetchError = result.error;
                } else {
                    // ì´ë©”ì¼ì´ ì—†ëŠ” ê²½ìš° (ì¹´ì¹´ì˜¤) OAuth IDë¡œ ì¡°íšŒ
                    const result = await supabase
                        .from('users')
                        .select('*')
                        .eq('oauth_id', userId)
                        .single();
                    existingUser = result.data;
                    fetchError = result.error;
                }
                
                let dbUser;
                
                if (fetchError && fetchError.code === 'PGRST116') {
                    // ì‚¬ìš©ìê°€ ì—†ìœ¼ë¯€ë¡œ ìƒì„±
                    console.log('ğŸ“ public.usersì— ìƒˆ ì‚¬ìš©ì ìƒì„±');
                    const userName = session.user.user_metadata?.full_name || 
                                   session.user.user_metadata?.name || 
                                   session.user.user_metadata?.nickname ||
                                   userEmail || 
                                   `kakao_user_${userId.slice(-8)}`;
                    
                    const newUser = {
                        username: userEmail || `kakao_${userId.slice(-8)}`,
                        email: userEmail || null,
                        oauth_id: userId,
                        oauth_provider: provider,
                        name: userName,
                        role: 'employee',
                        company_domain: 'namkyungsteel.com',
                        company_name: 'ë‚¨ê²½ìŠ¤í‹¸(ì£¼)',
                        profile_image: session.user.user_metadata?.avatar_url || session.user.user_metadata?.picture,
                        password: 'oauth_user',
                        is_active: true,
                        is_approved: true,  // OAuth ì‚¬ìš©ìëŠ” ìë™ ìŠ¹ì¸
                        created_at: new Date().toISOString()
                    };
                    
                    const { data: createdUser, error: createError } = await supabase
                        .from('users')
                        .insert([newUser])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('âŒ ì‚¬ìš©ì ìƒì„± ì˜¤ë¥˜:', createError);
                        // ì´ë©”ì¼ì´ ì—†ëŠ” ê²½ìš° (ì¹´ì¹´ì˜¤) OAuth IDë¡œ ë‹¤ì‹œ ì¡°íšŒ
                        if (userEmail) {
                            const { data: retriedUser } = await supabase
                                .from('users')
                                .select('*')
                                .eq('email', userEmail)
                                .single();
                            dbUser = retriedUser;
                        } else {
                            const { data: retriedUser } = await supabase
                                .from('users')
                                .select('*')
                                .eq('oauth_id', userId)
                                .single();
                            dbUser = retriedUser;
                        }
                        
                        if (!dbUser) {
                            throw new Error('ì‚¬ìš©ì ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. RLS ì •ì±… ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        }
                    } else {
                        dbUser = createdUser;
                        
                        // ìƒˆ ì‚¬ìš©ì ê°€ì… ì•Œë¦¼ ìƒì„± - Supabase notifications í…Œì´ë¸”ì— ì €ì¥
                        try {
                            // ê´€ë¦¬ìë“¤(company_CEO, company_admin) ì¡°íšŒ
                            const { data: admins, error: adminError } = await supabase
                                .from('users')
                                .select('id')
                                .in('role', ['company_CEO', 'company_admin'])
                                .eq('company_domain', 'namkyungsteel.com')
                                .eq('is_active', true);
                            
                            if (adminError) {
                                console.error('ê´€ë¦¬ì ì¡°íšŒ ì˜¤ë¥˜:', adminError);
                            } else if (admins && admins.length > 0) {
                                // ê° ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼ ìƒì„±
                                const notifications = admins.map(admin => ({
                                    user_id: admin.id,
                                    type: 'user_registration',
                                    title: 'ì‹ ê·œ íšŒì›ê°€ì… ìŠ¹ì¸ ìš”ì²­',
                                    message: `${userName}ë‹˜ì´ ${provider === 'kakao' ? 'ì¹´ì¹´ì˜¤' : 'Google'} ë¡œê·¸ì¸ìœ¼ë¡œ ê°€ì…í–ˆìŠµë‹ˆë‹¤. ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.`,
                                    related_id: dbUser.id,
                                    company_domain: 'namkyungsteel.com',
                                    is_read: false,
                                    created_at: new Date().toISOString()
                                }));
                                
                                const { error: notifError } = await supabase
                                    .from('notifications')
                                    .insert(notifications);
                                
                                if (notifError) {
                                    console.error('ì•Œë¦¼ ìƒì„± ì˜¤ë¥˜:', notifError);
                                } else {
                                    console.log('âœ… ê´€ë¦¬ì ì•Œë¦¼ ìƒì„± ì™„ë£Œ:', notifications.length, 'ê°œ');
                                }
                            }
                        } catch (notifError) {
                            console.error('ì•Œë¦¼ ì²˜ë¦¬ ì˜¤ë¥˜:', notifError);
                            // ì•Œë¦¼ ì‹¤íŒ¨í•´ë„ ê°€ì…ì€ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
                        }
                        
                    }
                } else {
                    // ê¸°ì¡´ ì‚¬ìš©ì ì—…ë°ì´íŠ¸
                    console.log('âœ… ê¸°ì¡´ ì‚¬ìš©ì ë°œê²¬, ì •ë³´ ì—…ë°ì´íŠ¸');
                    const updateData = {
                        last_login_at: new Date().toISOString(),
                        profile_image: session.user.user_metadata?.avatar_url || session.user.user_metadata?.picture,
                        updated_at: new Date().toISOString()
                    };
                    
                    let updatedUser;
                    if (userEmail) {
                        const result = await supabase
                            .from('users')
                            .update(updateData)
                            .eq('email', userEmail)
                            .select()
                            .single();
                        updatedUser = result.data;
                    } else {
                        const result = await supabase
                            .from('users')
                            .update(updateData)
                            .eq('oauth_id', userId)
                            .select()
                            .single();
                        updatedUser = result.data;
                    }
                    
                    dbUser = updatedUser || existingUser;
                }
                
                // ì‚¬ìš©ì ì •ë³´ ìƒì„±
                const finalProvider = session.user.app_metadata?.provider || 'unknown';
                const finalUserName = dbUser?.name || 
                                    session.user.user_metadata?.full_name || 
                                    session.user.user_metadata?.name || 
                                    session.user.user_metadata?.nickname ||
                                    userEmail || 
                                    `kakao_user_${userId.slice(-8)}`;
                
                const user = {
                    id: dbUser?.id || session.user.id,
                    email: userEmail || null,
                    oauth_id: userId,
                    name: finalUserName,
                    role: dbUser?.role || 'employee',
                    department: dbUser?.department || '',
                    position: dbUser?.position || '',
                    company_domain: dbUser?.company_domain || 'namkyungsteel.com',
                    company_name: dbUser?.company_name || 'ë‚¨ê²½ìŠ¤í‹¸(ì£¼)',
                    profileImage: dbUser?.profile_image || session.user.user_metadata?.avatar_url || session.user.user_metadata?.picture,
                    provider: finalProvider,
                    permissions: ['access_employee_dashboard', 'create_work_log', 'access_sales_system', 'view_team_data']
                };
                
                // sessionStorageì— ì €ì¥ (ê¸°ì¡´ localStorage ëŒ€ì‹ )
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                sessionStorage.setItem('userRole', user.role);
                sessionStorage.setItem('userName', user.name);
                sessionStorage.setItem('accessToken', accessToken);
                if (refreshToken) {
                    sessionStorage.setItem('refreshToken', refreshToken);
                }
                
                console.log('âœ… OAuth ë¡œê·¸ì¸ ì™„ë£Œ:', user);
                
                
                // ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                window.location.href = 'https://namkyungsteel.com';
                
            } catch (error) {
                console.error('âŒ í† í° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                window.location.href = 'https://namkyungsteel.com';
            }
        } else {
            console.log('âŒ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            window.location.href = 'https://namkyungsteel.com';
        }
    </script>
</body>
</html>