# 남경스틸(주) 웹 통합 관리 시스템 프로젝트 문서

## 📋 프로젝트 개요

**남경스틸(주) 웹 통합 관리 시스템**은 철강 제조 및 유통 전문 기업인 남경스틸(주)의 업무 효율성을 높이기 위한 종합 관리 플랫폼입니다. 

이 시스템은 직원 관리, 영업 활동 추적, 전자결재, 법인카드 관리 등 다양한 업무를 하나의 플랫폼에서 처리할 수 있도록 설계되었습니다.

### 🎯 주요 목표
- 영업팀의 거래처 관리 및 업무일지 작성 효율화
- 전자결재 시스템을 통한 업무 프로세스 디지털화
- 직원별 맞춤형 대시보드 제공
- 실시간 알림 및 권한 관리 시스템 구축

## 🛠 기술 스택

### Frontend
- **HTML5, CSS3, JavaScript (ES6+)**
- **Bootstrap 5** - UI 프레임워크
- **Font Awesome 6** - 아이콘
- **반응형 디자인** - 모바일/태블릿/데스크톱 지원

### Backend
- **Supabase** - 백엔드 서비스 (PostgreSQL 기반)
- **JWT 기반 인증** - 커스텀 인증 시스템
- **Row Level Security (RLS)** - 데이터 격리 및 보안

### 안정성 및 성능
- **DataStabilityManager** - 데이터 로딩 안정성 관리
- **지수 백오프 재시도** - 네트워크 오류 시 자동 재시도
- **캐시 메커니즘** - 5분 TTL을 가진 메모리 캐시
- **Graceful Degradation** - 오류 시 대체 데이터 제공
- **네트워크 상태 모니터링** - 온라인/오프라인 감지

### 개발 환경
- Git을 통한 버전 관리
- 정적 웹 서버로 호스팅 가능
- CDN을 통한 라이브러리 로드

## 🏗 시스템 아키텍처

### 1. 데이터베이스 구조

#### 주요 테이블
1. **users** - 사용자 정보 관리
   - 기본 인증 정보 (이메일, 비밀번호)
   - OAuth 연동 지원
   - 프로필 정보 (이름, 부서, 직급 등)
   - 역할 기반 권한 (master, company_admin, employee 등)

2. **client_companies** - 개인별 거래처 관리
   - 업체 기본 정보 (회사명, 지역, 주소 등)
   - 담당자 정보
   - 거래 조건 및 방문 통계
   - 사용자별 독립적 관리 (user_id)

3. **work_logs** - 영업 업무일지
   - 방문 정보 및 상담 내용
   - 후속 조치 계획
   - 업체별 방문 이력 추적

4. **user_settings** - 사용자별 커스터마이징 설정
   - 드롭다운 옵션 (지역, 결제조건, 업종 등)
   - 개인별 색상 코드 설정

5. **document_requests** - 전자결재 문서
   - 다양한 문서 템플릿 지원
   - 다단계 승인 프로세스
   - 결재 이력 추적

6. **user_permissions** - 권한 관리
   - 메뉴별 접근 권한
   - 부서별/직급별/개인별 권한 설정 (OR 방식)

### 2. 보안 체계

#### Row Level Security (RLS)
- 사용자별 데이터 격리
- client_companies, work_logs, user_settings 테이블에 적용
- 각 사용자는 자신의 데이터만 접근 가능

#### 인증 및 권한
- JWT 기반 세션 관리
- 역할 기반 접근 제어 (RBAC)
- 메뉴별 세밀한 권한 설정 가능

## 💼 주요 기능

### 1. 사용자 관리
- **회원가입/로그인**
  - 이메일 기반 인증
  - OAuth 로그인 지원 (구글, 카카오)
  - 도메인 자동 감지로 회사 식별
  - 관리자 승인 후 활성화

- **승인 시스템**
  - 신규 회원가입 시 CEO/관리자에게 자동 알림
  - 승인 대기 회원 목록 관리
  - 역할 지정 후 승인/거부 처리
  - 승인 시 해당 사용자에게 알림 발송

- **직원 관리**
  - 직원 정보 조회/수정
  - 역할 및 권한 설정
  - 부서/직급 관리

### 2. 영업 관리 시스템
- **거래처 관리**
  - 개인별 독립적인 거래처 데이터베이스
  - 지역별/업종별 분류
  - 색상 코드를 통한 시각적 구분
  - 방문 통계 자동 집계

- **업무일지 작성**
  - 방문 목적별 템플릿
  - 상담 내용 및 후속 조치 기록
  - 업체별 방문 이력 조회

- **사용자 설정**
  - 드롭다운 옵션 커스터마이징
  - 지역, 결제조건, 업종, 방문목적 등 개인별 설정
  - 색상 코드 관리

### 3. 전자결재 시스템
- **다양한 문서 템플릿**
  - 휴가 신청서
  - 업무 보고서
  - 사직서
  - 재직 증명서
  - 경력 증명서
  - 법인카드 사용 보고서
  - 출장 보고서
  - 사고 보고서

- **승인 프로세스**
  - 1차/2차 승인자 지정
  - 최종 승인자 설정 가능
  - 승인/반려 사유 기록
  - 실시간 상태 추적

### 4. 대시보드
- **역할별 맞춤 대시보드**
  - 관리자: 전체 현황 및 승인 대기 문서
  - 직원: 개인 업무 현황 및 알림

- **통계 및 현황**
  - 월별 문서 처리 통계
  - 최근 활동 내역
  - 대기 중인 작업 알림

### 5. 권한 관리
- **유연한 권한 설정**
  - 메뉴별 접근 권한
  - 부서별/직급별/개인별 권한 부여
  - OR 방식으로 복수 조건 허용

### 6. 알림 시스템
- **실시간 알림**
  - 신규 회원가입 알림 (CEO/관리자)
  - 문서 결재 요청/승인 알림
  - 업무 관련 알림
- **알림 관리**
  - 읽음/안읽음 상태 표시
  - 알림 목록 조회
  - 배지로 미확인 알림 수 표시

### 7. 기타 기능
- **법인카드 관리**
  - 카드 등록/삭제
  - 사용 내역 기록
  - 한도 관리

- **알림 시스템**
  - 실시간 알림
  - 읽음/안읽음 상태 관리
  - 역할별 알림 발송

## 📝 TODO 리스트

### 🔴 긴급 (보안 관련)
1. **비밀번호 암호화**
   - [ ] bcrypt를 이용한 비밀번호 해싱 구현
   - [ ] 기존 평문 비밀번호 마이그레이션

2. **환경변수 관리**
   - [ ] Supabase 키를 환경변수로 분리
   - [ ] .env 파일 설정 및 .gitignore 추가

3. **기본 계정 관리**
   - [ ] 테스트 계정 삭제 또는 비활성화
   - [ ] 강력한 비밀번호 정책 적용

4. **OAuth 인증 개선**
   - [x] 카카오 로그인 신규 사용자 등록 오류 수정 (2024-01-18)
   - [x] OAuth 사용자의 RLS 정책 최적화 (2024-01-18)

5. **데이터 로딩 안정성 개선**
   - [x] DataStabilityManager 구현 (2024-01-18)
   - [x] 안전한 데이터 로딩 함수 적용
   - [x] RLS 실패 시 graceful degradation 구현
   - [ ] 오프라인 모드 지원 개선

### 🟡 중요 (기능 개선)
1. **UI/UX 개선**
   - [ ] 로딩 스피너 추가
   - [ ] 에러 메시지 개선
   - [ ] 모바일 UI 최적화

2. **성능 최적화**
   - [ ] 페이지네이션 구현
   - [ ] 대량 데이터 처리 개선
   - [ ] 이미지 최적화

3. **기능 확장**
   - [ ] 엑셀 내보내기/가져오기
   - [ ] 고급 검색 기능
   - [ ] 대시보드 커스터마이징

### 🟢 일반 (추가 기능)
1. **보고서 기능**
   - [ ] 월별/분기별 영업 보고서
   - [ ] 거래처별 분석 리포트
   - [ ] 직원 성과 대시보드

2. **통합 기능**
   - [ ] 이메일 알림 연동
   - [ ] 캘린더 연동
   - [ ] 모바일 앱 개발

3. **백업 및 복구**
   - [ ] 자동 백업 시스템
   - [ ] 데이터 복구 기능
   - [ ] 감사 로그

## 🐛 알려진 이슈 및 해결 방법

### OAuth 로그인 이슈
1. **카카오 로그인 신규 사용자 등록 오류** ✅ 해결됨
   - **증상**: "사용자 등록 중 오류가 발생하였습니다" 메시지
   - **원인**: RLS 정책 및 스토리지 타입 불일치
   - **해결**: 
     - `oauth-redirect.html`에서 `is_approved: true` 설정 추가
     - localStorage → sessionStorage로 통일
     - OAuth ID로 재조회 로직 추가

2. **회원가입 승인 시스템 개선** ✅ 구현됨
   - **기능**: 신규 회원가입 시 CEO/관리자에게 자동 알림
   - **구현 내용**:
     - Supabase notifications 테이블 활용
     - company_CEO, company_admin 역할 사용자에게 알림 발송
     - 관리자 대시보드에 승인 대기 배지 표시
     - pending-members.html에서 승인/거부 처리

### 데이터 로딩 안정성 이슈
3. **데이터베이스 연결 불안정 문제** ✅ 개선됨
   - **증상**: 로그인 후 페이지에 데이터가 표시되지 않는 현상
   - **원인**: 
     - RLS 정책 설정 실패 시 전체 시스템 중단
     - 비동기 초기화 타이밍 문제
     - 네트워크 지연 및 연결 오류에 대한 재시도 부족
   - **해결**:
     - `data-stability.js` 추가 - 데이터 로딩 안정성 관리자
     - RLS 실패 시에도 시스템 계속 작동하도록 개선
     - 지수 백오프를 사용한 재시도 로직 (최대 10회)
     - 캐시 및 폴백 메커니즘 구현
     - 사용자 친화적 오류 메시지 및 새로고침 버튼 제공
     - 네트워크 상태 모니터링 및 자동 재연결

4. **업체 상세 페이지 데이터 로딩 오류** ✅ 해결됨
   - **증상**: company-detail.html에서 "업체를 찾을 수 없습니다" 오류
   - **원인**: company-detail.html에 data-stability.js가 적용되지 않아 불안정한 데이터 로딩
   - **해결**:
     - company-detail.html에 data-stability.js 스크립트 추가
     - company-detail.js의 모든 데이터 로딩 함수에 safeLoadData 적용
     - loadCompanyDetails, loadWorkLogs, syncVisitCount, updateCompany 함수 안정화
     - 캐시 클리어 및 재시도 로직 구현
     - 사용자 친화적 오류 메시지 및 재시도 버튼 제공

5. **업무일지 작성 페이지 데이터 로딩 오류** ✅ 해결됨
   - **증상**: work-log-entry.html에서 "업체를 찾을 수 없습니다" 오류 및 저장 실패
   - **원인**: work-log-entry.html에 data-stability.js가 적용되지 않아 불안정한 데이터 로딩/저장
   - **해결**:
     - work-log-entry.html에 data-stability.js 스크립트 추가
     - work-log-entry.js의 loadCompanyInfo 함수에 safeLoadData 적용
     - 업무일지 저장 시에도 안전한 데이터베이스 접근 구현
     - 캐시 클리어 및 재시도 로직 구현
     - 사용자 친화적 오류 메시지 및 새로고침 버튼 제공

## 📦 최근 업데이트 (2024-01-18)

### 🆕 새로 추가된 파일
- **`namkyungsteel.md`** - 프로젝트 종합 문서화
- **`data-stability.js`** - 데이터 로딩 안정성 관리자

### 🔧 주요 개선사항
1. **회원가입 승인 시스템**
   - CEO/관리자에게 자동 알림 발송
   - 승인 대기 배지 표시
   - 실시간 알림 관리

2. **데이터 로딩 안정성**
   - 지수 백오프 재시도 로직
   - 캐시 메커니즘 구현
   - Graceful degradation 적용
   - 네트워크 상태 모니터링

3. **OAuth 로그인 개선**
   - 카카오 로그인 오류 수정
   - 자동 승인 기능
   - RLS 정책 최적화

### 📁 수정된 파일 목록
- `oauth-redirect.html`
- `database.js`
- `shared-assets/js/auth.js`
- `admin-dashboard.html`
- `pending-members.html`
- `employee-dashboard.html`
- `worklog.html`
- `company-detail.html` - data-stability.js 스크립트 추가
- `company-detail.js` - 안전한 데이터 로딩 함수로 개선
- `work-log-entry.html` - data-stability.js 스크립트 추가
- `work-log-entry.js` - 안전한 데이터 로딩/저장 함수로 개선

## 🚀 배포 및 운영

### 배포 준비
1. 환경변수 설정 (.env 파일)
2. HTTPS 인증서 설정
3. 도메인 설정
4. 백업 정책 수립

### 운영 관리
1. 정기 보안 업데이트
2. 데이터베이스 백업 (일별/주별)
3. 액세스 로그 모니터링
4. 성능 모니터링

## 📞 지원 및 문의

- 시스템 관리자: admin@namkyungsteel.com
- 기술 지원: support@namkyungsteel.com
- 긴급 연락처: 010-XXXX-XXXX

## 📄 라이선스

Copyright © 2024 남경스틸(주). All rights reserved.

이 시스템은 남경스틸(주)의 독점 소프트웨어입니다. 무단 복제 및 배포를 금지합니다.