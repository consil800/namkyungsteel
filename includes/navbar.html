<header id="header" class="header d-flex align-items-center sticky-top">
  <div class="container-fluid container-xl position-relative d-flex align-items-center">

    <a href="index.html" class="logo d-flex align-items-center me-auto">
      <img src="logo.jpg" alt="남경스틸 로고" style="height: 40px; margin-right: 10px;">
      <h1 class="sitename" id="companyNameHeader">남경스틸(주)</h1>
    </a>

    <nav id="navmenu" class="navmenu">
      <ul>
        <li><a href="index.html">홈</a></li>
        <li class="dropdown"><a href="index.html#about"><span>회사소개</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
          <ul>
            <li><a href="ceo-message.html">CEO 인사말</a></li>
            <li><a href="company-history.html">회사연혁</a></li>
            <li><a href="vision-mission.html">비전/미션</a></li>
            <li><a href="organization.html">조직도</a></li>
            <li><a href="location.html">오시는길</a></li>
            <li><a href="certificates.html">인증서</a></li>
          </ul>
        </li>
        <li class="dropdown"><a href="index.html#services"><span>제품소개</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
          <ul>
            <li><a href="service1-details.html">열연강판</a></li>
            <li><a href="service2-details.html">냉연강판</a></li>
            <li><a href="service3-details.html">특수강</a></li>
            <li><a href="service4-details.html">맞춤 가공</a></li>
          </ul>
        </li>
        <li class="dropdown"><a href="#"><span>사업영역</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
          <ul>
            <li><a href="steel-manufacturing.html">철강제조</a></li>
            <li><a href="processing-service.html">가공서비스</a></li>
            <li><a href="tech-research.html">기술연구</a></li>
          </ul>
        </li>
        <li class="dropdown"><a href="#"><span>고객센터</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
          <ul>
            <li><a href="quote-inquiry.html">견적문의</a></li>
            <li><a href="catalog.html">카탈로그</a></li>
            <li><a href="faq.html">FAQ</a></li>
            <li><a href="product-inquiry.html">제품문의</a></li>
            <li><a href="technical-support.html">기술지원</a></li>
          </ul>
        </li>
      </ul>
      <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
    </nav>

    <!-- 로그인 버튼 -->
    <a class="login-btn" href="#" onclick="showLoginModal(); return false;" id="mainLoginBtn">
      <i class="bi bi-person-circle"></i> <span id="loginBtnText">로그인</span>
    </a>
    
    <!-- 로그인 후 프로필 아이콘 -->
    <div class="user-profile" id="userProfile" style="display: none;">
      <div class="profile-icon" onclick="handleProfileClick()">
        <img id="profileImage" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSIyMCIgeT0iMjQiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfkYQ8L3N2Zz4KPC9zdmc+" alt="프로필" />
        <span class="profile-name" id="profileName">사용자</span>
      </div>
    </div>

  </div>
</header>

<!-- 공통 로그인/로그아웃 상태 관리 스크립트 -->
<script>
// 공통 네비바 로그인 상태 관리
(function() {
    // DOM이 완전히 로드된 후 로그인 상태 확인
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkAndUpdateNavbarLoginState, 100);
        });
    } else {
        // 이미 로드된 경우 즉시 실행
        setTimeout(checkAndUpdateNavbarLoginState, 100);
    }
    
    // 추가로 더 긴 지연으로 한 번 더 확인 (다른 스크립트들이 sessionStorage를 업데이트할 시간 제공)
    setTimeout(checkAndUpdateNavbarLoginState, 500);
    setTimeout(checkAndUpdateNavbarLoginState, 1000);
    
    // 로그인 상태 확인 및 네비바 업데이트
    function checkAndUpdateNavbarLoginState() {
        console.log('🔍 네비바: 로그인 상태 확인 시작');
        
        const currentUser = getCurrentUserFromSessionStorage();
        console.log('🔍 네비바: sessionStorage에서 가져온 사용자:', currentUser);
        
        // 네비바 요소들이 존재하는지 확인
        const loginBtn = document.getElementById('mainLoginBtn');
        const userProfile = document.getElementById('userProfile');
        console.log('🔍 네비바: 요소 확인', {
            loginBtn: !!loginBtn,
            userProfile: !!userProfile,
            loginBtnDisplay: loginBtn ? loginBtn.style.display : 'not found',
            userProfileDisplay: userProfile ? userProfile.style.display : 'not found'
        });
        
        if (currentUser && currentUser.name) {
            console.log('✅ 네비바: 로그인된 사용자 확인됨:', currentUser.name);
            updateNavbarForLoggedInUser(currentUser);
        } else {
            console.log('ℹ️ 네비바: 로그인되지 않은 상태');
            updateNavbarForLoggedOutUser();
        }
    }
    
    // sessionStorage에서 사용자 정보 가져오기
    function getCurrentUserFromSessionStorage() {
        try {
            const userJson = sessionStorage.getItem('currentUser');
            if (!userJson) return null;
            
            const user = JSON.parse(userJson);
            return user;
        } catch (error) {
            console.error('❌ 네비바: 사용자 정보 파싱 오류:', error);
            return null;
        }
    }
    
    // 로그인된 사용자용 네비바 업데이트
    function updateNavbarForLoggedInUser(user) {
        console.log('🔄 네비바: 로그인 상태로 업데이트 시작', user);
        
        const loginBtn = document.getElementById('mainLoginBtn');
        const userProfile = document.getElementById('userProfile');
        const profileImage = document.getElementById('profileImage');
        const profileName = document.getElementById('profileName');
        
        console.log('🔄 네비바: 요소 찾기 결과', {
            loginBtn: !!loginBtn,
            userProfile: !!userProfile,
            profileImage: !!profileImage,
            profileName: !!profileName
        });
        
        if (loginBtn && userProfile) {
            // 로그인 버튼 숨기고 프로필 표시
            loginBtn.style.display = 'none';
            userProfile.style.display = 'flex';
            
            console.log('✅ 네비바: 버튼 표시 상태 변경 완료', {
                loginBtnDisplay: loginBtn.style.display,
                userProfileDisplay: userProfile.style.display
            });
            
            // 프로필 이미지 설정
            if (profileImage) {
                if (user.profileImage || user.profile_image) {
                    profileImage.src = user.profileImage || user.profile_image;
                } else {
                    // 기본 아바타 생성
                    profileImage.src = generateNavbarDefaultAvatar(user.name || user.email || 'User');
                }
                console.log('🖼️ 네비바: 프로필 이미지 설정 완료');
            }
            
            // 사용자 이름 설정
            if (profileName) {
                profileName.textContent = user.name || user.email || '사용자';
                console.log('👤 네비바: 사용자 이름 설정 완료:', profileName.textContent);
            }
        } else {
            console.error('❌ 네비바: 필수 요소를 찾을 수 없음');
        }
    }
    
    // 로그아웃 상태용 네비바 업데이트
    function updateNavbarForLoggedOutUser() {
        console.log('🔄 네비바: 로그아웃 상태로 업데이트 시작');
        
        const loginBtn = document.getElementById('mainLoginBtn');
        const userProfile = document.getElementById('userProfile');
        
        if (loginBtn && userProfile) {
            // 프로필 숨기고 로그인 버튼 표시
            loginBtn.style.display = 'flex';
            userProfile.style.display = 'none';
            
            console.log('✅ 네비바: 로그아웃 상태 업데이트 완료', {
                loginBtnDisplay: loginBtn.style.display,
                userProfileDisplay: userProfile.style.display
            });
        } else {
            console.error('❌ 네비바: 로그아웃 업데이트 - 필수 요소를 찾을 수 없음');
        }
    }
    
    // 네비바용 기본 아바타 생성
    function generateNavbarDefaultAvatar(name) {
        const initial = name ? name.charAt(0).toUpperCase() : 'U';
        const safeInitial = /^[A-Za-z가-힣]/.test(initial) ? initial : 'U';
        
        const svgContent = `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
            <circle cx="20" cy="20" r="20" fill="#667eea"/>
            <text x="20" y="26" font-family="Arial, sans-serif" font-size="16" fill="white" text-anchor="middle" dominant-baseline="central">${safeInitial}</text>
        </svg>`;
        
        return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgContent)}`;
    }
    
    // 전역 함수로 네비바 상태 업데이트 함수 노출
    window.updateNavbarLoginState = checkAndUpdateNavbarLoginState;
    
    // 즉시 실행 (네비바 HTML이 로드되는 순간)
    console.log('🔧 navbar.html: 스크립트 실행됨');
    checkAndUpdateNavbarLoginState();
    
    // sessionStorage 변경 감지 (다른 탭에서의 로그인/로그아웃 반영)
    window.addEventListener('storage', function(e) {
        if (e.key === 'currentUser') {
            checkAndUpdateNavbarLoginState();
        }
    });
    
})();

// 네비바 로그인 모달 표시 함수 (각 페이지에서 정의된 함수 호출)
function showLoginModal() {
    if (window.showLoginModal && typeof window.showLoginModal === 'function') {
        window.showLoginModal();
    } else {
        // 기본 로그인 페이지로 이동
        window.location.href = 'login.html';
    }
}

// 네비바 프로필 클릭 함수 (각 페이지에서 정의된 함수 호출)
function handleProfileClick() {
    if (window.handleProfileClick && typeof window.handleProfileClick === 'function') {
        window.handleProfileClick();
    } else if (window.showProfileModal && typeof window.showProfileModal === 'function') {
        window.showProfileModal();
    } else {
        // 기본 대시보드로 이동
        window.location.href = 'employee-dashboard.html';
    }
}
</script>