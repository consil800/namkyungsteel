<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¶Œí•œ ê´€ë¦¬ - SteelWorks Platform</title>
    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
    
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Database Manager -->
    <script src="database.js"></script>
    <!-- Auth Manager -->
    <script src="shared-assets/js/auth.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header h1 {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .permission-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .permission-item {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .permission-header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .permission-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .permission-tab {
            flex: 1;
            background: none;
            border: none;
            padding: 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .permission-tab:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .permission-tab.active {
            background: white;
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .permission-content {
            background: white;
            padding: 1.5rem;
        }

        .permission-panel {
            display: none;
        }

        .permission-panel.active {
            display: block;
        }

        .permission-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .permission-checkbox:hover {
            background: #f8fafc;
        }

        .permission-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4f46e5;
        }

        .permission-checkbox label {
            cursor: pointer;
            font-size: 0.9rem;
            color: #374151;
        }

        .save-button {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 2rem;
            width: 100%;
        }

        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .permission-card {
                padding: 1.5rem;
            }
            
            .header-content {
                padding: 0 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>ğŸ” ê¶Œí•œ ê´€ë¦¬</h1>
            <button class="back-button" onclick="window.location.href='admin-dashboard.html'">
                <i class="fas fa-arrow-left"></i> ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </header>

    <div class="container">
        <div class="permission-card">
            <h2 class="section-title">
                <i class="fas fa-shield-alt"></i>
                ë©”ë‰´ ì ‘ê·¼ ê¶Œí•œ ê´€ë¦¬
            </h2>

            <!-- ì—…ë¬´ì¼ì§€ ê¶Œí•œ -->
            <div class="permission-item">
                <div class="permission-header">
                    <i class="fas fa-file-alt"></i>
                    ì—…ë¬´ì¼ì§€
                </div>
                <div class="permission-tabs">
                    <button class="permission-tab active" onclick="switchPermissionTab('worklog', 'department')">ë¶€ì„œë³„</button>
                    <button class="permission-tab" onclick="switchPermissionTab('worklog', 'position')">ì§ê¸‰ë³„</button>
                    <button class="permission-tab" onclick="switchPermissionTab('worklog', 'individual')">ê°œì¸ë³„</button>
                </div>
                <div class="permission-content">
                    <div class="permission-panel active" id="worklog-department">
                        <div class="loading">ë¶€ì„œë³„ ê¶Œí•œ ì„¤ì • ë¡œë”© ì¤‘...</div>
                    </div>
                    <div class="permission-panel" id="worklog-position">
                        <div class="loading">ì§ê¸‰ë³„ ê¶Œí•œ ì„¤ì • ë¡œë”© ì¤‘...</div>
                    </div>
                    <div class="permission-panel" id="worklog-individual">
                        <div class="loading">ê°œì¸ë³„ ê¶Œí•œ ì„¤ì • ë¡œë”© ì¤‘...</div>
                    </div>
                </div>
            </div>

            <!-- ë²•ì¸ì¹´ë“œ ì‚¬ìš© ê¶Œí•œ -->
            <div class="permission-item">
                <div class="permission-header">
                    <i class="fas fa-credit-card"></i>
                    ë²•ì¸ì¹´ë“œ ì‚¬ìš©
                </div>
                <div class="permission-tabs">
                    <button class="permission-tab active" onclick="switchPermissionTab('corporate-card', 'department')">ë¶€ì„œë³„</button>
                    <button class="permission-tab" onclick="switchPermissionTab('corporate-card', 'position')">ì§ê¸‰ë³„</button>
                    <button class="permission-tab" onclick="switchPermissionTab('corporate-card', 'individual')">ê°œì¸ë³„</button>
                </div>
                <div class="permission-content">
                    <div class="permission-panel active" id="corporate-card-department">
                        <div class="loading">ë¶€ì„œë³„ ê¶Œí•œ ì„¤ì • ë¡œë”© ì¤‘...</div>
                    </div>
                    <div class="permission-panel" id="corporate-card-position">
                        <div class="loading">ì§ê¸‰ë³„ ê¶Œí•œ ì„¤ì • ë¡œë”© ì¤‘...</div>
                    </div>
                    <div class="permission-panel" id="corporate-card-individual">
                        <div class="loading">ê°œì¸ë³„ ê¶Œí•œ ì„¤ì • ë¡œë”© ì¤‘...</div>
                    </div>
                </div>
            </div>

            <!-- ê²°ì œ ì„œë¥˜ ê¶Œí•œ -->
            <div class="permission-item">
                <div class="permission-header">
                    <i class="fas fa-file-invoice"></i>
                    ê²°ì œ ì„œë¥˜
                </div>
                <div class="permission-tabs">
                    <button class="permission-tab active" onclick="switchPermissionTab('documents', 'department')">ë¶€ì„œë³„</button>
                    <button class="permission-tab" onclick="switchPermissionTab('documents', 'position')">ì§ê¸‰ë³„</button>
                    <button class="permission-tab" onclick="switchPermissionTab('documents', 'individual')">ê°œì¸ë³„</button>
                </div>
                <div class="permission-content">
                    <div class="permission-panel active" id="documents-department">
                        <div class="loading">ë¶€ì„œë³„ ê¶Œí•œ ì„¤ì • ë¡œë”© ì¤‘...</div>
                    </div>
                    <div class="permission-panel" id="documents-position">
                        <div class="loading">ì§ê¸‰ë³„ ê¶Œí•œ ì„¤ì • ë¡œë”© ì¤‘...</div>
                    </div>
                    <div class="permission-panel" id="documents-individual">
                        <div class="loading">ê°œì¸ë³„ ê¶Œí•œ ì„¤ì • ë¡œë”© ì¤‘...</div>
                    </div>
                </div>
            </div>

            <button class="save-button" onclick="savePermissions()">
                <i class="fas fa-save"></i> ê¶Œí•œ ì €ì¥
            </button>
        </div>
    </div>

    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        // ê¶Œí•œ ê´€ë¦¬ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ê¶Œí•œ ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œë¨');
            
            // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ í™•ì¸
            let currentUser = null;
            
            try {
                // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
                if (window.db && window.db.client) {
                    await window.db.init();
                    
                    // sessionStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const sessionUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                    console.log('ğŸ” sessionStorage ì‚¬ìš©ì:', sessionUser);
                    
                    if (sessionUser && sessionUser.email) {
                        // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
                        const { data: dbUser, error } = await window.db.client
                            .from('users')
                            .select('*')
                            .eq('email', sessionUser.email)
                            .single();
                        
                        if (!error && dbUser) {
                            currentUser = dbUser;
                            console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ:', currentUser);
                        } else {
                            console.error('âŒ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ì¡°íšŒ ì˜¤ë¥˜:', error);
                            currentUser = sessionUser;
                        }
                    } else {
                        currentUser = AuthManager.getCurrentUser();
                    }
                } else {
                    currentUser = AuthManager.getCurrentUser();
                }
            } catch (error) {
                console.error('âŒ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                currentUser = AuthManager.getCurrentUser();
            }
            
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'login.html';
                return;
            }

            console.log('ğŸ” ê¶Œí•œ í™•ì¸ - í˜„ì¬ ì‚¬ìš©ì:', currentUser);
            console.log('ğŸ” ì‚¬ìš©ì ì—­í• :', currentUser.role);

            // ê¶Œí•œ í™•ì¸ (ë§ˆìŠ¤í„°, íšŒì‚¬ ëŒ€í‘œ, íšŒì‚¬ ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥)
            const allowedRoles = ['master', 'company_CEO', 'company_admin'];
            if (!allowedRoles.includes(currentUser.role)) {
                console.log('âŒ ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ:', {
                    userRole: currentUser.role,
                    allowedRoles: allowedRoles
                });
                alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                window.location.href = 'admin-dashboard.html';
                return;
            }
            
            console.log('âœ… ì ‘ê·¼ ê¶Œí•œ í™•ì¸ë¨:', currentUser.role);

            // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
            if (window.db && window.db.client) {
                console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸ë¨');
                await loadPermissions();
            } else {
                console.error('âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨');
                alert('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ê¶Œí•œ íƒ­ ì „í™˜
        function switchPermissionTab(menu, type) {
            console.log(`ê¶Œí•œ íƒ­ ì „í™˜: ${menu} - ${type}`);
            
            // í•´ë‹¹ ë©”ë‰´ì˜ ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            const menuTabs = document.querySelectorAll(`#${menu}-department`).parentNode.parentNode.querySelectorAll('.permission-tab');
            menuTabs.forEach(tab => tab.classList.remove('active'));
            
            // í•´ë‹¹ ë©”ë‰´ì˜ ëª¨ë“  íŒ¨ë„ ìˆ¨ê¸°ê¸°
            const menuPanels = document.querySelectorAll(`[id^="${menu}-"]`);
            menuPanels.forEach(panel => panel.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            
            // ì„ íƒëœ íŒ¨ë„ í‘œì‹œ
            const targetPanel = document.getElementById(`${menu}-${type}`);
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
        }

        // ê¶Œí•œ ì„¤ì • ë¡œë“œ
        async function loadPermissions() {
            try {
                console.log('ğŸ”„ ê¶Œí•œ ì„¤ì • ë¡œë“œ ì‹œì‘');
                
                // ê° ë©”ë‰´ë³„ë¡œ ê¶Œí•œ ë°ì´í„° ë¡œë“œ
                const menus = ['worklog', 'corporate-card', 'documents'];
                const types = ['department', 'position', 'individual'];
                
                for (const menu of menus) {
                    for (const type of types) {
                        const panelId = `${menu}-${type}`;
                        const panel = document.getElementById(panelId);
                        
                        if (panel) {
                            // ì„ì‹œ ë°ì´í„°ë¡œ ì±„ìš°ê¸° (ì‹¤ì œë¡œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¡œë“œ)
                            panel.innerHTML = await generatePermissionCheckboxes(menu, type);
                        }
                    }
                }
                
                console.log('âœ… ê¶Œí•œ ì„¤ì • ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ê¶Œí•œ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê¶Œí•œ ì²´í¬ë°•ìŠ¤ ìƒì„±
        async function generatePermissionCheckboxes(menu, type) {
            const menuNames = {
                'worklog': 'ì—…ë¬´ì¼ì§€',
                'corporate-card': 'ë²•ì¸ì¹´ë“œ ì‚¬ìš©',
                'documents': 'ê²°ì œ ì„œë¥˜'
            };
            
            const permissions = ['ì½ê¸°', 'ì“°ê¸°', 'ìˆ˜ì •', 'ì‚­ì œ', 'ê´€ë¦¬'];
            
            let html = `<h4>${menuNames[menu]} - ${type === 'department' ? 'ë¶€ì„œë³„' : type === 'position' ? 'ì§ê¸‰ë³„' : 'ê°œì¸ë³„'} ê¶Œí•œ</h4>`;
            
            for (const permission of permissions) {
                const checkboxId = `${menu}-${type}-${permission}`;
                html += `
                    <div class="permission-checkbox">
                        <input type="checkbox" id="${checkboxId}" name="${checkboxId}">
                        <label for="${checkboxId}">${permission} ê¶Œí•œ</label>
                    </div>
                `;
            }
            
            return html;
        }

        // ê¶Œí•œ ì €ì¥
        async function savePermissions() {
            try {
                console.log('ğŸ”„ ê¶Œí•œ ì €ì¥ ì‹œì‘');
                
                // ëª¨ë“  ì²´í¬ë°•ìŠ¤ ìƒíƒœ ìˆ˜ì§‘
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                const permissions = {};
                
                checkboxes.forEach(checkbox => {
                    permissions[checkbox.id] = checkbox.checked;
                });
                
                console.log('ğŸ“ ì €ì¥í•  ê¶Œí•œ ë°ì´í„°:', permissions);
                
                // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ (ì‹¤ì œ êµ¬í˜„ í•„ìš”)
                if (window.db && window.db.client) {
                    // TODO: ì‹¤ì œ ê¶Œí•œ ì €ì¥ ë¡œì§ êµ¬í˜„
                    console.log('âœ… ê¶Œí•œ ì €ì¥ ì„±ê³µ (ì„ì‹œ)');
                    alert('ê¶Œí•œì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    throw new Error('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('âŒ ê¶Œí•œ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ê¶Œí•œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
    </script>
</body>
</html>