<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>업체 방문 스케줄 자동 생성</title>

  <!-- Supabase JS (브라우저 CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111;
      --muted:#666;
      --line:#e6e8ec;
      --shadow:0 2px 10px rgba(0,0,0,.06);
      --radius:14px;

      --green:#2e7d32;
      --gray:#6b7280;
      --blue:#2563eb;
      --red:#dc2626;
      --yellow:#ca8a04;
      --orange:#ea580c;
      --sky:#0284c7;
      --purple:#7c3aed;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ===== 상단 바 ===== */
    .topbar{
      position:sticky; top:0; z-index:20;
      background:rgba(246,247,251,.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1400px; margin:0 auto;
      display:flex; align-items:center; gap:12px;
      padding:12px 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
    }
    .back-btn{
      background:none;
      border:none;
      font-size:20px;
      cursor:pointer;
      padding:4px 8px;
      border-radius:8px;
    }
    .back-btn:hover{ background:#eee; }
    .pill{
      font-size:12px; color:#0b3; background:#eafff0;
      border:1px solid #b9f6cf;
      padding:4px 10px; border-radius:999px;
    }
    .spacer{ flex:1; }
    .btn{
      border:1px solid var(--line);
      background:#fff; color:#111;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .btn:hover{ border-color:#cfd6e4; }
    .btn.primary{
      background:#111; color:#fff; border-color:#111;
    }
    .btn.danger{
      background:#fff; color:#b00020; border-color:#ffd2d8;
    }

    /* ===== 3패널 레이아웃 =====
       - 좌측: 조건/필터/생성
       - 중앙: 스케줄(기간 리스트)
       - 우측: 상세/미배정/휴무 드롭존
    */
    .app{
      max-width:1400px;
      margin:14px auto 30px;
      padding:0 14px;
      display:grid;
      grid-template-columns: 360px 1fr 360px;
      gap:14px;
      align-items:start;
    }

    @media (max-width: 1200px){
      .app{ grid-template-columns: 360px 1fr; }
      .right{ grid-column: 1 / -1; }
    }
    @media (max-width: 820px){
      .app{ grid-template-columns: 1fr; }
      .left,.center,.right{ grid-column: 1 / -1; }
      .topbar-inner{ flex-wrap:wrap; }
    }

    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:#fff;
    }
    .panel .hd .title{
      font-weight:800;
    }
    .panel .bd{
      padding:12px 14px;
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input[type="date"], input[type="text"], select{
      width:100%; padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      outline:none;
      background:#fff;
    }

    .section{ margin-top:12px; }
    .section:first-child{ margin-top:0; }

    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }
    .kpi{
      display:grid; grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .kpi .box{
      border:1px solid var(--line); border-radius:12px;
      padding:10px;
      background:#fafbff;
    }
    .kpi .box .k{ font-size:12px; color:var(--muted); }
    .kpi .box .v{ font-size:16px; font-weight:900; margin-top:2px; }

    /* ===== 필터 UI ===== */
    .chiprow{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      display:flex; align-items:center; gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .chip[data-on="1"]{
      border-color:#111;
      box-shadow:0 0 0 2px rgba(0,0,0,.05);
    }
    .dot{ width:10px; height:10px; border-radius:999px; }
    .dot.green{ background:var(--green); }
    .dot.gray{ background:var(--gray); }
    .dot.blue{ background:var(--blue); }
    .dot.red{ background:var(--red); }
    .dot.yellow{ background:var(--yellow); }
    .dot.orange{ background:var(--orange); }
    .dot.sky{ background:var(--sky); }
    .dot.purple{ background:var(--purple); }

    .listbox{
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px;
      background:#fff;
      max-height:220px;
      overflow:auto;
    }
    .row{
      display:flex; align-items:center; gap:8px;
      padding:6px 4px;
      border-bottom:1px dashed #eee;
    }
    .row:last-child{ border-bottom:none; }
    .row input{ margin:0; }
    .row .meta{ margin-left:auto; font-size:12px; color:var(--muted); }

    .selbar{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:8px;
    }
    .mini{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }

    /* ===== 중앙 스케줄(기간 리스트) ===== */
    .center .bd{ padding:0; }
    .calendar{
      padding:12px 14px;
      display:flex; flex-direction:column; gap:10px;
      max-height: calc(100vh - 120px);
      overflow:auto;
    }
    .day-card{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .day-hd{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid #f0f2f6;
      background:#fbfcff;
    }
    .day-hd .leftline{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
    }
    .badge{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      font-weight:800;
    }
    .badge.holiday{ border-color:#ffd2d8; background:#fff5f6; color:#b00020; }
    .badge.weekend{ border-color:#dbeafe; background:#eff6ff; color:#1d4ed8; }
    .badge.off{ border-color:#d1fae5; background:#ecfdf5; color:#065f46; }
    .badge.disabled{ border-color:#eee; background:#f7f7f7; color:#999; }
    .badge.location{ border-color:#fef3c7; background:#fffbeb; color:#92400e; }

    .day-meta{ font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; }
    .day-actions{ display:flex; gap:8px; }
    .btn-sm{
      padding:6px 10px; border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }

    /* day list (드래그 대상) */
    .day-list{
      list-style:none;
      margin:0;
      padding:10px 10px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      min-height:46px;
    }
    .day-list.disabled{
      background:#fafafa;
      opacity:.65;
      pointer-events:none;
    }

    /* 업체 칩(드래그 아이템) */
    .company-item{
      border:1px solid var(--line);
      background:#fff;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      display:flex; align-items:center; gap:8px;
      cursor:grab;
      user-select:none;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .company-item:active{ cursor:grabbing; }
    .company-item .sub{ font-size:11px; color:var(--muted); font-weight:700; }
    .company-item .x{ margin-left:4px; color:#999; font-weight:900; cursor:pointer; }

    .slotline{
      padding:0 12px 10px;
      font-size:12px;
      color:var(--muted);
      display:flex; justify-content:space-between;
    }

    /* ===== 우측 패널: 미배정 / 휴무 드롭존 ===== */
    .dropzone{
      border:2px dashed #cfd6e4;
      border-radius:14px;
      padding:12px;
      background:#fbfcff;
    }
    .dropzone .dz-title{
      font-weight:900;
      margin-bottom:6px;
    }
    .dropzone .dz-desc{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .drop-list{
      list-style:none;
      margin:10px 0 0;
      padding:10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      min-height:46px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
      z-index:50;
    }
    .toast.on{ opacity:1; }

    .warn{
      border:1px solid #ffe6a7;
      background:#fff7db;
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      color:#6b4e00;
      line-height:1.35;
    }

    .info{
      border:1px solid #bfdbfe;
      background:#eff6ff;
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      color:#1e40af;
      line-height:1.35;
    }

    .muted{ color:var(--muted); }
    .small{ font-size:12px; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <button class="back-btn" onclick="location.href='employee-dashboard.html'">&larr;</button>
      <div class="brand">남경스틸 · 업체 방문 스케줄 생성</div>
      <div id="saveStatePill" class="pill" style="display:none;">저장 필요</div>
      <div class="spacer"></div>
      <button id="btnPreview" class="btn">미리보기 생성</button>
      <button id="btnSave" class="btn primary">저장</button>
      <button id="btnReset" class="btn danger">초기화</button>
    </div>
  </div>

  <div class="app">
    <!-- ===== 좌측 패널: 조건/필터 ===== -->
    <section class="panel left">
      <div class="hd">
        <div class="title">조건/필터</div>
        <div class="muted small" id="loadState">로딩...</div>
      </div>
      <div class="bd">
        <div class="section">
          <div class="grid2">
            <div>
              <label>시작일</label>
              <input type="date" id="startDate" />
            </div>
            <div>
              <label>종료일</label>
              <input type="date" id="endDate" />
            </div>
          </div>
          <div style="margin-top:10px;" class="kpi">
            <div class="box">
              <div class="k">근무일(주말/공휴일 제외)</div>
              <div class="v" id="workdayCount">-</div>
            </div>
            <div class="box">
              <div class="k">선택 업체 수</div>
              <div class="v" id="selectedCount">0</div>
            </div>
          </div>
          <div style="margin-top:10px;" class="hint" id="rangeHint">
            기간을 선택하면 자동으로 주말/공휴일을 제외하여 근무일을 계산합니다.
          </div>
        </div>

        <div class="section">
          <label>하루 방문 업체 수 옵션</label>
          <div class="listbox" style="max-height:none;">
            <div class="row">
              <input type="radio" name="cap" value="1-3" checked />
              <div><b>1~3개</b> <span class="muted small">(목표 2)</span></div>
            </div>
            <div class="row">
              <input type="radio" name="cap" value="4-5" />
              <div><b>4~5개</b> <span class="muted small">(목표 5)</span></div>
            </div>
            <div class="row">
              <input type="radio" name="cap" value="6-8" />
              <div><b>6~8개</b> <span class="muted small">(목표 7)</span></div>
            </div>
            <div class="row">
              <input type="radio" name="cap" value="9-11" />
              <div><b>9~11개</b> <span class="muted small">(목표 10)</span></div>
            </div>
          </div>
          <div class="hint" style="margin-top:8px;">
            자동 배정은 "<b>주소 근접 그룹</b>"을 우선으로 근무일에 순차 배정합니다.
          </div>
        </div>

        <div class="section">
          <label>색상 필터 (멀티)</label>
          <div class="chiprow" id="colorChips"></div>
        </div>

        <div class="section">
          <label>지역 필터 (멀티)</label>
          <div class="listbox" id="regionList"></div>
          <div class="selbar">
            <button class="mini" id="btnRegionAll">전체 선택</button>
            <button class="mini" id="btnRegionNone">전체 해제</button>
          </div>
        </div>

        <div class="section">
          <label>업체 검색/선택</label>
          <input type="text" id="companySearch" placeholder="업체명 검색 (예: 남경, 철강, OO상사)" />
          <div class="selbar">
            <button class="mini" id="btnSelectAllFiltered">필터 결과 전체 선택</button>
            <button class="mini" id="btnClearSelected">선택 업체 비우기</button>
          </div>
          <div class="hint" style="margin-top:8px;">
            "선택 업체 수"가 0이면, 미리보기 생성 시 "현재 필터 결과 전체"를 사용합니다.
          </div>
        </div>

        <div class="section">
          <div class="info" id="locationGroupInfo">
            <b>주소 기반 그룹핑</b><br/>
            같은 동/면/읍의 업체들은 같은 날 방문하도록 자동 배정됩니다.
          </div>
        </div>

        <div class="section">
          <div class="warn" id="estimateBox">
            기간/필터를 설정하면 "필요 일수 추정"이 표시됩니다.
          </div>
        </div>
      </div>
    </section>

    <!-- ===== 중앙 패널: 스케줄(기간 리스트) ===== -->
    <section class="panel center">
      <div class="hd">
        <div class="title">스케줄 (기간 리스트)</div>
        <div class="muted small" id="calendarMeta">-</div>
      </div>
      <div class="bd">
        <div class="calendar" id="calendar">
          <div class="hint">좌측에서 조건 설정 → "미리보기 생성"을 누르세요.</div>
        </div>
      </div>
    </section>

    <!-- ===== 우측 패널: 휴무 드롭존 / 미배정 풀 ===== -->
    <section class="panel right">
      <div class="hd">
        <div class="title">편집 도구</div>
        <div class="muted small" id="editMeta">드래그로 조정</div>
      </div>
      <div class="bd">
        <div class="dropzone">
          <div class="dz-title">휴무 지정 드롭존</div>
          <div class="dz-desc">
            날짜 카드에서 업체 하나를 여기로 드롭하면<br/>
            <b>그 날짜를 "휴무"로 지정</b>하고, 해당 날짜의 모든 업체를 미배정으로 이동합니다.
          </div>
          <ul class="drop-list" id="offDropList" aria-label="휴무 드롭존"></ul>
        </div>

        <div class="section"></div>

        <div class="dropzone" style="margin-top:12px;">
          <div class="dz-title">미배정 업체</div>
          <div class="dz-desc">기간 부족/휴무 지정/수동 이동으로 남은 업체들이 여기에 모입니다.</div>
          <ul class="drop-list" id="unassignedList" aria-label="미배정 리스트"></ul>
        </div>

        <div class="section" style="margin-top:12px;">
          <div class="hint">
            팁) 미배정 → 날짜로 드래그하면 배정됩니다. 날짜 내에서도 순서 변경 가능합니다.
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast">-</div>

  <!-- 인증 및 데이터베이스 로드 -->
  <script src="shared-assets/js/auth.js?v=20260103b"></script>
  <script src="database.js?v=20260103b"></script>
  <script type="module" src="schedule-generator.js?v=20260103b"></script>
</body>
</html>
